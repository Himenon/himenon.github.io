<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Flaskのストリーミングを利用してみる | 技術の定点観測</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">
    <link rel="stylesheet" href="/pc.css">
    <link rel="stylesheet" href="/tablet.css">
    <link rel="stylesheet" href="/sp.css">
    <link rel="stylesheet" href="/prism.css">
</head>

<body>
    <header class="site-header">
        <h1><a href="">技術の定点観測</a></h1>
    </header>
    <div class="container">
        <div class="site-nav">
            <h2>サイト内トピック</h2>
            
    <ul>
    
        <li class="most-deep-item"><a href="../..">Hey!</a>
</li>
    
        <li class="most-deep-item"><a href="../../pick-up-article/">Pick Up Article</a>
</li>
    
        <li ><span><b><u>Django</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Django/Add new app/">DjangoにAppを新たに追加したときにやること</a>
</li>
      <li class="most-deep-item"><a href="../../Django/Introduction-of-Celery-Django/">Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する</a>
</li>
      <li class="most-deep-item"><a href="../../Django/Seperate-Django-Database/">Djangoで複数のデータベースを利用する</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Firebase</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Firebase/Auth-Error-Tips/">FirebaseのAuthで躓いたこと</a>
</li>
      <li class="most-deep-item"><a href="../../Firebase/Firebase-Cloud-Functions/">FirebaseにおけるCloud Functions</a>
</li>
      <li class="most-deep-item"><a href="../../Firebase/Firebase-Starter/">Firebaseことはじめ</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Flask</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="./">Flaskのストリーミングを利用してみる</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Frontend</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Frontend/settings/">Settings</a>
</li>
      <li ><span><b><u>Es6</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Frontend/es6/usage-axios/">Usage axios</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Vuejs</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Frontend/vuejs/my-vue-setup/">My vue setup</a>
</li>
      <li class="most-deep-item"><a href="../../Frontend/vuejs/nuxtjs/">Nuxtjs</a>
</li>
      <li class="most-deep-item"><a href="../../Frontend/vuejs/ssr-cache-investigation/">Ssr cache investigation</a>
</li>
      <li class="most-deep-item"><a href="../../Frontend/vuejs/vuex-usage/">Vuex usage</a>
</li>
  </ul>
</li>

  </ul>
</li>

    
        <li ><span><b><u>GCP</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../GCP/Cloud-Function/">Cloud Function</a>
</li>
      <li class="most-deep-item"><a href="../../GCP/GKE/">GKE</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Infrastructure</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Infrastructure/Multiple-Reverse-Proxy-Sapmle-with-oauth2_proxy/">Multiple Reverse Proxy Sapmle with oauth2 proxy</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Nodejs</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Nodejs/Request-library-description-for-json-value/">Request library description for json value</a>
</li>
      <li class="most-deep-item"><a href="../../Nodejs/dynamic-import/">Dynamic import</a>
</li>
      <li class="most-deep-item"><a href="../../Nodejs/execute-async-mjs/">Execute async mjs</a>
</li>
      <li class="most-deep-item"><a href="../../Nodejs/manage-npm-package/">Manage npm package</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Poem</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Poem/Container-App-Directory-Management-Consideration/">Container App Directory Management Consideration</a>
</li>
      <li class="most-deep-item"><a href="../../Poem/Container-Worker-Design/">Container Worker Design</a>
</li>
      <li class="most-deep-item"><a href="../../Poem/TDD/">TDD</a>
</li>
      <li class="most-deep-item"><a href="../../Poem/read-basic-knowledge-of-nosql/">Read basic knowledge of nosql</a>
</li>
      <li class="most-deep-item"><a href="../../Poem/static-site-generator/">Static site generator</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Profile</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Profile/github-activity/">Github activity</a>
</li>
      <li class="most-deep-item"><a href="../../Profile/">Home</a>
</li>
      <li class="most-deep-item"><a href="../../Profile/skill/">Skill</a>
</li>
      <li class="most-deep-item"><a href="../../Profile/study-history/">Study history</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Tools</u></b></span>
</li>
<li>
  <ul>
      <li ><span><b><u>Cookiecutter</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Tools/Cookiecutter/usage/">Usage</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Git</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Tools/Git/git-tips/">Git tips</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Github</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Tools/Github/Github-GraphQL/">Github GraphQL</a>
</li>
      <li class="most-deep-item"><a href="../../Tools/Github/Github-Multi-Login-User/">Github Multi Login User</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Slack</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Tools/Slack/slack-library/">Slack library</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Zapier</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../Tools/Zapier/zapier-development/">Zapier development</a>
</li>
  </ul>
</li>

  </ul>
</li>

    
        <li ><span><b><u>Analytics</u></b></span>
</li>
<li>
  <ul>
      <li ><span><b><u>Jupyter</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../analytics/jupyter/change-jupyter-config-dir/">Change jupyter config dir</a>
</li>
  </ul>
</li>

      <li ><span><b><u>Pandas</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../analytics/pandas/pandas-convert-column-to-datetime/">Pandas convert column to datetime</a>
</li>
      <li class="most-deep-item"><a href="../../analytics/pandas/visualize-time/">Visualize time</a>
</li>
  </ul>
</li>

  </ul>
</li>

    
        <li ><span><b><u>Event</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../event/2018-05-21-Cloud-Native/">2018 05 21 Cloud Native</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Kubernetes</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../kubernetes/Nginx access control for kubernetes/">Nginx access control for kubernetes</a>
</li>
      <li class="most-deep-item"><a href="../../kubernetes/Shortcut-for-kubectl/">Shortcut for kubectl</a>
</li>
      <li class="most-deep-item"><a href="../../kubernetes/cron-wake-up-down/">Cron wake up down</a>
</li>
      <li class="most-deep-item"><a href="../../kubernetes/error helm incompatible version/">Error helm incompatible version</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>mongoDB</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../mongoDB/basic-query/">Basic query</a>
</li>
      <li class="most-deep-item"><a href="../../mongoDB/basic-read-write/">Basic read write</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Presentation</u></b></span>
</li>
<li>
  <ul>
      <li ><span><b><u>2018</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../presentation/2018/03-02-Yoidore-GCPUG-LT/">03 02 Yoidore GCPUG LT</a>
</li>
  </ul>
</li>

  </ul>
</li>

    
        <li ><span><b><u>Python</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../python/test-know-how/">Test know how</a>
</li>
  </ul>
</li>

    
        <li ><span><b><u>Raspberrypi</u></b></span>
</li>
<li>
  <ul>
      <li class="most-deep-item"><a href="../../raspberrypi/os-install/">Os install</a>
</li>
      <li class="most-deep-item"><a href="../../raspberrypi/purchace/">Purchace</a>
</li>
  </ul>
</li>

    
    </ul>

        </div>
        <div class="content">
            <div class="content-header">
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw"
   class="twitter-share-button"
   data-text="Flaskのストリーミングを利用してみる"
   data-via="himenoglyph"
   data-related="himenoglyph"
   data-show-count="true">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            </div>
            <div class="content-body">
    <h1 id="flask">Flaskのストリーミングを利用してみる<a class="headerlink" href="#flask" title="Permanent link">&para;</a></h1>
<p>FlaskにStreaming Contentsというものが存在したので、
この実装方法を見てみる。</p>
<ul>
<li><a href="http://flask.pocoo.org/docs/0.12/patterns/streaming/">http://flask.pocoo.org/docs/0.12/patterns/streaming/</a></li>
</ul>
<h2 id="_1">基本<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>本記事中では<a href="https://gist.github.com/Himenon/9a4e7dd1a7e57a6da09b2b9624a737a0">サンプルコード</a>
の一部を使って解説しながら進めていくので、サンプルコードを適宜参照してほしい。</p>
<p>まずは、コードを書いてみる。適当なディレクトリ(ここでは<code>myapp</code>)に<code>server.py</code>を用意する。</p>
<pre><code class="python">@app.route('/hello-world')
def hello_world():
    def generate():
        for comment in get_comments():
            yield '&lt;li&gt;' + comment + '&lt;/li&gt;'
            time.sleep(0.5)  # 動作をわかりやすくするために追加
    return Response(generate())
</code></pre>

<p>実行すると次のようになった。</p>
<p><img alt="Google ChromeにおけるStreamingの実際の動画" src="../images/hello-world-streaming.gif" /></p>
<p>手元の環境で確認したところ、ChromeとFirefoxでは動画のような挙動になったが、
Safariはローディングが長くなっただけの、同期的な場合と同じ結果になった。
どうやら、ブラウザごとにローディングの仕組みが異なるようである。</p>
<h3 id="_2">何が起きた？<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>Responseの第一引数(もしくは<code>response=</code>)は、StringかIteratorを受け取る。
そこにGeneratorを渡すことによって、ストリーミングすることが可能となる。
これは<a href="https://knzm.readthedocs.io/en/latest/pep-0333-ja.html#buffering-and-streaming">PEP333(日本語訳)のBuffering and Streaming</a>に次のように決められている。</p>
<blockquote>
<p>しかしながら、大きいファイル、または HTTP ストリーミングの特殊な用途 (複合「サーバプッシュ」など) のために、アプリケーションは出力をより小さ なブロックに提供する必要があるかもしれない (例えばメモリに大きいファイ ルをロードすることを避けるため)。また、応答のある部分を生成するのに時間 がかかる場合も時々あるが、それに先行するレスポンスの部分を前もって送る ことは役に立つだろう。<Br>
これらの場合では、通常、アプリケーションはブロックごとの様式で出力を生 成するイテレータ (しばしばジェネレータ・イテレータ) を返すだろう。これ らのブロックは、 mulitpart 境界 (「サーバプッシュ」のための) や、時間の かかるタスク (ディスクに存在するファイルの別のブロックを読むなど) のす ぐ前で分割が起こるかもしれない。<br>
引用：<a href="https://knzm.readthedocs.io/en/latest/pep-0333-ja.html#buffering-and-streaming">PEP333(日本語訳)のBuffering and Streaming</a></p>
</blockquote>
<p>つまり、
巨大、もしくは大量のデータを送信する時、ストリーミングを利用すれば、サーバー側のメモリーの使用量が押さえられるから、
そのような場合に使うために用意されている。（ただし、トレードオフとして転送時間が同期的なレスポンスの場合よりも長くなる）。</p>
<p>ただし、この仕様はMUSTではないため、他のWSGIミドルウェアが対応していない場合もあるので、注意したほうがよさそう。</p>
<h2 id="_3">テンプレートを使う<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>Jinja2のテンプレートを使った場合のストリーミングの実装を見てみる。
まずはテンプレートの用意をする。
Flaskのテンプレートは次のようなディレクトリに配置しておけば良い。
全体のコードは<a href="https://gist.github.com/Himenon/9a4e7dd1a7e57a6da09b2b9624a737a0">サンプルコード</a>から適宜取得して欲しい。</p>
<pre><code>myapp/
├── server.py
└── templates
    └── comment_list.html  # 追加
</code></pre>

<p>まずは、<a href="http://flask.pocoo.org/docs/0.12/patterns/streaming/">http://flask.pocoo.org/docs/0.12/patterns/streaming/</a>に書いてあるコードを真似してみる。</p>
<pre><code class="python">def stream_template(template_name, **context):
    app.update_template_context(context)
    t = app.jinja_env.get_template(template_name)   # jinja2.Template
    rv = t.stream(context)                          # jinja2.environment.TemplateStream 
    rv.enable_buffering(5)
    return rv

@app.route('/hello-world-with-template')
def hello_world_with_template():
    return Response(stream_template('comment_list.html', comments=get_comments()))
</code></pre>

<p><code>/hello-world-with-template</code>にアクセスすれば、レンダリングされていることが分かる。
が、<code>time.sleep</code>を入れる場所がないのでもう少し深ぼってみる</p>
<h3 id="jinja2template">jinja2.Templateの挙動を確認する<a class="headerlink" href="#jinja2template" title="Permanent link">&para;</a></h3>
<p>テンプレートエンジンはJinja2を利用するため、読むべきAPIドキュメントはJinja2の方。</p>
<ul>
<li>http://jinja.pocoo.org/docs/2.10/api/#jinja2.Template</li>
</ul>
<p><code>jinja2.environment.TemplateStream</code>の挙動を検証する。
<code>templates</code>が存在する、<code>myapp/</code>の中でipythonを叩いてみる。</p>
<pre><code class="python">from flask import Flask
app = Flask('hello')

context = {
    'comments': [ 'Count: {}'.format(i) for i in range(100) ]
}
app.update_template_context(context)
t = app.jinja_env.get_template('comment_list.html')

rv = t.stream(context) # jinja2.environment.TemplateStream
rv.enable_buffering(5) # バッファサイズ

next(rv) # listの1〜5  まで
next(rv) # listの6〜11 まで
# ...
</code></pre>

<p><code>jinja2.environment.TemplateStream</code>は<code>enable_buffering</code>で指定された
大きさにチャンクされたイテレータ化されてくる（<code>__iter__</code>を持っている)。</p>
<p>これを逆手に取って、どの様にレンダリングされていくか、確認するため似、次のようにコードを書き換えてみる。</p>
<pre><code class="python">def stream_template(template_name, **context):
    app.update_template_context(context)
    t = app.jinja_env.get_template(template_name)
    rv = t.stream(context)
    rv.enable_buffering(5)
    for buffer in rv:
        yield buffer
        time.sleep(0.5)
</code></pre>

<p>これを実行すると、次のような結果になった。</p>
<p><img alt="テンプレートエンジンを使った場合の挙動" src="../images/hello-world-streaming-with-template.gif" /></p>
<p>やはりResponseにイテレータを渡していることがわかった。</p>
<h2 id="stream_with_context">stream_with_context<a class="headerlink" href="#stream_with_context" title="Permanent link">&para;</a></h2>
<p>Generatorの中でリクエストに含まれるパラメータを取得したい場合がある。
generator中では<code>flask.requrest</code>にアクセスできないため、それを可能にするために、
<code>stream_with_context</code>を利用する。これを利用することにより、
<code>flask.request</code>にアクセスすることができる。</p>
<pre><code class="python">@app.route('/stream')
def streamed_response():
    def generate():
        yield 'Hello '
        time.sleep(1)
        yield request.args['name'] # stream_with_contextでwrapされてるためアクセウ可
        time.sleep(1)
        yield '!'

    return Response(stream_with_context(generate()))
</code></pre>

<h2 id="_4">所感<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>PEP333に書いてあるとおり、データ容量の大きなデータを送信する場合に使えることがわかる。
数MB、もしくは数GB単位のデータをウェブサイトからダウンロードする時、サーバー側に負荷をかけないためにも
このパターンは使えそうである。</p>
<p><strong>参考</strong></p>
<p>本文中で出てきたリンクをまとめておく。</p>
<ul>
<li>サンプルコード: <a href="https://gist.github.com/Himenon/9a4e7dd1a7e57a6da09b2b9624a737a0">https://gist.github.com/Himenon/9a4e7dd1a7e57a6da09b2b9624a737a0</a></li>
<li>Flask Streaming Content: <a href="http://flask.pocoo.org/docs/0.12/patterns/streaming/">http://flask.pocoo.org/docs/0.12/patterns/streaming/</a></li>
<li>PEP333: <a href="https://knzm.readthedocs.io/en/latest/pep-0333-ja.html#buffering-and-streaming">https://knzm.readthedocs.io/en/latest/pep-0333-ja.html#buffering-and-streaming</a></li>
<li>Jinja2: <a href="http://jinja.pocoo.org/docs/2.10/api/#jinja2.Template">http://jinja.pocoo.org/docs/2.10/api/#jinja2.Template</a></li>
</ul>

            </div>
        </div>
        <div class="page-nav">
            <h2>ページ内目次</h2>
            <ul>
    
    <li><a href="#flask">Flaskのストリーミングを利用してみる</a></li>
    
    <li><a href="#_1">基本</a></li>
    
    <li><a href="#_3">テンプレートを使う</a></li>
    
    <li><a href="#stream_with_context">stream_with_context</a></li>
    
    <li><a href="#_4">所感</a></li>
    
    
</ul>
        </div>
    </div>
    <script src="/prism.js"></script>
    <script src="/mermaid.min.js"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-55455343-7', 'himenon.github.io');
ga('send', 'pageview');
</script>
</body>

</html>