<html>

  <head lang="ja">
    <title>Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する</title>
    <meta charSet="utf-8" />
    <meta name="keywords" content="nodejs,typescript,python,himenon,web,frontend" />
    <meta name="description" content="早くが画面から出たい人の備忘録。" />
    <meta name="copyright" content="@Himenon" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Himenon" />
    <meta property="og:title" content="Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する" />
    <meta property="og:url" content="https://himenon.github.io/python/django/introduction-of-celery-django" />
    <meta property="og:description" content="早くが画面から出たい人の備忘録。" />
    <meta property="og:image" content="https://himenon.github.io" />
    <meta name="viewport" content="initial-scale=1,minimum-scale=0.5,user-scalable=no" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600,800?9d6a4" rel="stylesheet" />
    <link href="/lib/prism.css?6435f" rel="stylesheet" />
    <link href="/assets/stylesheets/styles.css?8dead" rel="stylesheet" />
    <script>
      (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-55455343-7', 'auto');
      ga('send', 'pageview');
    </script>
    <script id="csr-props" data-csr-props="{&quot;htmlMetaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[],&quot;createdAt&quot;:&quot;2018-03-12T01:39:51.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/python/django/introduction-of-celery-django&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早くが画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io&quot;}]}},&quot;page&quot;:{&quot;uri&quot;:&quot;/python/django/introduction-of-celery-django&quot;,&quot;content&quot;:&quot;\n## はじめに\n\nDjango 2.0に対して、Celery 4を導入してみたので、その時の知見を書く。\n導入自体はそうそう難しくはなかったが、これで動く、といったサンプルコードがなかなか無かったので、\n書いておきます。。\n\n[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\n\n### 類似技術\n\n類似技術で有名なものとしては\n\n- cookpad/kuroko2: &lt;https://github.com/cookpad/kuroko2&gt;\n- RUNDECK: &lt;http://rundeck.org/&gt;\n\nがありますが、実はCeleryとDjagnoでも同じようなことができるので、Pythonやっている人は喜びましょう。\n\n手っ取り早いのは[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\nをさっさと起動することです。この記事は解説に文字を割いていますので。\n\n## 準備\n\n本サンプルコードは以下の環境で作成した。\n\n```\nDjango==2.0.3\ndjango-celery-results==1.0.1\ndjango-celery-beat==1.1.1\nredis==2.10.6\n```\n\n`requirements.txt`に上記を記述し、`pip install -r requirements.txt`でインストールしておく。\n\n## Djangoの作成\n\n1.プロジェクトの作成\n\n```\ndjango-admin startproject tm\n```\n\nすると次のようなツリーが作成される。\n\n```\n.\n├── manage.py\n└── tm\n    ├── __init__.py\n    ├── settings.py\n    ├── urls.py\n    └── wsgi.py\n```\n\n2.Extensionの追加\n\n`tm/settings.py`に次の記述を入れます。\n\n```python\nINSTALLED_APPS = [\n    &#x27;django.contrib.admin&#x27;,\n    &#x27;django.contrib.auth&#x27;,\n    &#x27;django.contrib.contenttypes&#x27;,\n    &#x27;django.contrib.sessions&#x27;,\n    &#x27;django.contrib.messages&#x27;,\n    &#x27;django.contrib.staticfiles&#x27;,\n    &#x27;django_celery_beat&#x27;,     # 追加\n    &#x27;django_celery_results&#x27;,  # 追加\n]\n```\n\n3.`celery.py`の追加\n\n`tm/`以下に`celery.py`を追加する。\nceleryの名前空間を汚染しているが、これであっている。\n\n```\n.\n├── manage.py\n└── tm\n    ├── __init__.py\n    ├── celery.py     # 追加\n    ├── settings.py\n    ├── urls.py\n    └── wsgi.py\n```\n\n`celery.py`は以下のように記述する。\n\n\n```python\nfrom os import environ\nfrom celery import Celery\napp = Celery(&#x27;tm&#x27;, broker=environ.get(&#x27;BROKER_URL&#x27;))\napp.config_from_object(&#x27;django.conf:settings&#x27;, namespace=&#x27;CELERY&#x27;)\napp.autodiscover_tasks()\n```\n\nこれは、後々登場する`@task`もしくは`@shared_task`デコレータを、worker起動時に、\n自動的に`INSTALLED_APPS`から探索する役割を果たす。\n\n`BROKER_URL`は、環境変数から指定できるようにしてある。これは状況に合わせて変化して欲しい。\n\n4.`__init__.py`にappを読み込むようにする。\n\n`tm/__init__.py`にCeleryを呼び出すコード記述しておく。\n\n\n```python\nfrom .celery import app as celery_app\n\n__all__ = [&#x27;celery_app&#x27;]\n```\n\n5.Migration\n\nCeleryのプラグインはDatabaseへのMigrationを必要とします。\n\n```\npython3 manage.py migrate\n```\n\n`django-celery-beat`はタスクの実行スケジュール管理のために、\n`django-celery-results`は実行五の結果を保存しておくためにDatabaseを利用します。\n\nまた、Adminユーザーを作成していない場合は、\n\n```\npython3 manage.py createsuperuser\n```\n\nでユーザーを作成しておきましょう。\nここまでうまくいくと、次の画像のように管理画面に、タスクのスケジュール管理の画面が出現します。\n定期実行タスクの管理がここからできるようになります。\n\n![Celeryを追加したときの管理画面](images/celery-django-admin.png)\n\n次に、タスクを追加してきます。\n\n## タスクの追加\n\n### アプリの追加\n\nタスクの追加の前に、アプリの追加をしておきましょう。\n`manage.py`のあるところで、次のコマンドを叩きます。\n\n\n```bash\npython3 manage.py startapp tapp_a\npython3 manage.py startapp tapp_b\n```\n\n今回はアプリ同士の相互呼び出しも検証するため、2つのアプリを追加しておきます。\n`INSTALLED_APPS`は次のように更新しておきます。\n\n```python\nINSTALLED_APPS = [\n    &#x27;django.contrib.admin&#x27;,\n    &#x27;django.contrib.auth&#x27;,\n    &#x27;django.contrib.contenttypes&#x27;,\n    &#x27;django.contrib.sessions&#x27;,\n    &#x27;django.contrib.messages&#x27;,\n    &#x27;django.contrib.staticfiles&#x27;,\n    &#x27;django_celery_beat&#x27;,\n    &#x27;django_celery_results&#x27;,\n    &#x27;tapp_a&#x27;,    # 追加\n    &#x27;tapp_b&#x27;,    # 追加\n]\n```\n\n### タスクの追加\n\n`tapp_a`にシンプルなタスクを追加します。\n`tasks.py`というファイルを作成し、次のように記述します。\n\n```python\nfrom celery import shared_task\n\n@shared_task\ndef hello_from_a(*args, **kwargs):\n    print(\&quot;Hello! From A\&quot;)\n    print(\&quot;args = {}\&quot;.format(args))\n    print(\&quot;kwargs = {}\&quot;.format(kwargs))\n```\n\n`@shared_task`を指定すると、Django Adminで認識されます。\n画像ではPeriodic Tasksの管理画面中で、いくつかのタスクを追加した場合のものを表示しています。\n\n![タスクを追加した時](images/celery-django-admin-add-tasks.png)\n\nまた、登録したタスクに初期値を与えたい場合は`Arguments`を利用すると可能です。\n\n![引数に値を渡したい場合](images/celery-django-admin-args.png)\n\n### 実行タイミングの指定\n\n実行タイミングの指定は、Interval、Crontab、Solarの3つのうち1つのみが選択可能です。\nどうしても数種類の実行方法が必要な場合は、別タスクとして登録し直します。\n\n- Interval: 10秒ごとなど。一定間隔で行う\n- Crontab: 指定した日時で実行を行う\n- Solar: 指定した緯度経度に基づいた、日の出、日没などのタイミングで自動的に実行する\n\nこれはお好みで設定して下さい。\n\nここまで終われば、タスクの登録が完了です。\n\n## タスクの実行\n\n定期実行タスクに関しては、SchedulerとWorker、BrokerをDjangoとは別のプロセスで起動させる必要があります。\n[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)では、\ndocker-composeを用いて楽をしています。\n\nただ、ここはそれほど難しものではなく、起動コマンドが異なるだけとなります。\nBrokerに関しては今回はredisを採用しており、自動的に立ち上がるので、ここでの説明は省きます。\n\n### scheduler, workerの起動\n\nschedulerの起動コマンドは次の通りです。\n\n```bash\nDJANGO_SETTINGS_MODULE=tm.settings celery -A tm beat --scheduler django_celery_beat.schedulers:DatabaseScheduler --pidfile /celerybeat.pid\n```\n\nworkerの起動コマンドは次のとおりです。\n\n```\nbash -c \&quot;DJANGO_SETTINGS_MODULE=tm.settings celery -A tm worker\&quot;\n```\n\n#### 解説\n\n##### workerについて\n\nここで重要なポイントは`DJANGO_SETTINGS_MODULE=tm.settings`です。\n(これを忘れるとひどく沼にはまります。)\n\n`celery -A tm`は`tm/__init__.py`を見に行きます。ここに`celery_app`が存在しない場合はエラーとなります。\n次に、`celery.py`の`app.config_from_object`と`app.autodiscover_tasks`においては、\nDjangoの`settings.py`を探索しに行きます。\n\n```python\napp.config_from_object(&#x27;django.conf:settings&#x27;, namespace=&#x27;CELERY&#x27;)\n```\n\n通常、DEBUGサーバーなど立ち上げる時、`python3 manage.py runserver`などとしますが、\nコードを見ると\n\n```python\nos.environ.setdefault(\&quot;DJANGO_SETTINGS_MODULE\&quot;, \&quot;tm.settings\&quot;)\n```\n\nが走っています。つまり、起動時に環境変数を登録しているため、Djangoを利用するceleryも環境変数、もしくは変数を\n起動時に定義しておかなければなりません。\n\nタスクの認識に関しては、\n\n```python\napp.autodiscover_tasks()\n```\n\nが自動的に`settings.py`から`INSTALLED_APPS`を吸ってきて解決してくれるので、それぞれの`APP`で\nWorkerを明示的に起動する必要はありません。むしろ、それを行った場合、`APP`間でModelを参照するといったことができなくなります。\n\n##### schedulerについて\n\nSchedulerの役割は至ってシンプルです。\n\n1. Databaseに登録されているタスクの監視\n2. 指定の時刻になった時、Brokerに対してWorkerがタスクを実行するようにメッセージを送信\n\n1のおかげで、Django Adminでタスクを登録、編集、削除した時に自動的にスケジューリングされます。\n2はBrokerへ登録されたタスクを実行するようにメッセージを投げるだけです。\n実際に実行されるかどうかは保証されません。\n\nそのスケジュールを管理するためのデータベースとして、\n`--scheduler django_celery_beat.schedulers:DatabaseScheduler`を指定しておきます。\n未指定の場合は、コマンドの実行ディレクトリにSchedulerの管理用のファイルが作成されます。\n`django_celery_beat.schedulers:DatabaseScheduler`を指定してる場合は、\nDjando Adminでは見えませんが、Database上にスケジュールが記述され、仮にSchedulerが落ちたとしても、\nどのタスクがスケジューリングされているかは残ります。\n\n`--pidfile /celerybeat.pid`としているのは、開発上の都合といえばそのとおりです。\n起動場所に`pid`ファイルが生成されますが、Schedulerを再起動した場合に、\n`pid`ファイルが存在した場合、Schedulerの多重起動を防ぐためにSchedulerが起動しません。\n\nコンテナを利用している場合は、良くコンテナごと落とすため、これは不便なため、マウントされていなコンテナのディレクトリに`pid`ファイルを投げています。\n実際に運用するときは、Schedulerのコンテナのサイズを1のままにしておくのが普通かと思います。\n\nどうしてもSchedulerを冗長化するために複数のコンテナを利用する場合は、各コンテナに永続ボリュームをマウントして、`pid`ファイルが\n一意になるように設定しておくこともできますが....\n\n## おわりに\n\nここまでで、タスクのスケジューリング実行が可能となります。\n長くなってしまいそうなので、説明はここまでにしますが、[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\nではもうちょっとサンプルを追加しています。興味がある人はぜひご覧ください。\n\n\n**参考**\n\n- [Periodic Tasks | Celery 4.1.0 documentation](http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html)\n\n\n&quot;,&quot;metaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[],&quot;createdAt&quot;:&quot;2018-03-12T01:39:51.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/python/django/introduction-of-celery-django&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早くが画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io&quot;}]}},&quot;ext&quot;:&quot;.md&quot;,&quot;filename&quot;:&quot;src/python/django/introduction-of-celery-django.md&quot;,&quot;name&quot;:&quot;python/django/introduction-of-celery-django&quot;,&quot;raw&quot;:&quot;---\ntitle: \&quot;Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する\&quot;\ncreatedAt: 2018-03-12 01:39:51\nupdatedAt: 2019-05-21 11:22:01\n---\n\n## はじめに\n\nDjango 2.0に対して、Celery 4を導入してみたので、その時の知見を書く。\n導入自体はそうそう難しくはなかったが、これで動く、といったサンプルコードがなかなか無かったので、\n書いておきます。。\n\n[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\n\n### 類似技術\n\n類似技術で有名なものとしては\n\n- cookpad/kuroko2: &lt;https://github.com/cookpad/kuroko2&gt;\n- RUNDECK: &lt;http://rundeck.org/&gt;\n\nがありますが、実はCeleryとDjagnoでも同じようなことができるので、Pythonやっている人は喜びましょう。\n\n手っ取り早いのは[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\nをさっさと起動することです。この記事は解説に文字を割いていますので。\n\n## 準備\n\n本サンプルコードは以下の環境で作成した。\n\n```\nDjango==2.0.3\ndjango-celery-results==1.0.1\ndjango-celery-beat==1.1.1\nredis==2.10.6\n```\n\n`requirements.txt`に上記を記述し、`pip install -r requirements.txt`でインストールしておく。\n\n## Djangoの作成\n\n1.プロジェクトの作成\n\n```\ndjango-admin startproject tm\n```\n\nすると次のようなツリーが作成される。\n\n```\n.\n├── manage.py\n└── tm\n    ├── __init__.py\n    ├── settings.py\n    ├── urls.py\n    └── wsgi.py\n```\n\n2.Extensionの追加\n\n`tm/settings.py`に次の記述を入れます。\n\n```python\nINSTALLED_APPS = [\n    &#x27;django.contrib.admin&#x27;,\n    &#x27;django.contrib.auth&#x27;,\n    &#x27;django.contrib.contenttypes&#x27;,\n    &#x27;django.contrib.sessions&#x27;,\n    &#x27;django.contrib.messages&#x27;,\n    &#x27;django.contrib.staticfiles&#x27;,\n    &#x27;django_celery_beat&#x27;,     # 追加\n    &#x27;django_celery_results&#x27;,  # 追加\n]\n```\n\n3.`celery.py`の追加\n\n`tm/`以下に`celery.py`を追加する。\nceleryの名前空間を汚染しているが、これであっている。\n\n```\n.\n├── manage.py\n└── tm\n    ├── __init__.py\n    ├── celery.py     # 追加\n    ├── settings.py\n    ├── urls.py\n    └── wsgi.py\n```\n\n`celery.py`は以下のように記述する。\n\n\n```python\nfrom os import environ\nfrom celery import Celery\napp = Celery(&#x27;tm&#x27;, broker=environ.get(&#x27;BROKER_URL&#x27;))\napp.config_from_object(&#x27;django.conf:settings&#x27;, namespace=&#x27;CELERY&#x27;)\napp.autodiscover_tasks()\n```\n\nこれは、後々登場する`@task`もしくは`@shared_task`デコレータを、worker起動時に、\n自動的に`INSTALLED_APPS`から探索する役割を果たす。\n\n`BROKER_URL`は、環境変数から指定できるようにしてある。これは状況に合わせて変化して欲しい。\n\n4.`__init__.py`にappを読み込むようにする。\n\n`tm/__init__.py`にCeleryを呼び出すコード記述しておく。\n\n\n```python\nfrom .celery import app as celery_app\n\n__all__ = [&#x27;celery_app&#x27;]\n```\n\n5.Migration\n\nCeleryのプラグインはDatabaseへのMigrationを必要とします。\n\n```\npython3 manage.py migrate\n```\n\n`django-celery-beat`はタスクの実行スケジュール管理のために、\n`django-celery-results`は実行五の結果を保存しておくためにDatabaseを利用します。\n\nまた、Adminユーザーを作成していない場合は、\n\n```\npython3 manage.py createsuperuser\n```\n\nでユーザーを作成しておきましょう。\nここまでうまくいくと、次の画像のように管理画面に、タスクのスケジュール管理の画面が出現します。\n定期実行タスクの管理がここからできるようになります。\n\n![Celeryを追加したときの管理画面](images/celery-django-admin.png)\n\n次に、タスクを追加してきます。\n\n## タスクの追加\n\n### アプリの追加\n\nタスクの追加の前に、アプリの追加をしておきましょう。\n`manage.py`のあるところで、次のコマンドを叩きます。\n\n\n```bash\npython3 manage.py startapp tapp_a\npython3 manage.py startapp tapp_b\n```\n\n今回はアプリ同士の相互呼び出しも検証するため、2つのアプリを追加しておきます。\n`INSTALLED_APPS`は次のように更新しておきます。\n\n```python\nINSTALLED_APPS = [\n    &#x27;django.contrib.admin&#x27;,\n    &#x27;django.contrib.auth&#x27;,\n    &#x27;django.contrib.contenttypes&#x27;,\n    &#x27;django.contrib.sessions&#x27;,\n    &#x27;django.contrib.messages&#x27;,\n    &#x27;django.contrib.staticfiles&#x27;,\n    &#x27;django_celery_beat&#x27;,\n    &#x27;django_celery_results&#x27;,\n    &#x27;tapp_a&#x27;,    # 追加\n    &#x27;tapp_b&#x27;,    # 追加\n]\n```\n\n### タスクの追加\n\n`tapp_a`にシンプルなタスクを追加します。\n`tasks.py`というファイルを作成し、次のように記述します。\n\n```python\nfrom celery import shared_task\n\n@shared_task\ndef hello_from_a(*args, **kwargs):\n    print(\&quot;Hello! From A\&quot;)\n    print(\&quot;args = {}\&quot;.format(args))\n    print(\&quot;kwargs = {}\&quot;.format(kwargs))\n```\n\n`@shared_task`を指定すると、Django Adminで認識されます。\n画像ではPeriodic Tasksの管理画面中で、いくつかのタスクを追加した場合のものを表示しています。\n\n![タスクを追加した時](images/celery-django-admin-add-tasks.png)\n\nまた、登録したタスクに初期値を与えたい場合は`Arguments`を利用すると可能です。\n\n![引数に値を渡したい場合](images/celery-django-admin-args.png)\n\n### 実行タイミングの指定\n\n実行タイミングの指定は、Interval、Crontab、Solarの3つのうち1つのみが選択可能です。\nどうしても数種類の実行方法が必要な場合は、別タスクとして登録し直します。\n\n- Interval: 10秒ごとなど。一定間隔で行う\n- Crontab: 指定した日時で実行を行う\n- Solar: 指定した緯度経度に基づいた、日の出、日没などのタイミングで自動的に実行する\n\nこれはお好みで設定して下さい。\n\nここまで終われば、タスクの登録が完了です。\n\n## タスクの実行\n\n定期実行タスクに関しては、SchedulerとWorker、BrokerをDjangoとは別のプロセスで起動させる必要があります。\n[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)では、\ndocker-composeを用いて楽をしています。\n\nただ、ここはそれほど難しものではなく、起動コマンドが異なるだけとなります。\nBrokerに関しては今回はredisを採用しており、自動的に立ち上がるので、ここでの説明は省きます。\n\n### scheduler, workerの起動\n\nschedulerの起動コマンドは次の通りです。\n\n```bash\nDJANGO_SETTINGS_MODULE=tm.settings celery -A tm beat --scheduler django_celery_beat.schedulers:DatabaseScheduler --pidfile /celerybeat.pid\n```\n\nworkerの起動コマンドは次のとおりです。\n\n```\nbash -c \&quot;DJANGO_SETTINGS_MODULE=tm.settings celery -A tm worker\&quot;\n```\n\n#### 解説\n\n##### workerについて\n\nここで重要なポイントは`DJANGO_SETTINGS_MODULE=tm.settings`です。\n(これを忘れるとひどく沼にはまります。)\n\n`celery -A tm`は`tm/__init__.py`を見に行きます。ここに`celery_app`が存在しない場合はエラーとなります。\n次に、`celery.py`の`app.config_from_object`と`app.autodiscover_tasks`においては、\nDjangoの`settings.py`を探索しに行きます。\n\n```python\napp.config_from_object(&#x27;django.conf:settings&#x27;, namespace=&#x27;CELERY&#x27;)\n```\n\n通常、DEBUGサーバーなど立ち上げる時、`python3 manage.py runserver`などとしますが、\nコードを見ると\n\n```python\nos.environ.setdefault(\&quot;DJANGO_SETTINGS_MODULE\&quot;, \&quot;tm.settings\&quot;)\n```\n\nが走っています。つまり、起動時に環境変数を登録しているため、Djangoを利用するceleryも環境変数、もしくは変数を\n起動時に定義しておかなければなりません。\n\nタスクの認識に関しては、\n\n```python\napp.autodiscover_tasks()\n```\n\nが自動的に`settings.py`から`INSTALLED_APPS`を吸ってきて解決してくれるので、それぞれの`APP`で\nWorkerを明示的に起動する必要はありません。むしろ、それを行った場合、`APP`間でModelを参照するといったことができなくなります。\n\n##### schedulerについて\n\nSchedulerの役割は至ってシンプルです。\n\n1. Databaseに登録されているタスクの監視\n2. 指定の時刻になった時、Brokerに対してWorkerがタスクを実行するようにメッセージを送信\n\n1のおかげで、Django Adminでタスクを登録、編集、削除した時に自動的にスケジューリングされます。\n2はBrokerへ登録されたタスクを実行するようにメッセージを投げるだけです。\n実際に実行されるかどうかは保証されません。\n\nそのスケジュールを管理するためのデータベースとして、\n`--scheduler django_celery_beat.schedulers:DatabaseScheduler`を指定しておきます。\n未指定の場合は、コマンドの実行ディレクトリにSchedulerの管理用のファイルが作成されます。\n`django_celery_beat.schedulers:DatabaseScheduler`を指定してる場合は、\nDjando Adminでは見えませんが、Database上にスケジュールが記述され、仮にSchedulerが落ちたとしても、\nどのタスクがスケジューリングされているかは残ります。\n\n`--pidfile /celerybeat.pid`としているのは、開発上の都合といえばそのとおりです。\n起動場所に`pid`ファイルが生成されますが、Schedulerを再起動した場合に、\n`pid`ファイルが存在した場合、Schedulerの多重起動を防ぐためにSchedulerが起動しません。\n\nコンテナを利用している場合は、良くコンテナごと落とすため、これは不便なため、マウントされていなコンテナのディレクトリに`pid`ファイルを投げています。\n実際に運用するときは、Schedulerのコンテナのサイズを1のままにしておくのが普通かと思います。\n\nどうしてもSchedulerを冗長化するために複数のコンテナを利用する場合は、各コンテナに永続ボリュームをマウントして、`pid`ファイルが\n一意になるように設定しておくこともできますが....\n\n## おわりに\n\nここまでで、タスクのスケジューリング実行が可能となります。\n長くなってしまいそうなので、説明はここまでにしますが、[サンプルコード](https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1)\nではもうちょっとサンプルを追加しています。興味がある人はぜひご覧ください。\n\n\n**参考**\n\n- [Periodic Tasks | Celery 4.1.0 documentation](http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html)\n\n\n&quot;},&quot;site&quot;:{&quot;title&quot;:&quot;himenon.github.io&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;baseUri&quot;:&quot;/&quot;,&quot;baseUrl&quot;:&quot;https://himenon.github.io&quot;}}"></script>
  </head>

  <body>

    <body>
      <div>
        <nav id="nav-bar">
          <div id="nav-bar-container"><a href="/">TOP</a></div>
        </nav>
        <header id="site-header">
          <div id="site-header-container">
            <h1 id="page-title">Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する</h1>
            <p id="page-description">早くが画面から出たい人の備忘録。</p>
            <p id="article-time"><span id="posted-at__label">投稿日</span><time>2018-03-12 10:39:51</time><span id="created-at__label">更新日</span><time>2019-05-21 08:22:01</time></p>
          </div>
        </header>
      </div>
      <div class="wrapper">
        <section>
          <h2>はじめに</h2>
          <p>Django 2.0に対して、Celery 4を導入してみたので、その時の知見を書く。
            導入自体はそうそう難しくはなかったが、これで動く、といったサンプルコードがなかなか無かったので、
            書いておきます。。</p>
          <p><a href="https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1">サンプルコード</a></p>
          <h3>類似技術</h3>
          <p>類似技術で有名なものとしては</p>
          <ul>
            <li>cookpad/kuroko2: <a href="https://github.com/cookpad/kuroko2">https://github.com/cookpad/kuroko2</a></li>
            <li>RUNDECK: <a href="http://rundeck.org/">http://rundeck.org/</a></li>
          </ul>
          <p>がありますが、実はCeleryとDjagnoでも同じようなことができるので、Pythonやっている人は喜びましょう。</p>
          <p>手っ取り早いのは<a href="https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1">サンプルコード</a>
            をさっさと起動することです。この記事は解説に文字を割いていますので。</p>
          <h2>準備</h2>
          <p>本サンプルコードは以下の環境で作成した。</p><pre class="language-plain"><code class="language-plain">Django==2.0.3
django-celery-results==1.0.1
django-celery-beat==1.1.1
redis==2.10.6
</code></pre>
          <p><code>requirements.txt</code>に上記を記述し、<code>pip install -r requirements.txt</code>でインストールしておく。</p>
          <h2>Djangoの作成</h2>
          <p>1.プロジェクトの作成</p><pre class="language-plain"><code class="language-plain">django-admin startproject tm
</code></pre>
          <p>すると次のようなツリーが作成される。</p><pre class="language-plain"><code class="language-plain">.
├── manage.py
└── tm
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py
</code></pre>
          <p>2.Extensionの追加</p>
          <p><code>tm/settings.py</code>に次の記述を入れます。</p><pre class="language-python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'django_celery_beat'</span><span class="token punctuation">,</span>     <span class="token comment"># 追加</span>
    <span class="token string">'django_celery_results'</span><span class="token punctuation">,</span>  <span class="token comment"># 追加</span>
<span class="token punctuation">]</span>
</code></pre>
          <p>3.<code>celery.py</code>の追加</p>
          <p><code>tm/</code>以下に<code>celery.py</code>を追加する。
            celeryの名前空間を汚染しているが、これであっている。</p><pre class="language-plain"><code class="language-plain">.
├── manage.py
└── tm
    ├── __init__.py
    ├── celery.py     # 追加
    ├── settings.py
    ├── urls.py
    └── wsgi.py
</code></pre>
          <p><code>celery.py</code>は以下のように記述する。</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> os <span class="token keyword">import</span> environ
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery
app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tm'</span><span class="token punctuation">,</span> broker<span class="token operator">=</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'BROKER_URL'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config_from_object<span class="token punctuation">(</span><span class="token string">'django.conf:settings'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'CELERY'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>autodiscover_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
          <p>これは、後々登場する<code>@task</code>もしくは<code>@shared_task</code>デコレータを、worker起動時に、
            自動的に<code>INSTALLED_APPS</code>から探索する役割を果たす。</p>
          <p><code>BROKER_URL</code>は、環境変数から指定できるようにしてある。これは状況に合わせて変化して欲しい。</p>
          <p>4.<code>__init__.py</code>にappを読み込むようにする。</p>
          <p><code>tm/__init__.py</code>にCeleryを呼び出すコード記述しておく。</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>celery <span class="token keyword">import</span> app <span class="token keyword">as</span> celery_app

__all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'celery_app'</span><span class="token punctuation">]</span>
</code></pre>
          <p>5.Migration</p>
          <p>CeleryのプラグインはDatabaseへのMigrationを必要とします。</p><pre class="language-plain"><code class="language-plain">python3 manage.py migrate
</code></pre>
          <p><code>django-celery-beat</code>はタスクの実行スケジュール管理のために、
            <code>django-celery-results</code>は実行五の結果を保存しておくためにDatabaseを利用します。</p>
          <p>また、Adminユーザーを作成していない場合は、</p><pre class="language-plain"><code class="language-plain">python3 manage.py createsuperuser
</code></pre>
          <p>でユーザーを作成しておきましょう。
            ここまでうまくいくと、次の画像のように管理画面に、タスクのスケジュール管理の画面が出現します。
            定期実行タスクの管理がここからできるようになります。</p>
          <p><img src="/python/django/images/celery-django-admin.png" alt="Celeryを追加したときの管理画面" /></p>
          <p>次に、タスクを追加してきます。</p>
          <h2>タスクの追加</h2>
          <h3>アプリの追加</h3>
          <p>タスクの追加の前に、アプリの追加をしておきましょう。
            <code>manage.py</code>のあるところで、次のコマンドを叩きます。</p><pre class="language-bash"><code class="language-bash">python3 manage.py startapp tapp_a
python3 manage.py startapp tapp_b
</code></pre>
          <p>今回はアプリ同士の相互呼び出しも検証するため、2つのアプリを追加しておきます。
            <code>INSTALLED_APPS</code>は次のように更新しておきます。</p><pre class="language-python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'django_celery_beat'</span><span class="token punctuation">,</span>
    <span class="token string">'django_celery_results'</span><span class="token punctuation">,</span>
    <span class="token string">'tapp_a'</span><span class="token punctuation">,</span>    <span class="token comment"># 追加</span>
    <span class="token string">'tapp_b'</span><span class="token punctuation">,</span>    <span class="token comment"># 追加</span>
<span class="token punctuation">]</span>
</code></pre>
          <h3>タスクの追加</h3>
          <p><code>tapp_a</code>にシンプルなタスクを追加します。
            <code>tasks.py</code>というファイルを作成し、次のように記述します。</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> celery <span class="token keyword">import</span> shared_task

@shared_task
<span class="token keyword">def</span> <span class="token function">hello_from_a</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hello! From A"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"args = {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"kwargs = {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
          <p><code>@shared_task</code>を指定すると、Django Adminで認識されます。
            画像ではPeriodic Tasksの管理画面中で、いくつかのタスクを追加した場合のものを表示しています。</p>
          <p><img src="/python/django/images/celery-django-admin-add-tasks.png" alt="タスクを追加した時" /></p>
          <p>また、登録したタスクに初期値を与えたい場合は<code>Arguments</code>を利用すると可能です。</p>
          <p><img src="/python/django/images/celery-django-admin-args.png" alt="引数に値を渡したい場合" /></p>
          <h3>実行タイミングの指定</h3>
          <p>実行タイミングの指定は、Interval、Crontab、Solarの3つのうち1つのみが選択可能です。
            どうしても数種類の実行方法が必要な場合は、別タスクとして登録し直します。</p>
          <ul>
            <li>Interval: 10秒ごとなど。一定間隔で行う</li>
            <li>Crontab: 指定した日時で実行を行う</li>
            <li>Solar: 指定した緯度経度に基づいた、日の出、日没などのタイミングで自動的に実行する</li>
          </ul>
          <p>これはお好みで設定して下さい。</p>
          <p>ここまで終われば、タスクの登録が完了です。</p>
          <h2>タスクの実行</h2>
          <p>定期実行タスクに関しては、SchedulerとWorker、BrokerをDjangoとは別のプロセスで起動させる必要があります。
            <a href="https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1">サンプルコード</a>では、
            docker-composeを用いて楽をしています。</p>
          <p>ただ、ここはそれほど難しものではなく、起動コマンドが異なるだけとなります。
            Brokerに関しては今回はredisを採用しており、自動的に立ち上がるので、ここでの説明は省きます。</p>
          <h3>scheduler, workerの起動</h3>
          <p>schedulerの起動コマンドは次の通りです。</p><pre class="language-bash"><code class="language-bash">DJANGO_SETTINGS_MODULE<span class="token operator">=</span>tm.settings celery -A tm beat --scheduler django_celery_beat.schedulers:DatabaseScheduler --pidfile /celerybeat.pid
</code></pre>
          <p>workerの起動コマンドは次のとおりです。</p><pre class="language-plain"><code class="language-plain">bash -c &quot;DJANGO_SETTINGS_MODULE=tm.settings celery -A tm worker&quot;
</code></pre>
          <h4>解説</h4>
          <h5>workerについて</h5>
          <p>ここで重要なポイントは<code>DJANGO_SETTINGS_MODULE=tm.settings</code>です。
            (これを忘れるとひどく沼にはまります。)</p>
          <p><code>celery -A tm</code>は<code>tm/__init__.py</code>を見に行きます。ここに<code>celery_app</code>が存在しない場合はエラーとなります。
            次に、<code>celery.py</code>の<code>app.config_from_object</code>と<code>app.autodiscover_tasks</code>においては、
            Djangoの<code>settings.py</code>を探索しに行きます。</p><pre class="language-python"><code class="language-python">app<span class="token punctuation">.</span>config_from_object<span class="token punctuation">(</span><span class="token string">'django.conf:settings'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'CELERY'</span><span class="token punctuation">)</span>
</code></pre>
          <p>通常、DEBUGサーバーなど立ち上げる時、<code>python3 manage.py runserver</code>などとしますが、
            コードを見ると</p><pre class="language-python"><code class="language-python">os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">"DJANGO_SETTINGS_MODULE"</span><span class="token punctuation">,</span> <span class="token string">"tm.settings"</span><span class="token punctuation">)</span>
</code></pre>
          <p>が走っています。つまり、起動時に環境変数を登録しているため、Djangoを利用するceleryも環境変数、もしくは変数を
            起動時に定義しておかなければなりません。</p>
          <p>タスクの認識に関しては、</p><pre class="language-python"><code class="language-python">app<span class="token punctuation">.</span>autodiscover_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
          <p>が自動的に<code>settings.py</code>から<code>INSTALLED_APPS</code>を吸ってきて解決してくれるので、それぞれの<code>APP</code>で
            Workerを明示的に起動する必要はありません。むしろ、それを行った場合、<code>APP</code>間でModelを参照するといったことができなくなります。</p>
          <h5>schedulerについて</h5>
          <p>Schedulerの役割は至ってシンプルです。</p>
          <ol>
            <li>Databaseに登録されているタスクの監視</li>
            <li>指定の時刻になった時、Brokerに対してWorkerがタスクを実行するようにメッセージを送信</li>
          </ol>
          <p>1のおかげで、Django Adminでタスクを登録、編集、削除した時に自動的にスケジューリングされます。
            2はBrokerへ登録されたタスクを実行するようにメッセージを投げるだけです。
            実際に実行されるかどうかは保証されません。</p>
          <p>そのスケジュールを管理するためのデータベースとして、
            <code>--scheduler django_celery_beat.schedulers:DatabaseScheduler</code>を指定しておきます。
            未指定の場合は、コマンドの実行ディレクトリにSchedulerの管理用のファイルが作成されます。
            <code>django_celery_beat.schedulers:DatabaseScheduler</code>を指定してる場合は、
            Djando Adminでは見えませんが、Database上にスケジュールが記述され、仮にSchedulerが落ちたとしても、
            どのタスクがスケジューリングされているかは残ります。</p>
          <p><code>--pidfile /celerybeat.pid</code>としているのは、開発上の都合といえばそのとおりです。
            起動場所に<code>pid</code>ファイルが生成されますが、Schedulerを再起動した場合に、
            <code>pid</code>ファイルが存在した場合、Schedulerの多重起動を防ぐためにSchedulerが起動しません。</p>
          <p>コンテナを利用している場合は、良くコンテナごと落とすため、これは不便なため、マウントされていなコンテナのディレクトリに<code>pid</code>ファイルを投げています。
            実際に運用するときは、Schedulerのコンテナのサイズを1のままにしておくのが普通かと思います。</p>
          <p>どうしてもSchedulerを冗長化するために複数のコンテナを利用する場合は、各コンテナに永続ボリュームをマウントして、<code>pid</code>ファイルが
            一意になるように設定しておくこともできますが....</p>
          <h2>おわりに</h2>
          <p>ここまでで、タスクのスケジューリング実行が可能となります。
            長くなってしまいそうなので、説明はここまでにしますが、<a href="https://github.com/Himenon/DjangoSample/tree/master/taskmanager_v1">サンプルコード</a>
            ではもうちょっとサンプルを追加しています。興味がある人はぜひご覧ください。</p>
          <p><strong>参考</strong></p>
          <ul>
            <li><a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html">Periodic Tasks | Celery 4.1.0 documentation</a></li>
          </ul>
        </section>
      </div>
    </body>
  </body>

</html>