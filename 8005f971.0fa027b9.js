(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{115:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return i})),a.d(n,"metadata",(function(){return l})),a.d(n,"rightToc",(function(){return p})),a.d(n,"default",(function(){return c}));var t=a(2),r=a(7),o=(a(0),a(187)),i={title:"Django\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u5206\u5272\u3057\u3066\u5229\u7528\u3059\u308b",description:"\u8907\u6570\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u53c2\u7167\u3092Django\u3067\u69cb\u7bc9\u3059\u308b",keywords:["python","django","database","separate","django \u8907\u6570\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9","django model \u5206\u5272","database_routers","django \u8907\u6570db","database_apps_mapping","django db \u8907\u6570","django multiple database","django database router","django database \u8907\u6570","django db_for_read"],createdAt:new Date("2018-04-16T01:54:44.000Z"),updatedAt:new Date("2019-05-21T11:22:01.000Z")},l={unversionedId:"python/django/seperate-django-database",id:"python/django/seperate-django-database",isDocsHomePage:!1,title:"Django\u3067\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u5206\u5272\u3057\u3066\u5229\u7528\u3059\u308b",description:"\u8907\u6570\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3078\u306e\u53c2\u7167\u3092Django\u3067\u69cb\u7bc9\u3059\u308b",source:"@site/docs/python/django/seperate-django-database.md",slug:"/python/django/seperate-django-database",permalink:"/docs/python/django/seperate-django-database",editUrl:"https://github.com/Himenon/himenon.github.io/edit/master/docs/python/django/seperate-django-database.md",version:"current",sidebar:"someSidebar",previous:{title:"Django 2.0\u306bCelery 4.0\u3092\u5c0e\u5165\u3057\u3001WEB\u306e\u7ba1\u7406\u753b\u9762\u3067Cron\u3092\u7ba1\u7406\u3059\u308b",permalink:"/docs/python/django/introduction-of-celery-django"},next:{title:"Django\u3067Many to Many\u3092Admin\u753b\u9762\u306e\u30ea\u30b9\u30c8\u306b\u8868\u793a\u3059\u308b",permalink:"/docs/python/django/show-many-to-many-admin-view"}},p=[{value:"settings.py",id:"settingspy",children:[]},{value:"Database routers",id:"database-routers",children:[]},{value:"Migration",id:"migration",children:[]},{value:"\u6700\u5f8c\u306b",id:"\u6700\u5f8c\u306b",children:[]}],d={rightToc:p};function c(e){var n=e.components,a=Object(r.a)(e,["components"]);return Object(o.a)("wrapper",Object(t.a)({},d,a,{components:n,mdxType:"MDXLayout"}),Object(o.a)("p",null,"\u30e6\u30fc\u30b6\u30fc\u7ba1\u7406\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3068\u3001\u5206\u6790\u7528\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306a\u3069\u306e\u3088\u3046\u306b\u5206\u96e2\u3057\u305f\u3044\u3068\u304d\u304c\u3042\u308a\u307e\u3059\u3002\nDjango 2.0\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f",Object(o.a)("a",Object(t.a)({parentName:"p"},{href:"https://docs.djangoproject.com/en/2.0/topics/db/multi-db/"}),"Multiple databases"),"\u306e\u7ae0\u306b\u8aac\u660e\u304c\u3042\u308a\u307e\u3059\u3002"),Object(o.a)("p",null,"\u3084\u308b\u3053\u3068\u306f4\u3064"),Object(o.a)("ol",null,Object(o.a)("li",{parentName:"ol"},Object(o.a)("inlineCode",{parentName:"li"},"settings.py"),"\u306e",Object(o.a)("inlineCode",{parentName:"li"},"DATABASES"),"\u306b\u8907\u6570\u306eDB\u306e\u63a5\u7d9a\u5148\u3092\u8a18\u5165\u3059\u308b"),Object(o.a)("li",{parentName:"ol"},Object(o.a)("inlineCode",{parentName:"li"},"settings.py"),"\u306b",Object(o.a)("inlineCode",{parentName:"li"},"DATABASE_APPS_MAPPING"),"\u3092\u5b9a\u7fa9\u3057\u3001\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3054\u3068\u306bKV\u5f62\u5f0f\u3067\u63a5\u7d9a\u5148\u306eDB\u540d\u3092\u8a18\u8ff0\u3059\u308b"),Object(o.a)("li",{parentName:"ol"},Object(o.a)("inlineCode",{parentName:"li"},"settings.py"),"\u306b",Object(o.a)("inlineCode",{parentName:"li"},"DATABASE_ROUTERS"),"\u3092\u5b9a\u7fa9\u3057\u3001\u63a5\u7d9a\u3059\u308bDB\u3092\u632f\u308a\u5206\u3051\u308b\u305f\u3081\u306eRouter\u306e\u5b9a\u7fa9\u3092\u914d\u5217\u5f62\u5f0f\u3067\u8a18\u8ff0\u3059\u308b"),Object(o.a)("li",{parentName:"ol"},Object(o.a)("inlineCode",{parentName:"li"},"DATABASE_ROUTERS"),"\u306b\u5b9a\u7fa9\u3055\u308c\u305frouter\u3092\u7528\u610f\u3059\u308b")),Object(o.a)("p",null,"\u5b9f\u969b\u306b\u5177\u4f53\u4f8b\u3092\u793a\u3057\u3066\u307f\u307e\u3059\u3002\n\u3053\u3053\u3067\u793a\u3059\u5177\u4f53\u4f8b\u3067\u306f\u3001",Object(o.a)("inlineCode",{parentName:"p"},"DATABASE_APPS_MAPPING"),"\u306b\u6307\u5b9a\u3057\u305f\u3068\u304a\u308a\u306b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304c\n\u632f\u308a\u5206\u3051\u308b\u3068\u3044\u3046\u5358\u7d14\u306a\u3053\u3068\u3060\u3051\u3092\u9054\u6210\u3057\u307e\u3059\u3002"),Object(o.a)("p",null,"\u3061\u3087\u3063\u3068\u5927\u96d1\u628a\u3067\u306f\u3042\u308a\u307e\u3059\u304c\u3001\u4e0b\u8a18\u306e\u3088\u3046\u306a\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u69cb\u6210\u3092\u53d6\u3063\u3066\u3044\u308b\u3082\u306e\u3068\u3057\u307e\u3059\u3002\n",Object(o.a)("inlineCode",{parentName:"p"},"myapp"),"\u306fdjango\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u3059\u3002"),Object(o.a)("pre",null,Object(o.a)("code",Object(t.a)({parentName:"pre"},{}),"myapp/\n\u251c\u2500\u2500 myapp/settings.py\n\u251c\u2500\u2500 manage.py\n\u2514\u2500\u2500 routers.py\n")),Object(o.a)("h2",{id:"settingspy"},"settings.py"),Object(o.a)("pre",null,Object(o.a)("code",Object(t.a)({parentName:"pre"},{className:"language-python"}),"# myapp/settings.py\nfrom os import environ\n\n# \u63a5\u7d9a\u5148\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5b9a\u7fa9\nDATABASES = {\n  'default': {\n        'ENGINE': 'django.db.backends.mysql',\n        'NAME': 'mydb',\n        'USER': environ.get('DEFAULT_MYSQL_USER'),\n        'PASSWORD': environ.get('DEFAULT_MYSQL_PASSWORD'),\n        'HOST': environ.get('DEFAULT_DB_HOST', '127.0.0.1'),\n        'PORT': environ.get('DEFAULT_DB_PORT', '3306'),\n        'OPTIONS': {\n            'init_command': \"SET sql_mode='STRICT_TRANS_TABLES'\",\n            'charset': 'utf8mb4',\n        },\n        'TEST': {\n            'CHARSET': 'utf8mb4',\n            'COLLATION': 'utf8mb4_general_ci',\n        },\n  },\n  'analytics': {\n        'ENGINE': 'django.db.backends.mysql',\n        'NAME': 'mydb',\n        'USER': environ.get('ANALYTICS_MYSQL_USER'),\n        'PASSWORD': environ.get('ANALYTICS_MYSQL_PASSWORD'),\n        'HOST': environ.get('ANALYTICS_DB_HOST', '127.0.0.1'),\n        'PORT': environ.get('ANALYTICS_DB_PORT', '3306'),\n        'OPTIONS': {\n            'init_command': \"SET sql_mode='STRICT_TRANS_TABLES'\",\n            'charset': 'utf8mb4',\n        },\n        'TEST': {\n            'CHARSET': 'utf8mb4',\n            'COLLATION': 'utf8mb4_general_ci',\n        },\n  }\n}\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3054\u3068\u306e\u63a5\u7d9a\u5148DB\u306e\u30de\u30c3\u30d4\u30f3\u30b0\nDATABASE_APPS_MAPPING = {\n    # default\u306b\u306f\u7ba1\u7406\u7cfb\u306eTable\n    'admin'              : 'default',\n    'auth'               : 'default',\n    'contenttypes'       : 'default',\n    'sessions'           : 'default',\n    'messages'           : 'default',\n    'staticfiles'        : 'default',\n    'django_celery_beat' : 'default',\n    # analytics\u306b\u306f\u5206\u6790\u8a08\u306eTable\n    'myapp'              : 'analytics',\n}\n\n# \u5229\u7528\u3059\u308bRouter, manage.py\u304b\u3089\u898b\u3066\u306e\u76f8\u5bfe\u30d1\u30b9\nDATABASE_ROUTERS = [\n    'router.DatabaseRouter',\n]\n")),Object(o.a)("h2",{id:"database-routers"},"Database routers"),Object(o.a)("p",null,"\u4ee5\u4e0b\u306e4\u3064\u306e\u30e1\u30bd\u30c3\u30c9\u304c\u5b9a\u7fa9\u3055\u308c\u305f\u30af\u30e9\u30b9\u3092\u7528\u610f\u3057\u307e\u3059\u3002"),Object(o.a)("ul",null,Object(o.a)("li",{parentName:"ul"},Object(o.a)("inlineCode",{parentName:"li"},"db_for_read")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("inlineCode",{parentName:"li"},"db_for_write")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("inlineCode",{parentName:"li"},"allow_relation")),Object(o.a)("li",{parentName:"ul"},Object(o.a)("inlineCode",{parentName:"li"},"allow_migrate"))),Object(o.a)("p",null,"\u53c2\u8003: ",Object(o.a)("a",Object(t.a)({parentName:"p"},{href:"https://docs.djangoproject.com/en/2.0/topics/db/multi-db/#database-routers"}),"Database routers")),Object(o.a)("p",null,Object(o.a)("inlineCode",{parentName:"p"},"router.DatabaseRouter"),"\u306f\u6b21\u306e\u3088\u3046\u306b\u5b9a\u7fa9\u3057\u3066\u3044\u307e\u3059\u3002"),Object(o.a)("pre",null,Object(o.a)("code",Object(t.a)({parentName:"pre"},{className:"language-python"}),"# routers.py\nfrom myapp.settings import DATABASE_APPS_MAPPING\n\nclass DatabaseRouter(object):\n    def db_for_read(self, model, **hints):\n        if model._meta.app_label in DATABASE_APPS_MAPPING:\n            return DATABASE_APPS_MAPPING[model._meta.app_label]\n        return None\n\n    def db_for_write(self, model, **hints):\n        if model._meta.app_label in DATABASE_APPS_MAPPING:\n            return DATABASE_APPS_MAPPING[model._meta.app_label]\n        return None\n\n    def allow_relation(self, obj1, obj2, **hints):\n        db1 = DATABASE_APPS_MAPPING.get(obj1._meta.app_label)\n        db2 = DATABASE_APPS_MAPPING.get(obj2._meta.app_label)\n        if db1 and db2:\n            return db1 == db2\n        return None\n\n    def allow_migrate(self, db, app_label, model=None, **hints):\n        if db in DATABASE_APPS_MAPPING.values():\n            return DATABASE_APPS_MAPPING.get(app_label) == db\n        elif app_label in DATABASE_APPS_MAPPING:\n            return False\n")),Object(o.a)("p",null,"\u3053\u308c\u3067\u8a2d\u5b9a\u5b8c\u4e86\u3067\u3059"),Object(o.a)("h2",{id:"migration"},"Migration"),Object(o.a)("p",null,"Migration\u306f\u30b3\u30de\u30f3\u30c9\u304c\u5909\u308f\u308a\u307e\u3059\u3002\n\u901a\u5e38\u3001",Object(o.a)("inlineCode",{parentName:"p"},"./manage.py migrate"),"\u3092\u884c\u3046\u3068\u3001",Object(o.a)("inlineCode",{parentName:"p"},"default"),"\u3067\u6307\u5b9a\u3055\u308c\u305fDB\u306b\u5bfe\u3057\u3066Migration\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u304c\u3001\n\u4eca\u56de\u306f\u5206\u96e2\u3057\u3066\u3044\u308b\u306e\u3067\u3001",Object(o.a)("inlineCode",{parentName:"p"},"--database"),"\u5f15\u6570\u3092\u7528\u3044\u3066\u660e\u793a\u7684\u306b\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002"),Object(o.a)("pre",null,Object(o.a)("code",Object(t.a)({parentName:"pre"},{className:"language-bash"}),"$ ./manage.py migrate                          # default\u306b\u5bfe\u3059\u308bMigration\n$ ./manage.py migrate --database=analytics     # analytics\u306b\u5bfe\u3059\u308bMigration\n")),Object(o.a)("p",null,"\u3053\u308c\u3067Migration\u304c\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002\n\u307e\u305f\u3001\u305d\u306e\u4ed6\u306e\u30b3\u30de\u30f3\u30c9\u3067\u3082DB\u5358\u4f4d\u3067\u5b9f\u884c\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u306e\u3067\u3001\u6ce8\u610f\u304c\u5fc5\u8981\u3067\u3059\u3002"),Object(o.a)("h2",{id:"\u6700\u5f8c\u306b"},"\u6700\u5f8c\u306b"),Object(o.a)("p",null,"\u6700\u8fd1\u3001Python\u754c\u9688\u304c\u5206\u6790\u7cfb\u3084\u6df1\u5c64\u5b66\u7fd2\u306a\u3069\u3067\u9a12\u304c\u308c\u3066\u3044\u307e\u3059\u304c\u3001\n\u30c7\u30fc\u30bf\u3092\u84c4\u7a4d\u3059\u308bDB\u306e\u7ba1\u7406\u306e\u8a71\u304c\u51fa\u3066\u3053\u306a\u3044\u306e\u304c\u6c17\u306b\u306a\u308a\u307e\u3059\u3002"),Object(o.a)("p",null,"\u307f\u306a\u3055\u3093\u3001\u3069\u3046\u3084\u3063\u3066\u7ba1\u7406\u3057\u3066\u3044\u308b\u306e\u3067\u3057\u3087\u3046\uff1f\n\u5206\u6790\u57fa\u76e4\u306e\u62c5\u5f53\u306e\u65b9\u304c\u3044\u3089\u3063\u3057\u3083\u308c\u3070\u826f\u3044\u306e\u3067\u3059\u304c\u3001\u5168\u54e1\u304c\u305d\u3046\u3067\u306f\u306a\u3044\u3068\u601d\u3044\u307e\u3059\u306e\u3067\u3001\n\u3053\u306e\u8a18\u4e8b\u304c\u4e00\u4eba\u3067\u5168\u90e8\u3084\u3089\u306a\u3044\u3068\u3044\u3051\u306a\u3044\u306a\u3041\u3001\u3068\u601d\u3063\u3066\u3044\u308b\u4eba\u306e\u3068\u3053\u308d\u306b\u5c4a\u3051\u3070\u3068\u601d\u3044\u307e\u3059\u3002"),Object(o.a)("p",null,"\u9593\u9055\u3044\u304c\u3042\u308c\u3070Twitter\u306a\u3069\u3067\u5831\u544a\u3057\u3066\u304f\u308c\u308b\u3068\u4fee\u6b63\u3044\u305f\u3057\u307e\u3059\u3002"))}c.isMDXComponent=!0},187:function(e,n,a){"use strict";a.d(n,"a",(function(){return u}));var t=a(0),r=a.n(t);function o(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function i(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function l(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?i(Object(a),!0).forEach((function(n){o(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function p(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var d=r.a.createContext({}),c=function(e){var n=r.a.useContext(d),a=n;return e&&(a="function"==typeof e?e(n):l({},n,{},e)),a},b={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},s=Object(t.forwardRef)((function(e,n){var a=e.components,t=e.mdxType,o=e.originalType,i=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),s=c(a),u=t,m=s["".concat(i,".").concat(u)]||s[u]||b[u]||o;return a?r.a.createElement(m,l({ref:n},d,{components:a})):r.a.createElement(m,l({ref:n},d))}));function u(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var o=a.length,i=new Array(o);i[0]=s;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:t,i[1]=l;for(var d=2;d<o;d++)i[d]=a[d];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,a)}s.displayName="MDXCreateElement"}}]);