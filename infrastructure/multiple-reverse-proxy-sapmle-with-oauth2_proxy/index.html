<html>

  <head lang="ja">
    <title>複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする</title>
    <meta charSet="utf-8" />
    <meta name="keywords" content="oauth2_proxy,nginx,oauth" />
    <meta name="description" content="oauth2_proxyを複数のリバースプロキシ先に対応させてみた。" />
    <meta name="copyright" content="@Himenon" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Himenon" />
    <meta property="og:title" content="複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする" />
    <meta property="og:url" content="https://himenon.github.io/infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy" />
    <meta property="og:description" content="oauth2_proxyを複数のリバースプロキシ先に対応させてみた。" />
    <meta property="og:image" content="https://himenon.github.io/assets/images/miku.png" />
    <meta name="viewport" content="initial-scale=1,minimum-scale=0.5,user-scalable=no" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/miku.png?96b66" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png?39621" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png?15fa6" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600,800?af8e6" rel="stylesheet" />
    <link href="/lib/prism.css?2cc99" rel="stylesheet" />
    <link href="/assets/stylesheets/styles.css?9c282" rel="stylesheet" />
    <script>
      (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-55455343-7', 'auto');
      ga('send', 'pageview');
    </script>
    <script id="csr-props" data-csr-props="{&quot;htmlMetaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする&quot;,&quot;description&quot;:&quot;oauth2_proxyを複数のリバースプロキシ先に対応させてみた。&quot;,&quot;keywords&quot;:&quot;oauth2_proxy,nginx,oauth&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2018-02-19T01:22:10.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;oauth2_proxyを複数のリバースプロキシ先に対応させてみた。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;page&quot;:{&quot;uri&quot;:&quot;/infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy&quot;,&quot;content&quot;:&quot;\n![](./images/reverse-proxy-architecture-including-oauth2_proxy.svg)\n\n## これはなに？\n\n[oauth2_proxy](https://github.com/bitly/oauth2_proxy)を複数のリバースプロキシ先に対応させた、\nサンプル（[Himenon/oauth2_proxy](https://github.com/Himenon/oauth2_proxy)）を作成した紹介です。\n\n（スターください。PRも歓迎です）\n\n### 何に使える？\n\nたとえば、\n\n- 社内ドキュメントをホスティングした時に、OAuth2で保護したい。\n- Globalにテスト用のアプリケーションを作って内部のみに公開したいが、ip制限だけでなく、OAuthをかけたい\n\nなどなど、対外向けのサービスで使うというより、内部向けのアプリや、情報を保護するための用途で使えます。\n\n## ことの発端\n\n(読み飛ばして大丈夫です。)\n\n[Cookpad Tech Conf 2018](https://techconf.cookpad.com/2018/)で**Challenges for Global Service from a Perspective of SRE**の発表で、\n認証周りの業務が増えてがつらく、それをnginx側でoauthをproxyさせること脱Basic認証をし、管理するアプリケーションが増えても柔軟に対応できるようにした、\nと聞いた際に自分でもやってみようと思ったことが発端です。\n\nCoockpadさんの記事もありますので、これ以上はそちらを読んで下さい。\n\n- [2015-10-16 nginx で omniauth を利用してアクセス制御を行う](http://techlife.cookpad.com/entry/2015/10/16/080000)\n- [sorah/nginx_omniauth_adapter](https://github.com/sorah/nginx_omniauth_adapter)\n\n\n僕自身もBasic認証つれぇ、モダンにやりたい、って思ってたのでちょうどいいと思ってたところだったので、\nその辺のツール落ちていないか、というところから探してみました。\n\nそして、出会ったのが[oauth2_proxy](https://github.com/bitly/oauth2_proxy)。\n色んな人がメンテナスしている + スター数が3k超えってところで使ってみようと思いました。\n\n日本語の記事を調べたところ、割と最近(今が2018/2なので)の記事も発見できました。\n\n- 2017/12/14 [手っ取り早くウェブアプリケーションにOAuth2認証を導入する](http://moznion.hatenadiary.com/entry/2017/12/14/230945)\n- 2017/04/05 [oauth2_proxyでRundeckにGitHub認証でログインする](https://qiita.com/minamijoyo/items/52041ff8628263355810)\n- 2016/01/18 [oauth2_proxyとNginxのauth_requestを組み合わせると便利](http://lamanotrama.hateblo.jp/entry/2016/01/18/142116)\n\n他にも次のコードも発見しました。\n\n- [a5huynh/oauth2_proxy](https://github.com/a5huynh/oauth2_proxy)\n\nただ、欲しかった情報が\n\n- わかりやすいサンプルコード\n- Dockerを使っている\n- 複数のホストに対してOAuthが対応している\n\nだったので、どれも満たしていなかったので自分で作ることにしました。\n\n## 実装内容\n\n難しいことはしてませんが、以下の2点が他と異なるので、ここで取り上げます。\n\n- redirect_urls\n- Cookie対策\n\nまた、以下では冒頭のアーキテクチャ図にある名称で説明します。\n\n### redirect_urls\n\nProviderのredirect_url**s**を複数指定すること。\nコード風にかくと、\n\n```\nredirect_urls = [\n    &#x27;server-a.example.com&#x27;,\n    &#x27;server-b.example.com&#x27;\n]\n```\n\nと言った具合です。\n\n```\nProviderによっては複数の入力欄があったり、カンマ区切りで入力したりさまざまなので、\nそこは個々の入力方法を確認して下さい。\n```\n\n### Cookie対策\n\n実行ファイル、`google_auth_proxy`がとる引数で`--cookie-domain`があるのですが([この部分](https://github.com/Himenon/oauth2_proxy/blob/master/oauth2_proxy/run.sh#L12))、\nここをサブドメインを含めずに書きます。\nつまり、`--cookie-domain=example.com`とし、server-aでもserver-bでも同じCookieを利用するようにします。\n\nこのようにすることで、CORSがコケることなく、複数のサブドメインで認証できます。\n\n```\n無論、この手は普通やらないと思いますし、何が起こるかわからないので、\n実際のサービスとしては使ってはいけません。\n\nこれは、内部向けだったり、用途が限られた空間内でBasic認証などによる不必要な認証管理をするための1手段としては有効なので、\nこのProxyを噛ませるアプリケーションの公開範囲をキチンと管理できた上で利用するならば有効な手だと思います。\n```\n\n### 課題（TODO）\n\nCookie Domainを明確に単一にすることが現状の課題です。\nこれは2つのことを解決します。\n\n1つ目は先に上げたCORSの問題です。\n例えば`proxy.example.com`のように、現状の`*.example.com`よりも狭い範囲でCookieが利用されている方が\nサブドメインで分けられた、他のアプリケーションが不必要なCookieをロードする必要がなくなります。\n\n2つ目は、redirect_urlsの問題です。\n一見、問題がなささそうに見えますがそうではありません。\nredirect_urlsはどこに・誰が登録しますか？\nリバースプロキシする対象が増減たびに、Providerのredirect_urlsを更新する必要があります。\n\nこれはオペレーションミスの可能性を含んでいますし、\n実装者はnginxの調整以外に、Providerの管理者に更新依頼をするというプロセスが増えてしまいます。\n\n#### 理想\n\n理想のフローは次のような手順です(ざっくり)\n\n&lt;div className=\&quot;mermaid\&quot;&gt;\nsequenceDiagram\n  Browser-&gt;&gt;Nginx: request(a.example.com)\n  Nginx-&gt;&gt;oauth2_proxy: proxy(proxy.example.com/oauth2/auth)\n  oauth2_proxy-&gt;&gt;Provider: request\n  Provider-&gt;&gt;Nginx: response(redirect: proxy.example.com)\n  Nginx-&gt;&gt;Backend: Reverse Proxy (a.example.com)\n&lt;/div&gt;\n\nこれが解決できたらまた更新しようと思います。\n&quot;,&quot;metaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする&quot;,&quot;description&quot;:&quot;oauth2_proxyを複数のリバースプロキシ先に対応させてみた。&quot;,&quot;keywords&quot;:&quot;oauth2_proxy,nginx,oauth&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2018-02-19T01:22:10.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;oauth2_proxyを複数のリバースプロキシ先に対応させてみた。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;ext&quot;:&quot;.md&quot;,&quot;filename&quot;:&quot;src/infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy.md&quot;,&quot;name&quot;:&quot;infrastructure/multiple-reverse-proxy-sapmle-with-oauth2_proxy&quot;,&quot;raw&quot;:&quot;---\ntitle: \&quot;複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする\&quot;\ndescription: \&quot;oauth2_proxyを複数のリバースプロキシ先に対応させてみた。\&quot;\nkeywords: \&quot;oauth2_proxy,nginx,oauth\&quot;\ncreatedAt: 2018-02-19 01:22:10\nupdatedAt: 2019-05-21 11:22:01\n---\n\n![](./images/reverse-proxy-architecture-including-oauth2_proxy.svg)\n\n## これはなに？\n\n[oauth2_proxy](https://github.com/bitly/oauth2_proxy)を複数のリバースプロキシ先に対応させた、\nサンプル（[Himenon/oauth2_proxy](https://github.com/Himenon/oauth2_proxy)）を作成した紹介です。\n\n（スターください。PRも歓迎です）\n\n### 何に使える？\n\nたとえば、\n\n- 社内ドキュメントをホスティングした時に、OAuth2で保護したい。\n- Globalにテスト用のアプリケーションを作って内部のみに公開したいが、ip制限だけでなく、OAuthをかけたい\n\nなどなど、対外向けのサービスで使うというより、内部向けのアプリや、情報を保護するための用途で使えます。\n\n## ことの発端\n\n(読み飛ばして大丈夫です。)\n\n[Cookpad Tech Conf 2018](https://techconf.cookpad.com/2018/)で**Challenges for Global Service from a Perspective of SRE**の発表で、\n認証周りの業務が増えてがつらく、それをnginx側でoauthをproxyさせること脱Basic認証をし、管理するアプリケーションが増えても柔軟に対応できるようにした、\nと聞いた際に自分でもやってみようと思ったことが発端です。\n\nCoockpadさんの記事もありますので、これ以上はそちらを読んで下さい。\n\n- [2015-10-16 nginx で omniauth を利用してアクセス制御を行う](http://techlife.cookpad.com/entry/2015/10/16/080000)\n- [sorah/nginx_omniauth_adapter](https://github.com/sorah/nginx_omniauth_adapter)\n\n\n僕自身もBasic認証つれぇ、モダンにやりたい、って思ってたのでちょうどいいと思ってたところだったので、\nその辺のツール落ちていないか、というところから探してみました。\n\nそして、出会ったのが[oauth2_proxy](https://github.com/bitly/oauth2_proxy)。\n色んな人がメンテナスしている + スター数が3k超えってところで使ってみようと思いました。\n\n日本語の記事を調べたところ、割と最近(今が2018/2なので)の記事も発見できました。\n\n- 2017/12/14 [手っ取り早くウェブアプリケーションにOAuth2認証を導入する](http://moznion.hatenadiary.com/entry/2017/12/14/230945)\n- 2017/04/05 [oauth2_proxyでRundeckにGitHub認証でログインする](https://qiita.com/minamijoyo/items/52041ff8628263355810)\n- 2016/01/18 [oauth2_proxyとNginxのauth_requestを組み合わせると便利](http://lamanotrama.hateblo.jp/entry/2016/01/18/142116)\n\n他にも次のコードも発見しました。\n\n- [a5huynh/oauth2_proxy](https://github.com/a5huynh/oauth2_proxy)\n\nただ、欲しかった情報が\n\n- わかりやすいサンプルコード\n- Dockerを使っている\n- 複数のホストに対してOAuthが対応している\n\nだったので、どれも満たしていなかったので自分で作ることにしました。\n\n## 実装内容\n\n難しいことはしてませんが、以下の2点が他と異なるので、ここで取り上げます。\n\n- redirect_urls\n- Cookie対策\n\nまた、以下では冒頭のアーキテクチャ図にある名称で説明します。\n\n### redirect_urls\n\nProviderのredirect_url**s**を複数指定すること。\nコード風にかくと、\n\n```\nredirect_urls = [\n    &#x27;server-a.example.com&#x27;,\n    &#x27;server-b.example.com&#x27;\n]\n```\n\nと言った具合です。\n\n```\nProviderによっては複数の入力欄があったり、カンマ区切りで入力したりさまざまなので、\nそこは個々の入力方法を確認して下さい。\n```\n\n### Cookie対策\n\n実行ファイル、`google_auth_proxy`がとる引数で`--cookie-domain`があるのですが([この部分](https://github.com/Himenon/oauth2_proxy/blob/master/oauth2_proxy/run.sh#L12))、\nここをサブドメインを含めずに書きます。\nつまり、`--cookie-domain=example.com`とし、server-aでもserver-bでも同じCookieを利用するようにします。\n\nこのようにすることで、CORSがコケることなく、複数のサブドメインで認証できます。\n\n```\n無論、この手は普通やらないと思いますし、何が起こるかわからないので、\n実際のサービスとしては使ってはいけません。\n\nこれは、内部向けだったり、用途が限られた空間内でBasic認証などによる不必要な認証管理をするための1手段としては有効なので、\nこのProxyを噛ませるアプリケーションの公開範囲をキチンと管理できた上で利用するならば有効な手だと思います。\n```\n\n### 課題（TODO）\n\nCookie Domainを明確に単一にすることが現状の課題です。\nこれは2つのことを解決します。\n\n1つ目は先に上げたCORSの問題です。\n例えば`proxy.example.com`のように、現状の`*.example.com`よりも狭い範囲でCookieが利用されている方が\nサブドメインで分けられた、他のアプリケーションが不必要なCookieをロードする必要がなくなります。\n\n2つ目は、redirect_urlsの問題です。\n一見、問題がなささそうに見えますがそうではありません。\nredirect_urlsはどこに・誰が登録しますか？\nリバースプロキシする対象が増減たびに、Providerのredirect_urlsを更新する必要があります。\n\nこれはオペレーションミスの可能性を含んでいますし、\n実装者はnginxの調整以外に、Providerの管理者に更新依頼をするというプロセスが増えてしまいます。\n\n#### 理想\n\n理想のフローは次のような手順です(ざっくり)\n\n&lt;div className=\&quot;mermaid\&quot;&gt;\nsequenceDiagram\n  Browser-&gt;&gt;Nginx: request(a.example.com)\n  Nginx-&gt;&gt;oauth2_proxy: proxy(proxy.example.com/oauth2/auth)\n  oauth2_proxy-&gt;&gt;Provider: request\n  Provider-&gt;&gt;Nginx: response(redirect: proxy.example.com)\n  Nginx-&gt;&gt;Backend: Reverse Proxy (a.example.com)\n&lt;/div&gt;\n\nこれが解決できたらまた更新しようと思います。\n&quot;},&quot;site&quot;:{&quot;title&quot;:&quot;himenon.github.io&quot;,&quot;description&quot;:&quot;早く画面から出たい人の備忘録。&quot;,&quot;baseUri&quot;:&quot;/&quot;,&quot;baseUrl&quot;:&quot;https://himenon.github.io&quot;}}"></script>
  </head>

  <body>

    <body>
      <div>
        <nav id="nav-bar">
          <div id="nav-bar-container"><a href="/">TOP</a></div>
        </nav>
        <header id="site-header">
          <div id="site-header-container">
            <h1 id="page-title">複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする</h1>
            <p id="page-description">oauth2_proxyを複数のリバースプロキシ先に対応させてみた。</p>
            <p id="article-time"><span id="posted-at__label">投稿日</span><time>2018-02-19 10:22:10</time><span id="created-at__label">更新日</span><time>2019-05-21 08:22:01</time></p>
          </div>
        </header>
      </div>
      <div class="wrapper">
        <section>
          <p><img src="/infrastructure/images/reverse-proxy-architecture-including-oauth2_proxy.svg" /></p>
          <h2>これはなに？</h2>
          <p><a href="https://github.com/bitly/oauth2_proxy">oauth2_proxy</a>を複数のリバースプロキシ先に対応させた、
            サンプル（<a href="https://github.com/Himenon/oauth2_proxy">Himenon/oauth2_proxy</a>）を作成した紹介です。</p>
          <p>（スターください。PRも歓迎です）</p>
          <h3>何に使える？</h3>
          <p>たとえば、</p>
          <ul>
            <li>社内ドキュメントをホスティングした時に、OAuth2で保護したい。</li>
            <li>Globalにテスト用のアプリケーションを作って内部のみに公開したいが、ip制限だけでなく、OAuthをかけたい</li>
          </ul>
          <p>などなど、対外向けのサービスで使うというより、内部向けのアプリや、情報を保護するための用途で使えます。</p>
          <h2>ことの発端</h2>
          <p>(読み飛ばして大丈夫です。)</p>
          <p><a href="https://techconf.cookpad.com/2018/">Cookpad Tech Conf 2018</a>で<strong>Challenges for Global Service from a Perspective of SRE</strong>の発表で、
            認証周りの業務が増えてがつらく、それをnginx側でoauthをproxyさせること脱Basic認証をし、管理するアプリケーションが増えても柔軟に対応できるようにした、
            と聞いた際に自分でもやってみようと思ったことが発端です。</p>
          <p>Coockpadさんの記事もありますので、これ以上はそちらを読んで下さい。</p>
          <ul>
            <li><a href="http://techlife.cookpad.com/entry/2015/10/16/080000">2015-10-16 nginx で omniauth を利用してアクセス制御を行う</a></li>
            <li><a href="https://github.com/sorah/nginx_omniauth_adapter">sorah/nginx_omniauth_adapter</a></li>
          </ul>
          <p>僕自身もBasic認証つれぇ、モダンにやりたい、って思ってたのでちょうどいいと思ってたところだったので、
            その辺のツール落ちていないか、というところから探してみました。</p>
          <p>そして、出会ったのが<a href="https://github.com/bitly/oauth2_proxy">oauth2_proxy</a>。
            色んな人がメンテナスしている + スター数が3k超えってところで使ってみようと思いました。</p>
          <p>日本語の記事を調べたところ、割と最近(今が2018/2なので)の記事も発見できました。</p>
          <ul>
            <li>2017/12/14 <a href="http://moznion.hatenadiary.com/entry/2017/12/14/230945">手っ取り早くウェブアプリケーションにOAuth2認証を導入する</a></li>
            <li>2017/04/05 <a href="https://qiita.com/minamijoyo/items/52041ff8628263355810">oauth2_proxyでRundeckにGitHub認証でログインする</a></li>
            <li>2016/01/18 <a href="http://lamanotrama.hateblo.jp/entry/2016/01/18/142116">oauth2_proxyとNginxのauth_requestを組み合わせると便利</a></li>
          </ul>
          <p>他にも次のコードも発見しました。</p>
          <ul>
            <li><a href="https://github.com/a5huynh/oauth2_proxy">a5huynh/oauth2_proxy</a></li>
          </ul>
          <p>ただ、欲しかった情報が</p>
          <ul>
            <li>わかりやすいサンプルコード</li>
            <li>Dockerを使っている</li>
            <li>複数のホストに対してOAuthが対応している</li>
          </ul>
          <p>だったので、どれも満たしていなかったので自分で作ることにしました。</p>
          <h2>実装内容</h2>
          <p>難しいことはしてませんが、以下の2点が他と異なるので、ここで取り上げます。</p>
          <ul>
            <li>redirect_urls</li>
            <li>Cookie対策</li>
          </ul>
          <p>また、以下では冒頭のアーキテクチャ図にある名称で説明します。</p>
          <h3>redirect_urls</h3>
          <p>Providerのredirect_url<strong>s</strong>を複数指定すること。
            コード風にかくと、</p><pre class="language-plain"><code class="language-plain">redirect_urls = [
    &#x27;server-a.example.com&#x27;,
    &#x27;server-b.example.com&#x27;
]
</code></pre>
          <p>と言った具合です。</p><pre class="language-plain"><code class="language-plain">Providerによっては複数の入力欄があったり、カンマ区切りで入力したりさまざまなので、
そこは個々の入力方法を確認して下さい。
</code></pre>
          <h3>Cookie対策</h3>
          <p>実行ファイル、<code>google_auth_proxy</code>がとる引数で<code>--cookie-domain</code>があるのですが(<a href="https://github.com/Himenon/oauth2_proxy/blob/master/oauth2_proxy/run.sh#L12">この部分</a>)、
            ここをサブドメインを含めずに書きます。
            つまり、<code>--cookie-domain=example.com</code>とし、server-aでもserver-bでも同じCookieを利用するようにします。</p>
          <p>このようにすることで、CORSがコケることなく、複数のサブドメインで認証できます。</p><pre class="language-plain"><code class="language-plain">無論、この手は普通やらないと思いますし、何が起こるかわからないので、
実際のサービスとしては使ってはいけません。

これは、内部向けだったり、用途が限られた空間内でBasic認証などによる不必要な認証管理をするための1手段としては有効なので、
このProxyを噛ませるアプリケーションの公開範囲をキチンと管理できた上で利用するならば有効な手だと思います。
</code></pre>
          <h3>課題（TODO）</h3>
          <p>Cookie Domainを明確に単一にすることが現状の課題です。
            これは2つのことを解決します。</p>
          <p>1つ目は先に上げたCORSの問題です。
            例えば<code>proxy.example.com</code>のように、現状の<code>*.example.com</code>よりも狭い範囲でCookieが利用されている方が
            サブドメインで分けられた、他のアプリケーションが不必要なCookieをロードする必要がなくなります。</p>
          <p>2つ目は、redirect_urlsの問題です。
            一見、問題がなささそうに見えますがそうではありません。
            redirect_urlsはどこに・誰が登録しますか？
            リバースプロキシする対象が増減たびに、Providerのredirect_urlsを更新する必要があります。</p>
          <p>これはオペレーションミスの可能性を含んでいますし、
            実装者はnginxの調整以外に、Providerの管理者に更新依頼をするというプロセスが増えてしまいます。</p>
          <h4>理想</h4>
          <p>理想のフローは次のような手順です(ざっくり)</p>
          <div class="mermaid">sequenceDiagram Browser-&gt;&gt;Nginx: request(a.example.com) Nginx-&gt;&gt;oauth2_proxy: proxy(proxy.example.com/oauth2/auth) oauth2_proxy-&gt;&gt;Provider: request Provider-&gt;&gt;Nginx: response(redirect: proxy.example.com) Nginx-&gt;&gt;Backend: Reverse Proxy (a.example.com)</div>
          <p>これが解決できたらまた更新しようと思います。</p>
        </section>
      </div>
    </body>
  </body>

</html>