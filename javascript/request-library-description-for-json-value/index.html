<html>

  <head lang="ja">
    <title>nodeのrequestライブラリの`json`オプションの取り扱いについて</title>
    <meta charSet="utf-8" />
    <meta name="keywords" content="nodejs,typescript,python,himenon,web,frontend" />
    <meta name="description" content="早くが画面から出たい人の備忘録。" />
    <meta name="copyright" content="@Himenon" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Himenon" />
    <meta property="og:title" content="nodeのrequestライブラリの`json`オプションの取り扱いについて" />
    <meta property="og:url" content="https://himenon.github.io/javascript/request-library-description-for-json-value" />
    <meta property="og:description" content="早くが画面から出たい人の備忘録。" />
    <meta property="og:image" content="https://himenon.github.io" />
    <meta name="viewport" content="initial-scale=1,minimum-scale=0.5,user-scalable=no" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600,800?aa390" rel="stylesheet" />
    <link href="/lib/prism.css?c4d0b" rel="stylesheet" />
    <link href="/assets/stylesheets/styles.css?a89e9" rel="stylesheet" />
    <script>
      (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-55455343-7', 'auto');
      ga('send', 'pageview');
    </script>
    <script id="csr-props" data-csr-props="{&quot;htmlMetaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;nodeのrequestライブラリの`json`オプションの取り扱いについて&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[],&quot;createdAt&quot;:&quot;2018-04-09T03:32:29.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;nodeのrequestライブラリの`json`オプションの取り扱いについて&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/javascript/request-library-description-for-json-value&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早くが画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io&quot;}]}},&quot;page&quot;:{&quot;uri&quot;:&quot;/javascript/request-library-description-for-json-value&quot;,&quot;content&quot;:&quot;\n## TL;DR\n\nつべこべいわず、該当コード見たほうが早い\n\n- &lt;https://github.com/request/request/blob/master/request.js#L1278-L1313&gt;\n\nコードを読んでもわからなかったら続きをどうぞ。\n\n## 簡単に調べてみた\n\n知人が、nodeのHTTP Clientである[reuqest](https://github.com/request/request)をPOST時に利用したときに、\n`json: true`のoptionがあるけど、`body`がjsonかされないっていう話を聞いたので、調べてみた。\n\n- [https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request](https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request)\n- [send Content-Type: application/json post with node.js](https://stackoverflow.com/questions/8675688/send-content-type-application-json-post-with-node-js)\n\nどうやら、optionの`json`にBooleanではなく、直接Objectを渡したほうが早い。\n\n## 実装コードから調べてみた\n\n### オプションの`json`をどうのように取り扱っているか\n\n冒頭でも紹介した&lt;https://github.com/request/request/blob/master/request.js#L1278-L1313&gt;である。\n\nいろいろぶっ飛ばして、\n\n```js\nRequest.prototype.json = function (val) {\n  var self = this\n\n  // 中略\n\n  self._json = true\n  if (typeof val === &#x27;boolean&#x27;) {\n    // jsonオプションの値がbooleanの場合\n    if (self.body !== undefined) {\n      // bodyがundefinedでなけれあば\n      if (!/^application\\/x-www-form-urlencoded\\b/.test(self.getHeader(&#x27;content-type&#x27;))) {\n        // content-typeが application/x-www-form-urlencoded とマッチした倍、\n        // https://github.com/request/request/blob/master/lib/helpers.js#L20-L28\n        self.body = safeStringify(self.body, self._jsonReplacer)\n      } else {\n        // rfc3986でエンコード\n        // https://github.com/request/request/blob/master/lib/querystring.js#L42-L46\n        self.body = self._qs.rfc3986(self.body)\n      }\n      if (!self.hasHeader(&#x27;content-type&#x27;)) {\n        // content-typeが指定されていなければ、application/jsonに指定\n        self.setHeader(&#x27;content-type&#x27;, &#x27;application/json&#x27;)\n      }\n    }\n} else {\n    // jsonがbooleanでないとき \n    // bodyに入れ直していますね。\n    self.body = safeStringify(val, self._jsonReplacer)\n    if (!self.hasHeader(&#x27;content-type&#x27;)) {\n      // content-typeが指定されていなければ、application/jsonに指定\n      self.setHeader(&#x27;content-type&#x27;, &#x27;application/json&#x27;)\n    }\n  }\n\n  return self\n}\n```\n\nこれで謎は解けました。\n`rfc3986`が出てきたのですが、別の章で紹介。\n\n### もっと詳しく見てみる\n\n渋川さんの記事が大変参考になります。\n読んでいた当時はよくわからなかったのですが、今となっては噛み締めて読めますね。。。\nRFC大事。\n\n- [encodeURIComponentが世界基準だと誤解してた話](https://qiita.com/shibukawa/items/c0730092371c0e243f62)\n- [encodeURIComponent() - MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)\n- [encodeURIComponent() - demo](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)\n\nRFC3986に厳格に対応したライブラリ\n\n- [ljharb/qs](https://github.com/ljharb/qs)\n    - [Query String - Node.js v9.11.1 Documentation](https://nodejs.org/api/querystring.html)\n    - requests内部で利用されていますね\n\nRFC3986関連\n\n- [RFC3986 日本語訳の複製](https://triple-underscore.github.io/RFC3986-ja.html)\n- [URIに使ってよい文字の話 - RFC2396 と RFC3986](http://freak-da.hatenablog.com/entry/20080321/p1)\n- [RFC3986を読みながらURLエンコードについて考えた](http://info-i.net/rfc3986-url)\n&quot;,&quot;metaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;nodeのrequestライブラリの`json`オプションの取り扱いについて&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[],&quot;createdAt&quot;:&quot;2018-04-09T03:32:29.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-21T11:22:01.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;nodeのrequestライブラリの`json`オプションの取り扱いについて&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/javascript/request-library-description-for-json-value&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早くが画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io&quot;}]}},&quot;ext&quot;:&quot;.md&quot;,&quot;filename&quot;:&quot;src/javascript/request-library-description-for-json-value.md&quot;,&quot;name&quot;:&quot;javascript/request-library-description-for-json-value&quot;,&quot;raw&quot;:&quot;---\ntitle: \&quot;nodeのrequestライブラリの`json`オプションの取り扱いについて\&quot;\ncreatedAt: 2018-04-09 03:32:29\nupdatedAt: 2019-05-21 11:22:01\n---\n\n## TL;DR\n\nつべこべいわず、該当コード見たほうが早い\n\n- &lt;https://github.com/request/request/blob/master/request.js#L1278-L1313&gt;\n\nコードを読んでもわからなかったら続きをどうぞ。\n\n## 簡単に調べてみた\n\n知人が、nodeのHTTP Clientである[reuqest](https://github.com/request/request)をPOST時に利用したときに、\n`json: true`のoptionがあるけど、`body`がjsonかされないっていう話を聞いたので、調べてみた。\n\n- [https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request](https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request)\n- [send Content-Type: application/json post with node.js](https://stackoverflow.com/questions/8675688/send-content-type-application-json-post-with-node-js)\n\nどうやら、optionの`json`にBooleanではなく、直接Objectを渡したほうが早い。\n\n## 実装コードから調べてみた\n\n### オプションの`json`をどうのように取り扱っているか\n\n冒頭でも紹介した&lt;https://github.com/request/request/blob/master/request.js#L1278-L1313&gt;である。\n\nいろいろぶっ飛ばして、\n\n```js\nRequest.prototype.json = function (val) {\n  var self = this\n\n  // 中略\n\n  self._json = true\n  if (typeof val === &#x27;boolean&#x27;) {\n    // jsonオプションの値がbooleanの場合\n    if (self.body !== undefined) {\n      // bodyがundefinedでなけれあば\n      if (!/^application\\/x-www-form-urlencoded\\b/.test(self.getHeader(&#x27;content-type&#x27;))) {\n        // content-typeが application/x-www-form-urlencoded とマッチした倍、\n        // https://github.com/request/request/blob/master/lib/helpers.js#L20-L28\n        self.body = safeStringify(self.body, self._jsonReplacer)\n      } else {\n        // rfc3986でエンコード\n        // https://github.com/request/request/blob/master/lib/querystring.js#L42-L46\n        self.body = self._qs.rfc3986(self.body)\n      }\n      if (!self.hasHeader(&#x27;content-type&#x27;)) {\n        // content-typeが指定されていなければ、application/jsonに指定\n        self.setHeader(&#x27;content-type&#x27;, &#x27;application/json&#x27;)\n      }\n    }\n} else {\n    // jsonがbooleanでないとき \n    // bodyに入れ直していますね。\n    self.body = safeStringify(val, self._jsonReplacer)\n    if (!self.hasHeader(&#x27;content-type&#x27;)) {\n      // content-typeが指定されていなければ、application/jsonに指定\n      self.setHeader(&#x27;content-type&#x27;, &#x27;application/json&#x27;)\n    }\n  }\n\n  return self\n}\n```\n\nこれで謎は解けました。\n`rfc3986`が出てきたのですが、別の章で紹介。\n\n### もっと詳しく見てみる\n\n渋川さんの記事が大変参考になります。\n読んでいた当時はよくわからなかったのですが、今となっては噛み締めて読めますね。。。\nRFC大事。\n\n- [encodeURIComponentが世界基準だと誤解してた話](https://qiita.com/shibukawa/items/c0730092371c0e243f62)\n- [encodeURIComponent() - MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)\n- [encodeURIComponent() - demo](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)\n\nRFC3986に厳格に対応したライブラリ\n\n- [ljharb/qs](https://github.com/ljharb/qs)\n    - [Query String - Node.js v9.11.1 Documentation](https://nodejs.org/api/querystring.html)\n    - requests内部で利用されていますね\n\nRFC3986関連\n\n- [RFC3986 日本語訳の複製](https://triple-underscore.github.io/RFC3986-ja.html)\n- [URIに使ってよい文字の話 - RFC2396 と RFC3986](http://freak-da.hatenablog.com/entry/20080321/p1)\n- [RFC3986を読みながらURLエンコードについて考えた](http://info-i.net/rfc3986-url)\n&quot;},&quot;site&quot;:{&quot;title&quot;:&quot;himenon.github.io&quot;,&quot;description&quot;:&quot;早くが画面から出たい人の備忘録。&quot;,&quot;baseUri&quot;:&quot;/&quot;,&quot;baseUrl&quot;:&quot;https://himenon.github.io&quot;}}"></script>
  </head>

  <body>

    <body>
      <div>
        <nav id="nav-bar">
          <div id="nav-bar-container"><a href="/">TOP</a></div>
        </nav>
        <header id="site-header">
          <div id="site-header-container">
            <h1 id="page-title">nodeのrequestライブラリの`json`オプションの取り扱いについて</h1>
            <p id="page-description">早くが画面から出たい人の備忘録。</p>
            <p id="article-time"><span id="posted-at__label">投稿日</span><time>2018-04-09 12:32:29</time><span id="created-at__label">更新日</span><time>2019-05-21 08:22:01</time></p>
          </div>
        </header>
      </div>
      <div class="wrapper">
        <section>
          <h2>TL;DR</h2>
          <p>つべこべいわず、該当コード見たほうが早い</p>
          <ul>
            <li><a href="https://github.com/request/request/blob/master/request.js#L1278-L1313">https://github.com/request/request/blob/master/request.js#L1278-L1313</a></li>
          </ul>
          <p>コードを読んでもわからなかったら続きをどうぞ。</p>
          <h2>簡単に調べてみた</h2>
          <p>知人が、nodeのHTTP Clientである<a href="https://github.com/request/request">reuqest</a>をPOST時に利用したときに、
            <code>json: true</code>のoptionがあるけど、<code>body</code>がjsonかされないっていう話を聞いたので、調べてみた。</p>
          <ul>
            <li><a href="https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request">https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request</a></li>
            <li><a href="https://stackoverflow.com/questions/8675688/send-content-type-application-json-post-with-node-js">send Content-Type: application/json post with node.js</a></li>
          </ul>
          <p>どうやら、optionの<code>json</code>にBooleanではなく、直接Objectを渡したほうが早い。</p>
          <h2>実装コードから調べてみた</h2>
          <h3>オプションの<code>json</code>をどうのように取り扱っているか</h3>
          <p>冒頭でも紹介した<a href="https://github.com/request/request/blob/master/request.js#L1278-L1313">https://github.com/request/request/blob/master/request.js#L1278-L1313</a>である。</p>
          <p>いろいろぶっ飛ばして、</p><pre class="language-js"><code class="language-js"><span class="token class-name">Request</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">json</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>

  <span class="token comment">// 中略</span>

  self<span class="token punctuation">.</span>_json <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// jsonオプションの値がbooleanの場合</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>body <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// bodyがundefinedでなけれあば</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^application\/x-www-form-urlencoded\b/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// content-typeが application/x-www-form-urlencoded とマッチした倍、</span>
        <span class="token comment">// https://github.com/request/request/blob/master/lib/helpers.js#L20-L28</span>
        self<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">safeStringify</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>body<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_jsonReplacer<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// rfc3986でエンコード</span>
        <span class="token comment">// https://github.com/request/request/blob/master/lib/querystring.js#L42-L46</span>
        self<span class="token punctuation">.</span>body <span class="token operator">=</span> self<span class="token punctuation">.</span>_qs<span class="token punctuation">.</span><span class="token function">rfc3986</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">hasHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// content-typeが指定されていなければ、application/jsonに指定</span>
        self<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// jsonがbooleanでないとき </span>
    <span class="token comment">// bodyに入れ直していますね。</span>
    self<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token function">safeStringify</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_jsonReplacer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">hasHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// content-typeが指定されていなければ、application/jsonに指定</span>
      self<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> self
<span class="token punctuation">}</span>
</code></pre>
          <p>これで謎は解けました。
            <code>rfc3986</code>が出てきたのですが、別の章で紹介。</p>
          <h3>もっと詳しく見てみる</h3>
          <p>渋川さんの記事が大変参考になります。
            読んでいた当時はよくわからなかったのですが、今となっては噛み締めて読めますね。。。
            RFC大事。</p>
          <ul>
            <li><a href="https://qiita.com/shibukawa/items/c0730092371c0e243f62">encodeURIComponentが世界基準だと誤解してた話</a></li>
            <li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent() - MDN</a></li>
            <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent() - demo</a></li>
          </ul>
          <p>RFC3986に厳格に対応したライブラリ</p>
          <ul>
            <li><a href="https://github.com/ljharb/qs">ljharb/qs</a>
              <ul>
                <li><a href="https://nodejs.org/api/querystring.html">Query String - Node.js v9.11.1 Documentation</a></li>
                <li>requests内部で利用されていますね</li>
              </ul>
            </li>
          </ul>
          <p>RFC3986関連</p>
          <ul>
            <li><a href="https://triple-underscore.github.io/RFC3986-ja.html">RFC3986 日本語訳の複製</a></li>
            <li><a href="http://freak-da.hatenablog.com/entry/20080321/p1">URIに使ってよい文字の話 - RFC2396 と RFC3986</a></li>
            <li><a href="http://info-i.net/rfc3986-url">RFC3986を読みながらURLエンコードについて考えた</a></li>
          </ul>
        </section>
      </div>
    </body>
  </body>

</html>