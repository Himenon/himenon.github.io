<html>

  <head lang="ja">
    <title>JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介</title>
    <meta charSet="utf-8" />
    <meta name="keywords" content="JavaScript,TypeScript,設計,Vue.js,dependency-cruiser" />
    <meta name="description" content="js、tsのファイル間の依存関係を可視化するツールについて紹介します。" />
    <meta name="copyright" content="@Himenon" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Himenon" />
    <meta property="og:title" content="JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介" />
    <meta property="og:url" content="https://himenon.github.io/javascript/introduction-code-dependency" />
    <meta property="og:description" content="js、tsのファイル間の依存関係を可視化するツールについて紹介します。" />
    <meta property="og:image" content="https://himenon.github.io/assets/images/miku.png" />
    <meta name="viewport" content="initial-scale=1,minimum-scale=0.5,user-scalable=no" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/miku.png?5e6a9" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png?cf132" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png?194f5" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600,800?c7772" rel="stylesheet" />
    <link href="/lib/prism.css?b337f" rel="stylesheet" />
    <link href="/assets/stylesheets/styles.css?bf112" rel="stylesheet" />
    <script>
      (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-55455343-7', 'auto');
      ga('send', 'pageview');
    </script>
    <script id="csr-props" data-csr-props="{&quot;htmlMetaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介&quot;,&quot;description&quot;:&quot;js、tsのファイル間の依存関係を可視化するツールについて紹介します。&quot;,&quot;keywords&quot;:&quot;JavaScript,TypeScript,設計,Vue.js,dependency-cruiser&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2020-02-08T21:00:00.000Z&quot;,&quot;updatedAt&quot;:&quot;2020-03-26T00:15:00.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/javascript/introduction-code-dependency&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;js、tsのファイル間の依存関係を可視化するツールについて紹介します。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;page&quot;:{&quot;uri&quot;:&quot;/javascript/introduction-code-dependency&quot;,&quot;content&quot;:&quot;\n\n[![index.png](./images/code-dependency-thumbnail.png)](https://himenon.github.io/code-dependency/project/src/)\n\n**追記情報**\n\n* v0.5.0で`.vue`の拡張子もサポートするようになりました。\n\n# はじめに\n\n現在のJavaScriptは`export`、`import`によるモジュールの切り離しと結合が可能であるため。大きなプロジェクトに成長させることができます。\n\n実装が進むにつれてファイル間の依存が複雑になっていき、実装全体の依存関係を把握するのが難しくなっていきます。これはプロジェクトに対して新しいメンバーが増えたときに、コードリーディングの時間を十分に取る必要があります。また、OSSのライブラリに貢献したいときも同様の状況が生まれるでしょう。特に後者は開発メンバーが近くにいるとも限らず、他国の方である可能性も十分に高いため開発に参加するための準備が必要になります。\n\nこのような、全体の依存関係の設計を見直したい場合や、新たに開発に参画する場合により短時間に理解を深めるためのツールを作成したので紹介します。\n\n## [@code-dependency](https://github.com/Himenon/code-dependency)の紹介\n\n### DEMO\n\n**百聞は一見にしかず**と言われるので、DEMOページをご覧ください。code-dependencyは次のような依存関係の表示を生成することができます。\n\n* https://himenon.github.io/code-dependency/project/src/\n\n### @code-dependencyを利用する\n\n次に実際に@code-dependencyを利用してみましょう。まずはyarn/npmを利用して[@code-dependency/cli](https://www.npmjs.com/package/@code-dependency/cli)インストールします。\n\n```bash\n# npmを使っている人\nnpm i -g @code-dependency/cli@latest\n# yarnを使っている人\nyarn global add @code-dependency/cli@latest\n```\n\n例として[yargs/yargs](https://github.com/yargs/yargs)の依存関係を覗いてみます。\n\n```bash\ngit clone https://github.com/yargs/yargs.git --depth 1\ncd yargs\n\ncode-dependency --source ./\n\n# http://localhost:3000/project を開きます\n```\n\nブラウザを開いてみます。ページ左側に走査して取得したファイルツリーが表示されます(.js,.jsx,.ts,.tsx,.vueを対象とします)。\n\nメニューから`yargs/index.js`を選択すると以下のような表示になります。\n\n![yargsの例](./images/code-dependency-yargs-example.png)\n\nURLの例: http://localhost:3000/project/?pathname=yargs%2Findex.js\n\n可視化によってファイルの依存関係が一目瞭然となります。\n\n### ユースケース\n\n依存関係の可視化をしただけなので、ここから何を読み取るかは利用者の自由です。例えば、\n\n* Model/View/Controllerを利用したアーキテクチャが設計通りに参照構造を持っていることを確認する\n* ファイル間の循環参照（例：a.js-&gt;b.js-&gt;c.js-&gt;a.js)をしていないことを確認する\n* SOLIDの原則に従っているか確認する（インターフェース分離の原則がわかりやすい）\n* 新機能を追加するときの依存パターンに既出のものがないか確認する\n* チーム内で依存関係の設計の認識合わせをする\n\nなどが挙げられます。メンテナンスされているコードや有名なライブラリ（[angular.js](https://github.com/angular/angular.js/), [react](https://github.com/facebook/react), [vscode](https://github.com/microsoft/vscode), etc...）を観察してみて依存関係の研究に勤しむのもよいかもしれません。（他に考えつく利用用途があればぜひコメントで教えて下さい！）\n\n## 機能紹介\n\n[@code-dependency/cliのREADME](https://github.com/Himenon/code-dependency/tree/master/packages/cli#option)に利用可能な機能は書いています。\ntsconfigやwebpackを指定できる他、静的にホスティングできるようにHTMLを出力する機能も搭載しています。\n\n### 静的にホスティングする\n\nサンプルとして、`@code-dependency/cli`自体の依存関係を以下にホスティングしています。\n\n* https://himenon.github.io/code-dependency/project/src/\n\nこの出力は次のようなCLIを叩くことで出力されます。\n\n```bash\n# current directoryはcode-dependency/packages/cli\ncode-dependency --source ./src --exclude node_modules --export-static ./docs --public-path https://himenon.github.io/code-dependency/\n```\n\n#### 余談\n\nこれは完全に余談ですが、GitHub Pagesにホスティングした状態でLighthouseの結果は以下のとおりです。静的のホスティングされた状態でも快適に使えるように実装しました。\n\n![performance](./images/code-dependency-perf.png)\n\n### dotからSVGに変換するエンジンを変更する\n\nデフォルトのまま利用した場合、[viz.js](https://www.npmjs.com/package/viz.js/v/2.1.2)を利用してブラウザ側でdot言語をSVGに変換しています。ただこれには欠点があり、viz.jsはMemory Leakしています。依存関係が数百を超えたあたり（具体的にはdot言語で処理するテキストが100KBのオーダーを超えたあたり）からviz.jsでは処理しきれなくなります。\n\nこれを避けるために、NativeのGraphvizを利用することで上限を緩和することができます。\nGraphvizの公式サイト(&lt;http://www.graphviz.org&gt;)からマシンにインストールして、`dot`コマンドが利用できる状態にしておいてください。\n\nこの状態で、`--engine dot`のフラグを追加して起動すると、viz.jsを利用しない代わりに、NativeのgraphvizがSVGを生成します。\n\n```bash\ncode-dependency --source ./src --engine dot\n```\n\nviz.jsはすでにメンテナンスされていない状態なので、Nativeにインストールされているものを利用することをおすすめします。\n\n### 既知の不具合について\n\nNativenのdotエンジンを利用していてもSVGが生成されないことがあります。これはNodeJS側のHeap Mmoeryが足りなくなる場合に以下のようなエラーを起こします。\n\n```\nFATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory\n```\n\nNode v12以降であればHeapの最大値がハードウェアに依存して変化するので、大規模なプロジェクトでなければそこまで心配ないかもしれません。\n\n## code-dependencyが提供するAPIについて\n\ncode-dependency自体は特にAPIを提供することはしていません。内部で[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)が吐き出すdot言語をSVGに変換し、WEBブラウザ上で容易に確認できるようにしたに過ぎません。\n\n依存関係のテストや詳細な情報を取得したい場合は[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)を直接利用すると良いでしょう。\n\n## 最後に\n\n着想自体は2019年4月あたりにあり、一時は自分でASTを解析してd3jsで依存関係の可視化までフルスクラッチでやっていましたが、対応すべき内容が多くなりメンテナスコストが高くなったため、[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)を利用する形にしました。もしこのライブラリがなければ、code-dependencyが誕生しなかったので、ぜひ[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)にスターをつけてあげてください。\n\nまた、code-dependencyの機能自体は大体出揃っており、これほしいな、と思う限り今後の更新頻度は減少ることと思います。その前に宣伝効果の高そうなQiitaに一つ記事を書いてシェアしておこうと思った次第です。もし、既存の状態からより効率的な依存関係の把握や情報共有の方法がありましたらIssueやPull Requestを投げてくださると幸いです。\n\n今回のライブラリのより技術的な話は自分のブログの方に掲載していくかもしれません。興味のある方は足を運んでみてください。\n\n* https://himenon.github.io/\n\n## 関連するライブラリなどの紹介\n\n### dependents-view\n\nURL: https://github.com/Himenon/dependents-view\nDEMO: https://himenon.github.io/dependents-view/#packages\n\nnpmライブラリの逆依存関係をGitHubもしくはGitHub Enterpriseから収集し、まとめ直すアプリケーション（自分でビルドする必要がある）。内容としてはGitHubのNetwork Graphと同様ですが、内容をフィルタリングして利用する機能を持っています。自分のライブラリを変更した場合にどのライブラリまで影響を及ぼすか、を検索することができます。\n\n### libcheck\n\nURL: https://github.com/Himenon/node-libcheck\n\nyarn.lock（package-lock.jsonは非対応）からライブラリが複数バージョンインストールされていないかチェックするライブラリ。\n\n例1：利用するライブラリの`dependencies`にreactのv15系がインストールされていて、アプリケーション側がdependenciesでreact v16がインストールされているような場合、両方ともnode_modulesに配置されます。これを検出できます。\n\n例2：モノレポのようなpackage.jsonを複数扱う場合にdependenciesの更新漏れをチェックすることができます。\n\n```bash\n# インストール豊富お\nyarn add -D libcheck\n# 例えば、reactが複数バージョン入っていないかテストする方法\nlibcheck --input ./yarn.lock --pattern \&quot;react\&quot; --test\n```\n\n### このページで出てきたリンク一覧\n\n* https://himenon.github.io\n* https://github.com/Himenon/dependents-view\n* https://github.com/Himenon/code-dependency\n* https://github.com/Himenon/node-libcheck\n* https://github.com/sverweij/dependency-cruiser\n&quot;,&quot;metaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介&quot;,&quot;description&quot;:&quot;js、tsのファイル間の依存関係を可視化するツールについて紹介します。&quot;,&quot;keywords&quot;:&quot;JavaScript,TypeScript,設計,Vue.js,dependency-cruiser&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2020-02-08T21:00:00.000Z&quot;,&quot;updatedAt&quot;:&quot;2020-03-26T00:15:00.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/javascript/introduction-code-dependency&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;js、tsのファイル間の依存関係を可視化するツールについて紹介します。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;ext&quot;:&quot;.md&quot;,&quot;filename&quot;:&quot;src/javascript/introduction-code-dependency.md&quot;,&quot;name&quot;:&quot;javascript/introduction-code-dependency&quot;,&quot;raw&quot;:&quot;---\ntitle: \&quot;JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介\&quot;\ndescription: \&quot;js、tsのファイル間の依存関係を可視化するツールについて紹介します。\&quot;\nkeywords: \&quot;JavaScript,TypeScript,設計,Vue.js,dependency-cruiser\&quot;\ncreatedAt: 2020-02-08 21:00:00\nupdatedAt: 2020-03-26 00:15:00\n---\n\n\n[![index.png](./images/code-dependency-thumbnail.png)](https://himenon.github.io/code-dependency/project/src/)\n\n**追記情報**\n\n* v0.5.0で`.vue`の拡張子もサポートするようになりました。\n\n# はじめに\n\n現在のJavaScriptは`export`、`import`によるモジュールの切り離しと結合が可能であるため。大きなプロジェクトに成長させることができます。\n\n実装が進むにつれてファイル間の依存が複雑になっていき、実装全体の依存関係を把握するのが難しくなっていきます。これはプロジェクトに対して新しいメンバーが増えたときに、コードリーディングの時間を十分に取る必要があります。また、OSSのライブラリに貢献したいときも同様の状況が生まれるでしょう。特に後者は開発メンバーが近くにいるとも限らず、他国の方である可能性も十分に高いため開発に参加するための準備が必要になります。\n\nこのような、全体の依存関係の設計を見直したい場合や、新たに開発に参画する場合により短時間に理解を深めるためのツールを作成したので紹介します。\n\n## [@code-dependency](https://github.com/Himenon/code-dependency)の紹介\n\n### DEMO\n\n**百聞は一見にしかず**と言われるので、DEMOページをご覧ください。code-dependencyは次のような依存関係の表示を生成することができます。\n\n* https://himenon.github.io/code-dependency/project/src/\n\n### @code-dependencyを利用する\n\n次に実際に@code-dependencyを利用してみましょう。まずはyarn/npmを利用して[@code-dependency/cli](https://www.npmjs.com/package/@code-dependency/cli)インストールします。\n\n```bash\n# npmを使っている人\nnpm i -g @code-dependency/cli@latest\n# yarnを使っている人\nyarn global add @code-dependency/cli@latest\n```\n\n例として[yargs/yargs](https://github.com/yargs/yargs)の依存関係を覗いてみます。\n\n```bash\ngit clone https://github.com/yargs/yargs.git --depth 1\ncd yargs\n\ncode-dependency --source ./\n\n# http://localhost:3000/project を開きます\n```\n\nブラウザを開いてみます。ページ左側に走査して取得したファイルツリーが表示されます(.js,.jsx,.ts,.tsx,.vueを対象とします)。\n\nメニューから`yargs/index.js`を選択すると以下のような表示になります。\n\n![yargsの例](./images/code-dependency-yargs-example.png)\n\nURLの例: http://localhost:3000/project/?pathname=yargs%2Findex.js\n\n可視化によってファイルの依存関係が一目瞭然となります。\n\n### ユースケース\n\n依存関係の可視化をしただけなので、ここから何を読み取るかは利用者の自由です。例えば、\n\n* Model/View/Controllerを利用したアーキテクチャが設計通りに参照構造を持っていることを確認する\n* ファイル間の循環参照（例：a.js-&gt;b.js-&gt;c.js-&gt;a.js)をしていないことを確認する\n* SOLIDの原則に従っているか確認する（インターフェース分離の原則がわかりやすい）\n* 新機能を追加するときの依存パターンに既出のものがないか確認する\n* チーム内で依存関係の設計の認識合わせをする\n\nなどが挙げられます。メンテナンスされているコードや有名なライブラリ（[angular.js](https://github.com/angular/angular.js/), [react](https://github.com/facebook/react), [vscode](https://github.com/microsoft/vscode), etc...）を観察してみて依存関係の研究に勤しむのもよいかもしれません。（他に考えつく利用用途があればぜひコメントで教えて下さい！）\n\n## 機能紹介\n\n[@code-dependency/cliのREADME](https://github.com/Himenon/code-dependency/tree/master/packages/cli#option)に利用可能な機能は書いています。\ntsconfigやwebpackを指定できる他、静的にホスティングできるようにHTMLを出力する機能も搭載しています。\n\n### 静的にホスティングする\n\nサンプルとして、`@code-dependency/cli`自体の依存関係を以下にホスティングしています。\n\n* https://himenon.github.io/code-dependency/project/src/\n\nこの出力は次のようなCLIを叩くことで出力されます。\n\n```bash\n# current directoryはcode-dependency/packages/cli\ncode-dependency --source ./src --exclude node_modules --export-static ./docs --public-path https://himenon.github.io/code-dependency/\n```\n\n#### 余談\n\nこれは完全に余談ですが、GitHub Pagesにホスティングした状態でLighthouseの結果は以下のとおりです。静的のホスティングされた状態でも快適に使えるように実装しました。\n\n![performance](./images/code-dependency-perf.png)\n\n### dotからSVGに変換するエンジンを変更する\n\nデフォルトのまま利用した場合、[viz.js](https://www.npmjs.com/package/viz.js/v/2.1.2)を利用してブラウザ側でdot言語をSVGに変換しています。ただこれには欠点があり、viz.jsはMemory Leakしています。依存関係が数百を超えたあたり（具体的にはdot言語で処理するテキストが100KBのオーダーを超えたあたり）からviz.jsでは処理しきれなくなります。\n\nこれを避けるために、NativeのGraphvizを利用することで上限を緩和することができます。\nGraphvizの公式サイト(&lt;http://www.graphviz.org&gt;)からマシンにインストールして、`dot`コマンドが利用できる状態にしておいてください。\n\nこの状態で、`--engine dot`のフラグを追加して起動すると、viz.jsを利用しない代わりに、NativeのgraphvizがSVGを生成します。\n\n```bash\ncode-dependency --source ./src --engine dot\n```\n\nviz.jsはすでにメンテナンスされていない状態なので、Nativeにインストールされているものを利用することをおすすめします。\n\n### 既知の不具合について\n\nNativenのdotエンジンを利用していてもSVGが生成されないことがあります。これはNodeJS側のHeap Mmoeryが足りなくなる場合に以下のようなエラーを起こします。\n\n```\nFATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory\n```\n\nNode v12以降であればHeapの最大値がハードウェアに依存して変化するので、大規模なプロジェクトでなければそこまで心配ないかもしれません。\n\n## code-dependencyが提供するAPIについて\n\ncode-dependency自体は特にAPIを提供することはしていません。内部で[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)が吐き出すdot言語をSVGに変換し、WEBブラウザ上で容易に確認できるようにしたに過ぎません。\n\n依存関係のテストや詳細な情報を取得したい場合は[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)を直接利用すると良いでしょう。\n\n## 最後に\n\n着想自体は2019年4月あたりにあり、一時は自分でASTを解析してd3jsで依存関係の可視化までフルスクラッチでやっていましたが、対応すべき内容が多くなりメンテナスコストが高くなったため、[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)を利用する形にしました。もしこのライブラリがなければ、code-dependencyが誕生しなかったので、ぜひ[dependency-cruiser](https://github.com/sverweij/dependency-cruiser)にスターをつけてあげてください。\n\nまた、code-dependencyの機能自体は大体出揃っており、これほしいな、と思う限り今後の更新頻度は減少ることと思います。その前に宣伝効果の高そうなQiitaに一つ記事を書いてシェアしておこうと思った次第です。もし、既存の状態からより効率的な依存関係の把握や情報共有の方法がありましたらIssueやPull Requestを投げてくださると幸いです。\n\n今回のライブラリのより技術的な話は自分のブログの方に掲載していくかもしれません。興味のある方は足を運んでみてください。\n\n* https://himenon.github.io/\n\n## 関連するライブラリなどの紹介\n\n### dependents-view\n\nURL: https://github.com/Himenon/dependents-view\nDEMO: https://himenon.github.io/dependents-view/#packages\n\nnpmライブラリの逆依存関係をGitHubもしくはGitHub Enterpriseから収集し、まとめ直すアプリケーション（自分でビルドする必要がある）。内容としてはGitHubのNetwork Graphと同様ですが、内容をフィルタリングして利用する機能を持っています。自分のライブラリを変更した場合にどのライブラリまで影響を及ぼすか、を検索することができます。\n\n### libcheck\n\nURL: https://github.com/Himenon/node-libcheck\n\nyarn.lock（package-lock.jsonは非対応）からライブラリが複数バージョンインストールされていないかチェックするライブラリ。\n\n例1：利用するライブラリの`dependencies`にreactのv15系がインストールされていて、アプリケーション側がdependenciesでreact v16がインストールされているような場合、両方ともnode_modulesに配置されます。これを検出できます。\n\n例2：モノレポのようなpackage.jsonを複数扱う場合にdependenciesの更新漏れをチェックすることができます。\n\n```bash\n# インストール豊富お\nyarn add -D libcheck\n# 例えば、reactが複数バージョン入っていないかテストする方法\nlibcheck --input ./yarn.lock --pattern \&quot;react\&quot; --test\n```\n\n### このページで出てきたリンク一覧\n\n* https://himenon.github.io\n* https://github.com/Himenon/dependents-view\n* https://github.com/Himenon/code-dependency\n* https://github.com/Himenon/node-libcheck\n* https://github.com/sverweij/dependency-cruiser\n&quot;},&quot;site&quot;:{&quot;title&quot;:&quot;himenon.github.io&quot;,&quot;description&quot;:&quot;早く画面から出たい人の備忘録。&quot;,&quot;baseUri&quot;:&quot;/&quot;,&quot;baseUrl&quot;:&quot;https://himenon.github.io&quot;}}"></script>
  </head>

  <body>

    <body>
      <div>
        <nav id="nav-bar">
          <div id="nav-bar-container"><a href="/">TOP</a></div>
        </nav>
        <header id="site-header">
          <div id="site-header-container">
            <h1 id="page-title">JavaScript・TypeScriptのimport・exportの依存関係を可視化するcode-dependencyの紹介</h1>
            <p id="page-description">js、tsのファイル間の依存関係を可視化するツールについて紹介します。</p>
            <p id="article-time"><span id="posted-at__label">投稿日</span><time>2020-02-09 06:00:00</time><span id="created-at__label">更新日</span><time>2020-03-26 09:15:00</time></p>
          </div>
        </header>
      </div>
      <div class="wrapper">
        <section>
          <p><a href="https://himenon.github.io/code-dependency/project/src/"><img src="/javascript/images/code-dependency-thumbnail.png" alt="index.png" /></a></p>
          <p><strong>追記情報</strong></p>
          <ul>
            <li>v0.5.0で<code>.vue</code>の拡張子もサポートするようになりました。</li>
          </ul>
          <h1>はじめに</h1>
          <p>現在のJavaScriptは<code>export</code>、<code>import</code>によるモジュールの切り離しと結合が可能であるため。大きなプロジェクトに成長させることができます。</p>
          <p>実装が進むにつれてファイル間の依存が複雑になっていき、実装全体の依存関係を把握するのが難しくなっていきます。これはプロジェクトに対して新しいメンバーが増えたときに、コードリーディングの時間を十分に取る必要があります。また、OSSのライブラリに貢献したいときも同様の状況が生まれるでしょう。特に後者は開発メンバーが近くにいるとも限らず、他国の方である可能性も十分に高いため開発に参加するための準備が必要になります。</p>
          <p>このような、全体の依存関係の設計を見直したい場合や、新たに開発に参画する場合により短時間に理解を深めるためのツールを作成したので紹介します。</p>
          <h2><a href="https://github.com/Himenon/code-dependency">@code-dependency</a>の紹介</h2>
          <h3>DEMO</h3>
          <p><strong>百聞は一見にしかず</strong>と言われるので、DEMOページをご覧ください。code-dependencyは次のような依存関係の表示を生成することができます。</p>
          <ul>
            <li><a href="https://himenon.github.io/code-dependency/project/src/">https://himenon.github.io/code-dependency/project/src/</a></li>
          </ul>
          <h3>@code-dependencyを利用する</h3>
          <p>次に実際に@code-dependencyを利用してみましょう。まずはyarn/npmを利用して<a href="https://www.npmjs.com/package/@code-dependency/cli">@code-dependency/cli</a>インストールします。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># npmを使っている人</span>
<span class="token function">npm</span> i -g @code-dependency/cli@latest
<span class="token comment"># yarnを使っている人</span>
<span class="token function">yarn</span> global <span class="token function">add</span> @code-dependency/cli@latest
</code></pre>
          <p>例として<a href="https://github.com/yargs/yargs">yargs/yargs</a>の依存関係を覗いてみます。</p><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/yargs/yargs.git --depth 1
<span class="token function">cd</span> yargs

code-dependency --source ./

<span class="token comment"># http://localhost:3000/project を開きます</span>
</code></pre>
          <p>ブラウザを開いてみます。ページ左側に走査して取得したファイルツリーが表示されます(.js,.jsx,.ts,.tsx,.vueを対象とします)。</p>
          <p>メニューから<code>yargs/index.js</code>を選択すると以下のような表示になります。</p>
          <p><img src="/javascript/images/code-dependency-yargs-example.png" alt="yargsの例" /></p>
          <p>URLの例: <a href="http://localhost:3000/project/?pathname=yargs%2Findex.js">http://localhost:3000/project/?pathname=yargs%2Findex.js</a></p>
          <p>可視化によってファイルの依存関係が一目瞭然となります。</p>
          <h3>ユースケース</h3>
          <p>依存関係の可視化をしただけなので、ここから何を読み取るかは利用者の自由です。例えば、</p>
          <ul>
            <li>Model/View/Controllerを利用したアーキテクチャが設計通りに参照構造を持っていることを確認する</li>
            <li>ファイル間の循環参照（例：a.js-&gt;b.js-&gt;c.js-&gt;a.js)をしていないことを確認する</li>
            <li>SOLIDの原則に従っているか確認する（インターフェース分離の原則がわかりやすい）</li>
            <li>新機能を追加するときの依存パターンに既出のものがないか確認する</li>
            <li>チーム内で依存関係の設計の認識合わせをする</li>
          </ul>
          <p>などが挙げられます。メンテナンスされているコードや有名なライブラリ（<a href="https://github.com/angular/angular.js/">angular.js</a>, <a href="https://github.com/facebook/react">react</a>, <a href="https://github.com/microsoft/vscode">vscode</a>, etc...）を観察してみて依存関係の研究に勤しむのもよいかもしれません。（他に考えつく利用用途があればぜひコメントで教えて下さい！）</p>
          <h2>機能紹介</h2>
          <p><a href="https://github.com/Himenon/code-dependency/tree/master/packages/cli#option">@code-dependency/cliのREADME</a>に利用可能な機能は書いています。
            tsconfigやwebpackを指定できる他、静的にホスティングできるようにHTMLを出力する機能も搭載しています。</p>
          <h3>静的にホスティングする</h3>
          <p>サンプルとして、<code>@code-dependency/cli</code>自体の依存関係を以下にホスティングしています。</p>
          <ul>
            <li><a href="https://himenon.github.io/code-dependency/project/src/">https://himenon.github.io/code-dependency/project/src/</a></li>
          </ul>
          <p>この出力は次のようなCLIを叩くことで出力されます。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># current directoryはcode-dependency/packages/cli</span>
code-dependency --source ./src --exclude node_modules --export-static ./docs --public-path https://himenon.github.io/code-dependency/
</code></pre>
          <h4>余談</h4>
          <p>これは完全に余談ですが、GitHub Pagesにホスティングした状態でLighthouseの結果は以下のとおりです。静的のホスティングされた状態でも快適に使えるように実装しました。</p>
          <p><img src="/javascript/images/code-dependency-perf.png" alt="performance" /></p>
          <h3>dotからSVGに変換するエンジンを変更する</h3>
          <p>デフォルトのまま利用した場合、<a href="https://www.npmjs.com/package/viz.js/v/2.1.2">viz.js</a>を利用してブラウザ側でdot言語をSVGに変換しています。ただこれには欠点があり、viz.jsはMemory Leakしています。依存関係が数百を超えたあたり（具体的にはdot言語で処理するテキストが100KBのオーダーを超えたあたり）からviz.jsでは処理しきれなくなります。</p>
          <p>これを避けるために、NativeのGraphvizを利用することで上限を緩和することができます。
            Graphvizの公式サイト(<a href="http://www.graphviz.org">http://www.graphviz.org</a>)からマシンにインストールして、<code>dot</code>コマンドが利用できる状態にしておいてください。</p>
          <p>この状態で、<code>--engine dot</code>のフラグを追加して起動すると、viz.jsを利用しない代わりに、NativeのgraphvizがSVGを生成します。</p><pre class="language-bash"><code class="language-bash">code-dependency --source ./src --engine dot
</code></pre>
          <p>viz.jsはすでにメンテナンスされていない状態なので、Nativeにインストールされているものを利用することをおすすめします。</p>
          <h3>既知の不具合について</h3>
          <p>Nativenのdotエンジンを利用していてもSVGが生成されないことがあります。これはNodeJS側のHeap Mmoeryが足りなくなる場合に以下のようなエラーを起こします。</p><pre class="language-plain"><code class="language-plain">FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory
</code></pre>
          <p>Node v12以降であればHeapの最大値がハードウェアに依存して変化するので、大規模なプロジェクトでなければそこまで心配ないかもしれません。</p>
          <h2>code-dependencyが提供するAPIについて</h2>
          <p>code-dependency自体は特にAPIを提供することはしていません。内部で<a href="https://github.com/sverweij/dependency-cruiser">dependency-cruiser</a>が吐き出すdot言語をSVGに変換し、WEBブラウザ上で容易に確認できるようにしたに過ぎません。</p>
          <p>依存関係のテストや詳細な情報を取得したい場合は<a href="https://github.com/sverweij/dependency-cruiser">dependency-cruiser</a>を直接利用すると良いでしょう。</p>
          <h2>最後に</h2>
          <p>着想自体は2019年4月あたりにあり、一時は自分でASTを解析してd3jsで依存関係の可視化までフルスクラッチでやっていましたが、対応すべき内容が多くなりメンテナスコストが高くなったため、<a href="https://github.com/sverweij/dependency-cruiser">dependency-cruiser</a>を利用する形にしました。もしこのライブラリがなければ、code-dependencyが誕生しなかったので、ぜひ<a href="https://github.com/sverweij/dependency-cruiser">dependency-cruiser</a>にスターをつけてあげてください。</p>
          <p>また、code-dependencyの機能自体は大体出揃っており、これほしいな、と思う限り今後の更新頻度は減少ることと思います。その前に宣伝効果の高そうなQiitaに一つ記事を書いてシェアしておこうと思った次第です。もし、既存の状態からより効率的な依存関係の把握や情報共有の方法がありましたらIssueやPull Requestを投げてくださると幸いです。</p>
          <p>今回のライブラリのより技術的な話は自分のブログの方に掲載していくかもしれません。興味のある方は足を運んでみてください。</p>
          <ul>
            <li><a href="https://himenon.github.io/">https://himenon.github.io/</a></li>
          </ul>
          <h2>関連するライブラリなどの紹介</h2>
          <h3>dependents-view</h3>
          <p>URL: <a href="https://github.com/Himenon/dependents-view">https://github.com/Himenon/dependents-view</a>
            DEMO: <a href="https://himenon.github.io/dependents-view/#packages">https://himenon.github.io/dependents-view/#packages</a></p>
          <p>npmライブラリの逆依存関係をGitHubもしくはGitHub Enterpriseから収集し、まとめ直すアプリケーション（自分でビルドする必要がある）。内容としてはGitHubのNetwork Graphと同様ですが、内容をフィルタリングして利用する機能を持っています。自分のライブラリを変更した場合にどのライブラリまで影響を及ぼすか、を検索することができます。</p>
          <h3>libcheck</h3>
          <p>URL: <a href="https://github.com/Himenon/node-libcheck">https://github.com/Himenon/node-libcheck</a></p>
          <p>yarn.lock（package-lock.jsonは非対応）からライブラリが複数バージョンインストールされていないかチェックするライブラリ。</p>
          <p>例1：利用するライブラリの<code>dependencies</code>にreactのv15系がインストールされていて、アプリケーション側がdependenciesでreact v16がインストールされているような場合、両方ともnode_modulesに配置されます。これを検出できます。</p>
          <p>例2：モノレポのようなpackage.jsonを複数扱う場合にdependenciesの更新漏れをチェックすることができます。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># インストール豊富お</span>
<span class="token function">yarn</span> <span class="token function">add</span> -D libcheck
<span class="token comment"># 例えば、reactが複数バージョン入っていないかテストする方法</span>
libcheck --input ./yarn.lock --pattern <span class="token string">"react"</span> --test
</code></pre>
          <h3>このページで出てきたリンク一覧</h3>
          <ul>
            <li><a href="https://himenon.github.io">https://himenon.github.io</a></li>
            <li><a href="https://github.com/Himenon/dependents-view">https://github.com/Himenon/dependents-view</a></li>
            <li><a href="https://github.com/Himenon/code-dependency">https://github.com/Himenon/code-dependency</a></li>
            <li><a href="https://github.com/Himenon/node-libcheck">https://github.com/Himenon/node-libcheck</a></li>
            <li><a href="https://github.com/sverweij/dependency-cruiser">https://github.com/sverweij/dependency-cruiser</a></li>
          </ul>
        </section>
      </div>
    </body>
  </body>

</html>