<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="K.Himeno">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Zapierで利用可能なアプリをを時前で作成する - 技術の定点観測</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../assets/css/font.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Zapier\u3067\u5229\u7528\u53ef\u80fd\u306a\u30a2\u30d7\u30ea\u3092\u3092\u6642\u524d\u3067\u4f5c\u6210\u3059\u308b", url: "#zapier", children: [
              {title: "\u30c1\u30e5\u30fc\u30c8\u30ea\u30a2\u30eb", url: "#_1" },
              {title: "\u77e5\u3063\u3066\u304a\u304f\u3068\u4fbf\u5229\u306a\u3053\u3068", url: "#_2" },
              {title: "z\u3068bundle", url: "#zbundle" },
              {title: "authentication", url: "#authentication" },
              {title: "beforeRequest, afterResponse", url: "#beforerequest-afterresponse" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../assets/js/mermaid.min.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-55455343-7', 'himenon.github.io');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
    

    <h1 id="zapier">Zapierで利用可能なアプリをを時前で作成する<a class="headerlink" href="#zapier" title="Permanent link">&para;</a></h1>
<p id="created_at">作成日: <time datetime="2018-04-08T16:00">2018/04/08</time></p>

<p>Zapierは、様々なアプリケーションのイベントをトリガーとして、
同じ、もしくは他のアプリケーションのアクションを実行するハブ的なウェブサービスだ。</p>
<p>類似のサービスとしてIFTTTが存在する。</p>
<p>このZapierに載せるアプリをどうやって作れば良いのかまとめた。</p>
<h2 id="_1">チュートリアル<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>作成するに当たり、チュートリアルが存在する。まずはこれを見ておく。</p>
<ul>
<li><a href="https://zapier.com/developer/start/introduction">Zapier | The easiest way to automate your work | Zapier</a></li>
</ul>
<p>Githubのアプリを自前で作成する方法が書いてある。</p>
<p>次に最も見るであろうのドキュメントやサンプルは以下。</p>
<ul>
<li><a href="https://github.com/zapier/zapier-platform-cli">https://github.com/zapier/zapier-platform-cli</a></li>
<li><a href="https://www.npmjs.com/package/zapier-platform-cli">https://www.npmjs.com/package/zapier-platform-cli</a> npmでも同じ</li>
<li><a href="https://zapier.github.io/zapier-platform-cli/cli.html">https://zapier.github.io/zapier-platform-cli/cli.html</a></li>
<li><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md">https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md</a></li>
<li><a href="https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app">https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app</a></li>
</ul>
<p>ここに情報がほとんど載っているので、困ったときは立ち返ると良い。</p>
<h2 id="_2">知っておくと便利なこと<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li>Zapierの挙動はnode v6.10.3で検証すること</li>
<li>async/awaitを利用したい場合は<a href="https://babeljs.io/docs/usage/polyfill/"><code>babel-polyfill</code></a>を突っ込む。</li>
<li><a href="https://github.com/ciaranj/node-oauth">ciaranj/node-oauth</a>をasync/awaitもしくはPromiseとして利用したい場合、<a href="https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original"><code>promisify</code></a>を利用する。</li>
<li><code>promisify</code>はNode v8以降のライブラリなので、それ以前のNodeで利用するときは<code>util.promisify</code>パッケージをインストールする</li>
<li><code>z</code>オブジェクトと<code>bundle</code>オブジェクトについてソースコードを呼んでおく</li>
<li>非同期実行可能な場所が<code>middleware</code>のみであることを意識しておく</li>
</ul>
<p>細く見ていく</p>
<h3 id="node-oauth">node-oauthの話<a class="headerlink" href="#node-oauth" title="Permanent link">&para;</a></h3>
<p>Twitterでは<code>oauth_token</code>最初に取りに行き、<code>authorize</code>に行く際のクエリパラメータとして利用する。</p>
<pre><code>https://api.twitter.com/oauth/authorize?oauth_token=[OAUTH_TOKEN]
</code></pre>

<p><code>node-oauth</code>が提供しているメソッドは<code>callback</code>形式のメソッドであるため、
<code>promisify</code>を利用してPromise化しておく。</p>
<p>この際、<code>getOAuthRequestToken</code>はインスタンス化されたオブジェクトに対して実行されるため、
内部的に<code>this</code>が呼ばれている。そのため、オーバーライドした形で利用する。</p>
<pre><code class="js">import OAuth from 'oauth';
import util from 'util';

require('util.promisify').shim();

export const getOAuthToken = async () =&gt; {
    const oa = new OAuth.OAuth(
        'https://api.twitter.com/oauth/request_token',
        'https://api.twitter.com/oauth/access_token',
        process.env.CONSUMER_KEY,
        process.env.CONSUMER_SECRET,
        '1.0A',
        null,
        'HMAC-SHA1'
    );
    oa.getOAuthRequestToken = util.promisify(oa.getOAuthRequestToken); // override
    return await oa.getOAuthRequestToken();
};
</code></pre>

<h2 id="zbundle"><code>z</code>と<code>bundle</code><a class="headerlink" href="#zbundle" title="Permanent link">&para;</a></h2>
<p>ソースコードで、下記のものを熟読しておくことをオススメ。</p>
<ul>
<li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/create-command-handler.js">src/create-command-handler.js</a></li>
<li>Entrypoint</li>
<li>app, input (後にbundleになる)の注入</li>
<li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/execute.js">src/execute.js</a></li>
<li>各メソッドが実行される</li>
<li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/tools/promise.js">src/tools/promise.js</a></li>
<li>同期処理に落とし込んでいる</li>
<li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/execute-request.js">src/execute-request.js</a></li>
<li>Request系の同期処理</li>
<li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/app-middlewares/before/z-object.js">src/app-middlewres/before/z-object.js</a></li>
</ul>
<p><code>bundle</code>の値を確認する時、</p>
<ol>
<li><a href="https://zapier.com/developer">Zapier Developer</a>に行く</li>
<li>アプリを選択</li>
<li>MONITORINGを選択</li>
<li>Chartが表示されているので、該当箇所を選択</li>
<li><code>BUNDLE INFORMATION</code> という項目で確認できる。</li>
</ol>
<p>Errorを含んでいる場合は見れないので、注意。
<code>authorizeUrl</code>などでコケると見れる。具体的には次のようなJSONになっている</p>
<pre><code class="json">{
  &quot;authData&quot;: {},
  &quot;auth_data&quot;: {},
  &quot;auth_fields&quot;: {},
  &quot;environment&quot;: {},
  &quot;inputData&quot;: {
    &quot;_zapier_account_id&quot;: &quot;1234567&quot;,
    &quot;authorization_url&quot;: &quot;$func$2$f$&quot;,
    &quot;auto_refresh&quot;: false,
    &quot;client_id&quot;: &quot;None&quot;,
    &quot;client_secret&quot;: &quot;None&quot;,
    &quot;redirect_uri&quot;: &quot;https://zapier.com/dashboard/auth/oauth/return/xxxxxxxxxxx/&quot;,
    &quot;response_type&quot;: &quot;code&quot;,
    &quot;scope&quot;: null,
    &quot;state&quot;: &quot;11111111111111.22222222222&quot;
  },
  &quot;meta&quot;: {
    &quot;first_poll&quot;: false,
    &quot;frontend&quot;: false,
    &quot;hydrate&quot;: true,
    &quot;limit&quot;: -1,
    &quot;page&quot;: 0,
    &quot;prefill&quot;: false,
    &quot;standard_poll&quot;: true,
    &quot;test_poll&quot;: false
  }
}
</code></pre>

<h2 id="authentication">authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationschema">/AuthenticationSchema</a></p>
<h3 id="oauth2config">oauth2Config<a class="headerlink" href="#oauth2config" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationoauth2configschema">/AuthenticationOAuth2ConfigSchema</a></p>
<p>OAuth2に対応したAPIを提供しているウェブサービス(GithubやFacebook)であれば、
Zapierが提供されているものを利用するとよい。</p>
<p><code>authorizeUrl</code>で認証画面を通過した後、<code>getAccessToken</code>が実行される。</p>
<pre><code class="js">const oauth2Config = {
  authorizeUrl,       // 必須 Step 1
  getAccessToken,     // 必須 Step 2
  test,               // 必須
  refreshAccessToken, // 任意 401が返ってきた時に発火
  scope,              // 任意 
  autoRefresh,        // 任意 bool値
}
</code></pre>

<pre><code class="js">const getAccessToken= {
  method: 'POST',
  url: 'https://{{bundle.inputData.subdomain}}.example.com/api/v2/oauth2/token',
  body: {
    code: '{{bundle.inputData.code}}',
    client_id: '{{process.env.CLIENT_ID}}',
    client_secret: '{{process.env.CLIENT_SECRET}}',
    redirect_uri: '{{bundle.inputData.redirect_uri}}',
    grant_type: 'authorization_code'
  },
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded'
  }
}
</code></pre>

<h3 id="fields">fields<a class="headerlink" href="#fields" title="Permanent link">&para;</a></h3>
<p>Basic認証やDigest認証を行う時に、ユーザー名やパスワードを入力するときの、
入力画面を作成することが可能。</p>
<p>動的に、ドロップダウンの項目を追加することも可能。</p>
<h2 id="beforerequest-afterresponse">beforeRequest, afterResponse<a class="headerlink" href="#beforerequest-afterresponse" title="Permanent link">&para;</a></h2>
<p>該当ソースコード: <a href="https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares">https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares</a></p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../webapp/django/Add new app/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../webapp/django/Add new app/" class="btn btn-xs btn-link">
        Add new app
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../static-site-generator/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../static-site-generator/" class="btn btn-xs btn-link">
        静的サイトジェネレーターを選ぶとき、何を思ふ？
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>