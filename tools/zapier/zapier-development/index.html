<html>

  <head lang="ja">
    <title>Zapierで利用可能なアプリをを時前で作成する</title>
    <meta charSet="utf-8" />
    <meta name="keywords" content="nodejs,typescript,python,himenon,web,frontend" />
    <meta name="description" content="早く画面から出たい人の備忘録。" />
    <meta name="copyright" content="@Himenon" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@Himenon" />
    <meta property="og:title" content="Zapierで利用可能なアプリをを時前で作成する" />
    <meta property="og:url" content="https://himenon.github.io/tools/zapier/zapier-development" />
    <meta property="og:description" content="早く画面から出たい人の備忘録。" />
    <meta property="og:image" content="https://himenon.github.io/assets/images/miku.png" />
    <meta name="viewport" content="initial-scale=1,minimum-scale=0.5,user-scalable=no" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/miku.png?ade22" />
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png?193c1" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png?43a19" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:600,800?8a299" rel="stylesheet" />
    <link href="/lib/prism.css?47405" rel="stylesheet" />
    <link href="/assets/stylesheets/styles.css?ff578" rel="stylesheet" />
    <script>
      (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

      ga('create', 'UA-55455343-7', 'auto');
      ga('send', 'pageview');
    </script>
    <script id="csr-props" data-csr-props="{&quot;htmlMetaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;Zapierで利用可能なアプリをを時前で作成する&quot;,&quot;description&quot;:&quot;早く画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2018-04-08T05:47:15.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-26T11:09:53.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;Zapierで利用可能なアプリをを時前で作成する&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/tools/zapier/zapier-development&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早く画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;page&quot;:{&quot;uri&quot;:&quot;/tools/zapier/zapier-development&quot;,&quot;content&quot;:&quot;\n# Zapierで利用可能なアプリをを時前で作成する\n\n&lt;p id=\&quot;created_at\&quot;&gt;作成日: &lt;time dateTime=\&quot;2018-04-08T16:00\&quot;&gt;2018/04/08&lt;/time&gt;&lt;/p&gt;\n\nZapierは、様々なアプリケーションのイベントをトリガーとして、\n同じ、もしくは他のアプリケーションのアクションを実行するハブ的なウェブサービスだ。\n\n類似のサービスとしてIFTTTが存在する。\n\nこのZapierに載せるアプリをどうやって作れば良いのかまとめた。\n\n\n## チュートリアル\n\n作成するに当たり、チュートリアルが存在する。まずはこれを見ておく。\n\n- [Zapier | The easiest way to automate your work | Zapier](https://zapier.com/developer/start/introduction)\n\nGithubのアプリを自前で作成する方法が書いてある。\n\n次に最も見るであろうのドキュメントやサンプルは以下。\n\n- &lt;https://github.com/zapier/zapier-platform-cli&gt;\n  - &lt;https://www.npmjs.com/package/zapier-platform-cli&gt; npmでも同じ\n- &lt;https://zapier.github.io/zapier-platform-cli/cli.html&gt;\n- &lt;https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md&gt;\n- &lt;https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app&gt;\n\nここに情報がほとんど載っているので、困ったときは立ち返ると良い。\n\n## 知っておくと便利なこと\n\n- Zapierの挙動はnode v6.10.3で検証すること\n- async/awaitを利用したい場合は[`babel-polyfill`](https://babeljs.io/docs/usage/polyfill/)を突っ込む。\n- [ciaranj/node-oauth](https://github.com/ciaranj/node-oauth)をasync/awaitもしくはPromiseとして利用したい場合、[`promisify`](https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original)を利用する。\n- `promisify`はNode v8以降のライブラリなので、それ以前のNodeで利用するときは`util.promisify`パッケージをインストールする\n- `z`オブジェクトと`bundle`オブジェクトについてソースコードを呼んでおく\n- 非同期実行可能な場所が`middleware`のみであることを意識しておく\n\n細く見ていく\n\n### node-oauthの話\n\nTwitterでは`oauth_token`最初に取りに行き、`authorize`に行く際のクエリパラメータとして利用する。\n\n```\nhttps://api.twitter.com/oauth/authorize?oauth_token=[OAUTH_TOKEN]\n```\n\n`node-oauth`が提供しているメソッドは`callback`形式のメソッドであるため、\n`promisify`を利用してPromise化しておく。\n\nこの際、`getOAuthRequestToken`はインスタンス化されたオブジェクトに対して実行されるため、\n内部的に`this`が呼ばれている。そのため、オーバーライドした形で利用する。\n\n```js\nimport OAuth from &#x27;oauth&#x27;;\nimport util from &#x27;util&#x27;;\n\nrequire(&#x27;util.promisify&#x27;).shim();\n\nexport const getOAuthToken = async () =&gt; {\n    const oa = new OAuth.OAuth(\n        &#x27;https://api.twitter.com/oauth/request_token&#x27;,\n        &#x27;https://api.twitter.com/oauth/access_token&#x27;,\n        process.env.CONSUMER_KEY,\n        process.env.CONSUMER_SECRET,\n        &#x27;1.0A&#x27;,\n        null,\n        &#x27;HMAC-SHA1&#x27;\n    );\n    oa.getOAuthRequestToken = util.promisify(oa.getOAuthRequestToken); // override\n    return await oa.getOAuthRequestToken();\n};\n```\n\n\n## `z`と`bundle`\n\nソースコードで、下記のものを熟読しておくことをオススメ。\n\n- [src/create-command-handler.js](https://github.com/zapier/zapier-platform-core/blob/master/src/create-command-handler.js)\n  - Entrypoint\n  - app, input (後にbundleになる)の注入\n- [src/execute.js](https://github.com/zapier/zapier-platform-core/blob/master/src/execute.js)\n  - 各メソッドが実行される\n- [src/tools/promise.js](https://github.com/zapier/zapier-platform-core/blob/master/src/tools/promise.js)\n  - 同期処理に落とし込んでいる\n- [src/execute-request.js](https://github.com/zapier/zapier-platform-core/blob/master/src/execute-request.js)\n  - Request系の同期処理\n- [src/app-middlewres/before/z-object.js](https://github.com/zapier/zapier-platform-core/blob/master/src/app-middlewares/before/z-object.js)\n\n`bundle`の値を確認する時、\n\n1. [Zapier Developer](https://zapier.com/developer)に行く\n1. アプリを選択\n1. MONITORINGを選択\n1. Chartが表示されているので、該当箇所を選択\n1. `BUNDLE INFORMATION` という項目で確認できる。\n\nErrorを含んでいる場合は見れないので、注意。\n`authorizeUrl`などでコケると見れる。具体的には次のようなJSONになっている\n\n```json\n{\n  \&quot;authData\&quot;: {},\n  \&quot;auth_data\&quot;: {},\n  \&quot;auth_fields\&quot;: {},\n  \&quot;environment\&quot;: {},\n  \&quot;inputData\&quot;: {\n    \&quot;_zapier_account_id\&quot;: \&quot;1234567\&quot;,\n    \&quot;authorization_url\&quot;: \&quot;$func$2$f$\&quot;,\n    \&quot;auto_refresh\&quot;: false,\n    \&quot;client_id\&quot;: \&quot;None\&quot;,\n    \&quot;client_secret\&quot;: \&quot;None\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;https://zapier.com/dashboard/auth/oauth/return/xxxxxxxxxxx/\&quot;,\n    \&quot;response_type\&quot;: \&quot;code\&quot;,\n    \&quot;scope\&quot;: null,\n    \&quot;state\&quot;: \&quot;11111111111111.22222222222\&quot;\n  },\n  \&quot;meta\&quot;: {\n    \&quot;first_poll\&quot;: false,\n    \&quot;frontend\&quot;: false,\n    \&quot;hydrate\&quot;: true,\n    \&quot;limit\&quot;: -1,\n    \&quot;page\&quot;: 0,\n    \&quot;prefill\&quot;: false,\n    \&quot;standard_poll\&quot;: true,\n    \&quot;test_poll\&quot;: false\n  }\n}\n```\n\n## authentication\n\n[/AuthenticationSchema](https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationschema)\n\n### oauth2Config\n\n[/AuthenticationOAuth2ConfigSchema](https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationoauth2configschema)\n\n\nOAuth2に対応したAPIを提供しているウェブサービス(GithubやFacebook)であれば、\nZapierが提供されているものを利用するとよい。\n\n`authorizeUrl`で認証画面を通過した後、`getAccessToken`が実行される。\n\n\n```js\nconst oauth2Config = {\n  authorizeUrl,       // 必須 Step 1\n  getAccessToken,     // 必須 Step 2\n  test,               // 必須\n  refreshAccessToken, // 任意 401が返ってきた時に発火\n  scope,              // 任意 \n  autoRefresh,        // 任意 bool値\n}\n```\n\n```js\nconst getAccessToken= {\n  method: &#x27;POST&#x27;,\n  url: &#x27;https://{{bundle.inputData.subdomain}}.example.com/api/v2/oauth2/token&#x27;,\n  body: {\n    code: &#x27;{{bundle.inputData.code}}&#x27;,\n    client_id: &#x27;{{process.env.CLIENT_ID}}&#x27;,\n    client_secret: &#x27;{{process.env.CLIENT_SECRET}}&#x27;,\n    redirect_uri: &#x27;{{bundle.inputData.redirect_uri}}&#x27;,\n    grant_type: &#x27;authorization_code&#x27;\n  },\n  headers: {\n    &#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded&#x27;\n  }\n}\n```\n\n### fields\n\nBasic認証やDigest認証を行う時に、ユーザー名やパスワードを入力するときの、\n入力画面を作成することが可能。\n\n動的に、ドロップダウンの項目を追加することも可能。\n\n\n## beforeRequest, afterResponse\n\n該当ソースコード: &lt;https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares&gt;\n\n&quot;,&quot;metaData&quot;:{&quot;lang&quot;:&quot;ja&quot;,&quot;title&quot;:&quot;Zapierで利用可能なアプリをを時前で作成する&quot;,&quot;description&quot;:&quot;早く画面から出たい人の備忘録。&quot;,&quot;keywords&quot;:&quot;nodejs,typescript,python,himenon,web,frontend&quot;,&quot;copyright&quot;:&quot;@Himenon&quot;,&quot;viewport&quot;:{&quot;initial-scale&quot;:1,&quot;minimum-scale&quot;:0.5,&quot;user-scalable&quot;:&quot;no&quot;},&quot;thirdParty&quot;:{&quot;googleAnalytics&quot;:{&quot;ua&quot;:&quot;UA-55455343-7&quot;}},&quot;js&quot;:[],&quot;css&quot;:[&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;./node_modules/prismjs/themes/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;link&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;assets/images/favicon-16x16.png&quot;}],&quot;createdAt&quot;:&quot;2018-04-08T05:47:15.000Z&quot;,&quot;updatedAt&quot;:&quot;2019-05-26T11:09:53.000Z&quot;,&quot;globalScripts&quot;:[],&quot;globalLinks&quot;:[{&quot;rel&quot;:&quot;apple-touch-icon&quot;,&quot;sizes&quot;:&quot;180x180&quot;,&quot;href&quot;:&quot;/assets/images/miku.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;32x32&quot;,&quot;href&quot;:&quot;/assets/images/favicon-32x32.png&quot;},{&quot;rel&quot;:&quot;icon&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;16x16&quot;,&quot;href&quot;:&quot;/assets/images/favicon-16x16.png&quot;},&quot;https://fonts.googleapis.com/css?family=Open+Sans:600,800&quot;,&quot;/lib/prism.css&quot;,&quot;/assets/stylesheets/styles.css&quot;],&quot;localLinks&quot;:[],&quot;extend&quot;:{&quot;meta&quot;:[{&quot;name&quot;:&quot;twitter:card&quot;,&quot;content&quot;:&quot;summary&quot;},{&quot;name&quot;:&quot;twitter:site&quot;,&quot;content&quot;:&quot;@Himenon&quot;},{&quot;property&quot;:&quot;og:title&quot;,&quot;content&quot;:&quot;Zapierで利用可能なアプリをを時前で作成する&quot;},{&quot;property&quot;:&quot;og:url&quot;,&quot;content&quot;:&quot;https://himenon.github.io/tools/zapier/zapier-development&quot;},{&quot;property&quot;:&quot;og:description&quot;,&quot;content&quot;:&quot;早く画面から出たい人の備忘録。&quot;},{&quot;property&quot;:&quot;og:image&quot;,&quot;content&quot;:&quot;https://himenon.github.io/assets/images/miku.png&quot;}]}},&quot;ext&quot;:&quot;.md&quot;,&quot;filename&quot;:&quot;src/tools/zapier/zapier-development.md&quot;,&quot;name&quot;:&quot;tools/zapier/zapier-development&quot;,&quot;raw&quot;:&quot;---\ntitle: \&quot;Zapierで利用可能なアプリをを時前で作成する\&quot;\ncreatedAt: 2018-04-08 05:47:15\nupdatedAt: 2019-05-26 11:09:53\n---\n\n# Zapierで利用可能なアプリをを時前で作成する\n\n&lt;p id=\&quot;created_at\&quot;&gt;作成日: &lt;time dateTime=\&quot;2018-04-08T16:00\&quot;&gt;2018/04/08&lt;/time&gt;&lt;/p&gt;\n\nZapierは、様々なアプリケーションのイベントをトリガーとして、\n同じ、もしくは他のアプリケーションのアクションを実行するハブ的なウェブサービスだ。\n\n類似のサービスとしてIFTTTが存在する。\n\nこのZapierに載せるアプリをどうやって作れば良いのかまとめた。\n\n\n## チュートリアル\n\n作成するに当たり、チュートリアルが存在する。まずはこれを見ておく。\n\n- [Zapier | The easiest way to automate your work | Zapier](https://zapier.com/developer/start/introduction)\n\nGithubのアプリを自前で作成する方法が書いてある。\n\n次に最も見るであろうのドキュメントやサンプルは以下。\n\n- &lt;https://github.com/zapier/zapier-platform-cli&gt;\n  - &lt;https://www.npmjs.com/package/zapier-platform-cli&gt; npmでも同じ\n- &lt;https://zapier.github.io/zapier-platform-cli/cli.html&gt;\n- &lt;https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md&gt;\n- &lt;https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app&gt;\n\nここに情報がほとんど載っているので、困ったときは立ち返ると良い。\n\n## 知っておくと便利なこと\n\n- Zapierの挙動はnode v6.10.3で検証すること\n- async/awaitを利用したい場合は[`babel-polyfill`](https://babeljs.io/docs/usage/polyfill/)を突っ込む。\n- [ciaranj/node-oauth](https://github.com/ciaranj/node-oauth)をasync/awaitもしくはPromiseとして利用したい場合、[`promisify`](https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original)を利用する。\n- `promisify`はNode v8以降のライブラリなので、それ以前のNodeで利用するときは`util.promisify`パッケージをインストールする\n- `z`オブジェクトと`bundle`オブジェクトについてソースコードを呼んでおく\n- 非同期実行可能な場所が`middleware`のみであることを意識しておく\n\n細く見ていく\n\n### node-oauthの話\n\nTwitterでは`oauth_token`最初に取りに行き、`authorize`に行く際のクエリパラメータとして利用する。\n\n```\nhttps://api.twitter.com/oauth/authorize?oauth_token=[OAUTH_TOKEN]\n```\n\n`node-oauth`が提供しているメソッドは`callback`形式のメソッドであるため、\n`promisify`を利用してPromise化しておく。\n\nこの際、`getOAuthRequestToken`はインスタンス化されたオブジェクトに対して実行されるため、\n内部的に`this`が呼ばれている。そのため、オーバーライドした形で利用する。\n\n```js\nimport OAuth from &#x27;oauth&#x27;;\nimport util from &#x27;util&#x27;;\n\nrequire(&#x27;util.promisify&#x27;).shim();\n\nexport const getOAuthToken = async () =&gt; {\n    const oa = new OAuth.OAuth(\n        &#x27;https://api.twitter.com/oauth/request_token&#x27;,\n        &#x27;https://api.twitter.com/oauth/access_token&#x27;,\n        process.env.CONSUMER_KEY,\n        process.env.CONSUMER_SECRET,\n        &#x27;1.0A&#x27;,\n        null,\n        &#x27;HMAC-SHA1&#x27;\n    );\n    oa.getOAuthRequestToken = util.promisify(oa.getOAuthRequestToken); // override\n    return await oa.getOAuthRequestToken();\n};\n```\n\n\n## `z`と`bundle`\n\nソースコードで、下記のものを熟読しておくことをオススメ。\n\n- [src/create-command-handler.js](https://github.com/zapier/zapier-platform-core/blob/master/src/create-command-handler.js)\n  - Entrypoint\n  - app, input (後にbundleになる)の注入\n- [src/execute.js](https://github.com/zapier/zapier-platform-core/blob/master/src/execute.js)\n  - 各メソッドが実行される\n- [src/tools/promise.js](https://github.com/zapier/zapier-platform-core/blob/master/src/tools/promise.js)\n  - 同期処理に落とし込んでいる\n- [src/execute-request.js](https://github.com/zapier/zapier-platform-core/blob/master/src/execute-request.js)\n  - Request系の同期処理\n- [src/app-middlewres/before/z-object.js](https://github.com/zapier/zapier-platform-core/blob/master/src/app-middlewares/before/z-object.js)\n\n`bundle`の値を確認する時、\n\n1. [Zapier Developer](https://zapier.com/developer)に行く\n1. アプリを選択\n1. MONITORINGを選択\n1. Chartが表示されているので、該当箇所を選択\n1. `BUNDLE INFORMATION` という項目で確認できる。\n\nErrorを含んでいる場合は見れないので、注意。\n`authorizeUrl`などでコケると見れる。具体的には次のようなJSONになっている\n\n```json\n{\n  \&quot;authData\&quot;: {},\n  \&quot;auth_data\&quot;: {},\n  \&quot;auth_fields\&quot;: {},\n  \&quot;environment\&quot;: {},\n  \&quot;inputData\&quot;: {\n    \&quot;_zapier_account_id\&quot;: \&quot;1234567\&quot;,\n    \&quot;authorization_url\&quot;: \&quot;$func$2$f$\&quot;,\n    \&quot;auto_refresh\&quot;: false,\n    \&quot;client_id\&quot;: \&quot;None\&quot;,\n    \&quot;client_secret\&quot;: \&quot;None\&quot;,\n    \&quot;redirect_uri\&quot;: \&quot;https://zapier.com/dashboard/auth/oauth/return/xxxxxxxxxxx/\&quot;,\n    \&quot;response_type\&quot;: \&quot;code\&quot;,\n    \&quot;scope\&quot;: null,\n    \&quot;state\&quot;: \&quot;11111111111111.22222222222\&quot;\n  },\n  \&quot;meta\&quot;: {\n    \&quot;first_poll\&quot;: false,\n    \&quot;frontend\&quot;: false,\n    \&quot;hydrate\&quot;: true,\n    \&quot;limit\&quot;: -1,\n    \&quot;page\&quot;: 0,\n    \&quot;prefill\&quot;: false,\n    \&quot;standard_poll\&quot;: true,\n    \&quot;test_poll\&quot;: false\n  }\n}\n```\n\n## authentication\n\n[/AuthenticationSchema](https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationschema)\n\n### oauth2Config\n\n[/AuthenticationOAuth2ConfigSchema](https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationoauth2configschema)\n\n\nOAuth2に対応したAPIを提供しているウェブサービス(GithubやFacebook)であれば、\nZapierが提供されているものを利用するとよい。\n\n`authorizeUrl`で認証画面を通過した後、`getAccessToken`が実行される。\n\n\n```js\nconst oauth2Config = {\n  authorizeUrl,       // 必須 Step 1\n  getAccessToken,     // 必須 Step 2\n  test,               // 必須\n  refreshAccessToken, // 任意 401が返ってきた時に発火\n  scope,              // 任意 \n  autoRefresh,        // 任意 bool値\n}\n```\n\n```js\nconst getAccessToken= {\n  method: &#x27;POST&#x27;,\n  url: &#x27;https://{{bundle.inputData.subdomain}}.example.com/api/v2/oauth2/token&#x27;,\n  body: {\n    code: &#x27;{{bundle.inputData.code}}&#x27;,\n    client_id: &#x27;{{process.env.CLIENT_ID}}&#x27;,\n    client_secret: &#x27;{{process.env.CLIENT_SECRET}}&#x27;,\n    redirect_uri: &#x27;{{bundle.inputData.redirect_uri}}&#x27;,\n    grant_type: &#x27;authorization_code&#x27;\n  },\n  headers: {\n    &#x27;Content-Type&#x27;: &#x27;application/x-www-form-urlencoded&#x27;\n  }\n}\n```\n\n### fields\n\nBasic認証やDigest認証を行う時に、ユーザー名やパスワードを入力するときの、\n入力画面を作成することが可能。\n\n動的に、ドロップダウンの項目を追加することも可能。\n\n\n## beforeRequest, afterResponse\n\n該当ソースコード: &lt;https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares&gt;\n\n&quot;},&quot;site&quot;:{&quot;title&quot;:&quot;himenon.github.io&quot;,&quot;description&quot;:&quot;早く画面から出たい人の備忘録。&quot;,&quot;baseUri&quot;:&quot;/&quot;,&quot;baseUrl&quot;:&quot;https://himenon.github.io&quot;}}"></script>
  </head>

  <body>

    <body>
      <div>
        <nav id="nav-bar">
          <div id="nav-bar-container"><a href="/">TOP</a></div>
        </nav>
        <header id="site-header">
          <div id="site-header-container">
            <h1 id="page-title">Zapierで利用可能なアプリをを時前で作成する</h1>
            <p id="page-description">早く画面から出たい人の備忘録。</p>
            <p id="article-time"><span id="posted-at__label">投稿日</span><time>2018-04-08 02:47:15</time><span id="created-at__label">更新日</span><time>2019-05-26 08:09:53</time></p>
          </div>
        </header>
      </div>
      <div class="wrapper">
        <section>
          <h1>Zapierで利用可能なアプリをを時前で作成する</h1>
          <p>
            <p id="created_at">作成日: <time dateTime="2018-04-08T16:00">2018/04/08</time></p>
          </p>
          <p>Zapierは、様々なアプリケーションのイベントをトリガーとして、
            同じ、もしくは他のアプリケーションのアクションを実行するハブ的なウェブサービスだ。</p>
          <p>類似のサービスとしてIFTTTが存在する。</p>
          <p>このZapierに載せるアプリをどうやって作れば良いのかまとめた。</p>
          <h2>チュートリアル</h2>
          <p>作成するに当たり、チュートリアルが存在する。まずはこれを見ておく。</p>
          <ul>
            <li><a href="https://zapier.com/developer/start/introduction">Zapier | The easiest way to automate your work | Zapier</a></li>
          </ul>
          <p>Githubのアプリを自前で作成する方法が書いてある。</p>
          <p>次に最も見るであろうのドキュメントやサンプルは以下。</p>
          <ul>
            <li><a href="https://github.com/zapier/zapier-platform-cli">https://github.com/zapier/zapier-platform-cli</a>
              <ul>
                <li><a href="https://www.npmjs.com/package/zapier-platform-cli">https://www.npmjs.com/package/zapier-platform-cli</a> npmでも同じ</li>
              </ul>
            </li>
            <li><a href="https://zapier.github.io/zapier-platform-cli/cli.html">https://zapier.github.io/zapier-platform-cli/cli.html</a></li>
            <li><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md">https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md</a></li>
            <li><a href="https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app">https://github.com/zapier/zapier-platform-cli/wiki/Example-Apps#rest-hooks-example-app</a></li>
          </ul>
          <p>ここに情報がほとんど載っているので、困ったときは立ち返ると良い。</p>
          <h2>知っておくと便利なこと</h2>
          <ul>
            <li>Zapierの挙動はnode v6.10.3で検証すること</li>
            <li>async/awaitを利用したい場合は<a href="https://babeljs.io/docs/usage/polyfill/"><code>babel-polyfill</code></a>を突っ込む。</li>
            <li><a href="https://github.com/ciaranj/node-oauth">ciaranj/node-oauth</a>をasync/awaitもしくはPromiseとして利用したい場合、<a href="https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original"><code>promisify</code></a>を利用する。</li>
            <li><code>promisify</code>はNode v8以降のライブラリなので、それ以前のNodeで利用するときは<code>util.promisify</code>パッケージをインストールする</li>
            <li><code>z</code>オブジェクトと<code>bundle</code>オブジェクトについてソースコードを呼んでおく</li>
            <li>非同期実行可能な場所が<code>middleware</code>のみであることを意識しておく</li>
          </ul>
          <p>細く見ていく</p>
          <h3>node-oauthの話</h3>
          <p>Twitterでは<code>oauth_token</code>最初に取りに行き、<code>authorize</code>に行く際のクエリパラメータとして利用する。</p><pre class="language-plain"><code class="language-plain">https://api.twitter.com/oauth/authorize?oauth_token=[OAUTH_TOKEN]
</code></pre>
          <p><code>node-oauth</code>が提供しているメソッドは<code>callback</code>形式のメソッドであるため、
            <code>promisify</code>を利用してPromise化しておく。</p>
          <p>この際、<code>getOAuthRequestToken</code>はインスタンス化されたオブジェクトに対して実行されるため、
            内部的に<code>this</code>が呼ばれている。そのため、オーバーライドした形で利用する。</p><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> OAuth <span class="token keyword">from</span> <span class="token string">'oauth'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> util <span class="token keyword">from</span> <span class="token string">'util'</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util.promisify'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getOAuthToken</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oa <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OAuth<span class="token punctuation">.</span>OAuth</span><span class="token punctuation">(</span>
        <span class="token string">'https://api.twitter.com/oauth/request_token'</span><span class="token punctuation">,</span>
        <span class="token string">'https://api.twitter.com/oauth/access_token'</span><span class="token punctuation">,</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CONSUMER_KEY</span><span class="token punctuation">,</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CONSUMER_SECRET</span><span class="token punctuation">,</span>
        <span class="token string">'1.0A'</span><span class="token punctuation">,</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string">'HMAC-SHA1'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    oa<span class="token punctuation">.</span>getOAuthRequestToken <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>oa<span class="token punctuation">.</span>getOAuthRequestToken<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// override</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> oa<span class="token punctuation">.</span><span class="token function">getOAuthRequestToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
          <h2><code>z</code>と<code>bundle</code></h2>
          <p>ソースコードで、下記のものを熟読しておくことをオススメ。</p>
          <ul>
            <li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/create-command-handler.js">src/create-command-handler.js</a>
              <ul>
                <li>Entrypoint</li>
                <li>app, input (後にbundleになる)の注入</li>
              </ul>
            </li>
            <li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/execute.js">src/execute.js</a>
              <ul>
                <li>各メソッドが実行される</li>
              </ul>
            </li>
            <li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/tools/promise.js">src/tools/promise.js</a>
              <ul>
                <li>同期処理に落とし込んでいる</li>
              </ul>
            </li>
            <li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/execute-request.js">src/execute-request.js</a>
              <ul>
                <li>Request系の同期処理</li>
              </ul>
            </li>
            <li><a href="https://github.com/zapier/zapier-platform-core/blob/master/src/app-middlewares/before/z-object.js">src/app-middlewres/before/z-object.js</a></li>
          </ul>
          <p><code>bundle</code>の値を確認する時、</p>
          <ol>
            <li><a href="https://zapier.com/developer">Zapier Developer</a>に行く</li>
            <li>アプリを選択</li>
            <li>MONITORINGを選択</li>
            <li>Chartが表示されているので、該当箇所を選択</li>
            <li><code>BUNDLE INFORMATION</code> という項目で確認できる。</li>
          </ol>
          <p>Errorを含んでいる場合は見れないので、注意。
            <code>authorizeUrl</code>などでコケると見れる。具体的には次のようなJSONになっている</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"authData"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"auth_data"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"auth_fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"environment"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"inputData"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"_zapier_account_id"</span><span class="token operator">:</span> <span class="token string">"1234567"</span><span class="token punctuation">,</span>
    <span class="token property">"authorization_url"</span><span class="token operator">:</span> <span class="token string">"$func$2$f$"</span><span class="token punctuation">,</span>
    <span class="token property">"auto_refresh"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"client_id"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
    <span class="token property">"client_secret"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
    <span class="token property">"redirect_uri"</span><span class="token operator">:</span> <span class="token string">"https://zapier.com/dashboard/auth/oauth/return/xxxxxxxxxxx/"</span><span class="token punctuation">,</span>
    <span class="token property">"response_type"</span><span class="token operator">:</span> <span class="token string">"code"</span><span class="token punctuation">,</span>
    <span class="token property">"scope"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"11111111111111.22222222222"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"meta"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"first_poll"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"frontend"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"hydrate"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"limit"</span><span class="token operator">:</span> <span class="token number">-1</span><span class="token punctuation">,</span>
    <span class="token property">"page"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"prefill"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"standard_poll"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"test_poll"</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
          <h2>authentication</h2>
          <p><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationschema">/AuthenticationSchema</a></p>
          <h3>oauth2Config</h3>
          <p><a href="https://github.com/zapier/zapier-platform-schema/blob/master/docs/build/schema.md#authenticationoauth2configschema">/AuthenticationOAuth2ConfigSchema</a></p>
          <p>OAuth2に対応したAPIを提供しているウェブサービス(GithubやFacebook)であれば、
            Zapierが提供されているものを利用するとよい。</p>
          <p><code>authorizeUrl</code>で認証画面を通過した後、<code>getAccessToken</code>が実行される。</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> oauth2Config <span class="token operator">=</span> <span class="token punctuation">{</span>
  authorizeUrl<span class="token punctuation">,</span>       <span class="token comment">// 必須 Step 1</span>
  getAccessToken<span class="token punctuation">,</span>     <span class="token comment">// 必須 Step 2</span>
  test<span class="token punctuation">,</span>               <span class="token comment">// 必須</span>
  refreshAccessToken<span class="token punctuation">,</span> <span class="token comment">// 任意 401が返ってきた時に発火</span>
  scope<span class="token punctuation">,</span>              <span class="token comment">// 任意 </span>
  autoRefresh<span class="token punctuation">,</span>        <span class="token comment">// 任意 bool値</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> getAccessToken<span class="token operator">=</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  url<span class="token punctuation">:</span> <span class="token string">'https://{{bundle.inputData.subdomain}}.example.com/api/v2/oauth2/token'</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    code<span class="token punctuation">:</span> <span class="token string">'{{bundle.inputData.code}}'</span><span class="token punctuation">,</span>
    client_id<span class="token punctuation">:</span> <span class="token string">'{{process.env.CLIENT_ID}}'</span><span class="token punctuation">,</span>
    client_secret<span class="token punctuation">:</span> <span class="token string">'{{process.env.CLIENT_SECRET}}'</span><span class="token punctuation">,</span>
    redirect_uri<span class="token punctuation">:</span> <span class="token string">'{{bundle.inputData.redirect_uri}}'</span><span class="token punctuation">,</span>
    grant_type<span class="token punctuation">:</span> <span class="token string">'authorization_code'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
          <h3>fields</h3>
          <p>Basic認証やDigest認証を行う時に、ユーザー名やパスワードを入力するときの、
            入力画面を作成することが可能。</p>
          <p>動的に、ドロップダウンの項目を追加することも可能。</p>
          <h2>beforeRequest, afterResponse</h2>
          <p>該当ソースコード: <a href="https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares">https://github.com/zapier/zapier-platform-core/tree/master/src/http-middlewares</a></p>
        </section>
      </div>
    </body>
  </body>

</html>