<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@himenoglyph" />
<meta property="og:url" content="https://himenon.github.io/Nodejs/Request-library-description-for-json-value/" />
<meta property="og:title" content="nodeのrequestライブラリの`json`オプションの取り扱いについて" />
<meta property="og:description" content="" />
<meta property="og:image" content="https://himenon.github.io/icon.jpg" />
<link rel="apple-touch-icon" sizes="180x180" href="https://himenon.github.io/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://himenon.github.io/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://himenon.github.io/images/favicon-16x16.png">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#ffffff">
    <title>nodeのrequestライブラリの`json`オプションの取り扱いについて | 技術の定点観測</title>
    
    <link rel="stylesheet" href="/stylesheets/reboot.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">
    <link rel="stylesheet" href="/stylesheets/pc.css">
    <link rel="stylesheet" href="/stylesheets/tablet.css">
    <link rel="stylesheet" href="/stylesheets/sp.css">
    <link rel="stylesheet" href="/stylesheets/prism.css">
</head>
<body>
    <header class="site-header">
        <h1><a href="https://himenon.github.io/">技術の定点観測</a></h1>
        <div class="sns-share"><a href="https://twitter.com/share?ref_src=twsrc%5Etfw"
   class="twitter-share-button"
   data-text="nodeのrequestライブラリの`json`オプションの取り扱いについて - 技術の定点観測"
   data-via="himenoglyph "
   data-related="himenoglyph"
   data-show-count="true">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div>
    </header>
    <div class="container">
        <div class="nav-layout site-nav"><h2>サイト内トピック</h2><ul><li  class="most-deep-item" ><span><b><u>Hey!</u></b></span></li><li  class="most-deep-item" ><a href="https://himenon.github.io/pick-up-article/">Pick Up Article</a></li><li ><span><b><u>Django</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Django/Add new app/">DjangoにAppを新たに追加したときにやること</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Django/Introduction-of-Celery-Django/">Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Django/Seperate-Django-Database/">Djangoで複数のデータベースを利用する</a></li></ul>
</li><li ><span><b><u>Docker</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Docker/command/">Dockerコマンド</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Docker/pycharm/">PycharmでDockerを使う方法</a></li></ul>
</li><li ><span><b><u>Firebase</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Firebase/Auth-Error-Tips/">FirebaseのAuthで躓いたこと</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Firebase/Firebase-Cloud-Functions/">FirebaseにおけるCloud Functions</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Firebase/Firebase-Starter/">Firebaseことはじめ</a></li></ul>
</li><li ><span><b><u>Flask</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Flask/Hello-Flask-Streamming-Content/">Flaskのストリーミングを利用してみる</a></li></ul>
</li><li ><span><b><u>Frontend</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/settings/">lodash</a></li><li ><span><b><u>Es6</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/es6/usage-axios/">Axiosでasync/awaitを利用する</a></li></ul>
</li><li ><span><b><u>Vuejs</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/vuejs/my-vue-setup/">Vueのセットアップ</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/vuejs/nuxtjs/">Nuxt.jsをやる</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/vuejs/ssr-cache-investigation/">VuejsのSSR(Server Side Rendering)のページ・部分キャッシュは何で実装できるか</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Frontend/vuejs/vuex-usage/">VuexのModuleの使い方</a></li></ul>
</li></ul>
</li><li ><span><b><u>GCP</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/GCP/Cloud-Function/">Cloud Function</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/GCP/GKE/">GKEのコマンド</a></li></ul>
</li><li ><span><b><u>Infrastructure</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Infrastructure/Multiple-Reverse-Proxy-Sapmle-with-oauth2_proxy/">複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする</a></li></ul>
</li><li ><span><b><u>MySQL</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/MySQL/character-code/">DockerのMySQLでUTF-8を使えるようにする</a></li></ul>
</li><li ><span><b><u>Nodejs</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Nodejs/Request-library-description-for-json-value/">nodeのrequestライブラリの`json`オプションの取り扱いについて</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Nodejs/dynamic-import/">PackageのDynamic Import</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Nodejs/execute-async-mjs/">Module jsで非同期関数を実行する</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Nodejs/manage-npm-package/">npmのpaackage管理について</a></li></ul>
</li><li ><span><b><u>Poem</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Poem/Container-App-Directory-Management-Consideration/">コンテナアプリケーション作成時のディレクトリ成長設計の考察</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Poem/Container-Worker-Design/">コンテナ型のワーカーの設計（仮）</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Poem/TDD/">TDDポエム</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Poem/read-basic-knowledge-of-nosql/">NOSQLとは何か...</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Poem/static-site-generator/">静的サイトジェネレーターを選ぶとき、何を思ふ？</a></li></ul>
</li><li ><span><b><u>Profile</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Profile/">Profileの目次</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Profile/github-activity/">Githubの活動状況</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Profile/skill/">スキルセット</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Profile/study-history/">参加した勉強会</a></li></ul>
</li><li ><span><b><u>Tools</u></b></span></li><li>
    <ul><li ><span><b><u>Cookiecutter</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Cookiecutter/usage/">自作のファイルテンプレート(雛形)を生成するCookiecutterの使い方</a></li></ul>
</li><li ><span><b><u>Git</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Git/git-tips/">Git Tips</a></li></ul>
</li><li ><span><b><u>Github</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Github/Github-GraphQL/">GithubのGraphQLを利用する</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Github/Github-Multi-Login-User/">Githubで複数ユーザーのログインをした時の対応</a></li></ul>
</li><li ><span><b><u>Slack</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Slack/slack-library/">言語別Slack通知ライブラリ</a></li></ul>
</li><li ><span><b><u>Zapier</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/Tools/Zapier/zapier-development/">Zapierで利用可能なアプリをを時前で作成する</a></li></ul>
</li></ul>
</li><li ><span><b><u>Analytics</u></b></span></li><li>
    <ul><li ><span><b><u>Jupyter</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/analytics/jupyter/change-jupyter-config-dir/">jupyter_notebook_config.pyの読み込み先を変更する</a></li></ul>
</li><li ><span><b><u>Pandas</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/analytics/pandas/pandas-convert-column-to-datetime/">PandasのColumnをDateTimeに型変換する</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/analytics/pandas/visualize-time/">時間データのビジュアライズ</a></li></ul>
</li></ul>
</li><li ><span><b><u>Event</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/event/2018-05-21-Cloud-Native/">[イベントレポート] Cloud Native Meetup Tokyo #1</a></li></ul>
</li><li ><span><b><u>Kubernetes</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/kubernetes/Nginx access control for kubernetes/">Kubernetesに配置したNginxでアクセス制御する</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/kubernetes/Shortcut-for-kubectl/">Kubernetesでよく使うコマンド（コピペ用）</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/kubernetes/cron-wake-up-down/">GKEをCronで起動・停止させる</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/kubernetes/error helm incompatible version/">Error: incompatible versions client[v2.8.2] server[v2.7.2]</a></li></ul>
</li><li ><span><b><u>mongoDB</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/mongoDB/basic-query/">MongoDBの基本クエリ</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/mongoDB/basic-read-write/">mongo DBの基本的なRead Write</a></li></ul>
</li><li ><span><b><u>Presentation</u></b></span></li><li>
    <ul><li ><span><b><u>2018</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/presentation/2018/03-02-Yoidore-GCPUG-LT/">酔いどれGCPUG で発表してきました</a></li></ul>
</li></ul>
</li><li ><span><b><u>Python</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/python/test-know-how/">PythonのTest</a></li></ul>
</li><li ><span><b><u>Raspberrypi</u></b></span></li><li>
    <ul><li  class="most-deep-item" ><a href="https://himenon.github.io/raspberrypi/os-install/">RaspberrypiのOSインストール</a></li><li  class="most-deep-item" ><a href="https://himenon.github.io/raspberrypi/purchace/">Raspberrypiのパーツを買った</a></li></ul>
</li></ul></div>
        <div class="content">
            <div class="content-body"><h1 id="noderequestjson">nodeのrequestライブラリの<code>json</code>オプションの取り扱いについて<a class="headerlink" href="#noderequestjson" title="Permanent link">&para;</a></h1>
<h2 id="tldr">TL;DR<a class="headerlink" href="#tldr" title="Permanent link">&para;</a></h2>
<p>つべこべいわず、該当コード見たほうが早い</p>
<ul>
<li><a href="https://github.com/request/request/blob/master/request.js#L1278-L1313">https://github.com/request/request/blob/master/request.js#L1278-L1313</a></li>
</ul>
<p>コードを読んでもわからなかったら続きをどうぞ。</p>
<h2 id="_1">簡単に調べてみた<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>知人が、nodeのHTTP Clientである<a href="https://github.com/request/request">reuqest</a>をPOST時に利用したときに、
<code>json: true</code>のoptionがあるけど、<code>body</code>がjsonかされないっていう話を聞いたので、調べてみた。</p>
<ul>
<li><a href="https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request">https://stackoverflow.com/questions/27190447/pass-json-to-http-post-request</a></li>
<li><a href="https://stackoverflow.com/questions/8675688/send-content-type-application-json-post-with-node-js">send Content-Type: application/json post with node.js</a></li>
</ul>
<p>どうやら、optionの<code>json</code>にBooleanではなく、直接Objectを渡したほうが早い。</p>
<h2 id="_2">実装コードから調べてみた<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="json">オプションの<code>json</code>をどうのように取り扱っているか<a class="headerlink" href="#json" title="Permanent link">&para;</a></h3>
<p>冒頭でも紹介した<a href="https://github.com/request/request/blob/master/request.js#L1278-L1313">https://github.com/request/request/blob/master/request.js#L1278-L1313</a>である。</p>
<p>いろいろぶっ飛ばして、</p>
<pre><code class="js">Request.prototype.json = function (val) {
  var self = this

  // 中略

  self._json = true
  if (typeof val === 'boolean') {
    // jsonオプションの値がbooleanの場合
    if (self.body !== undefined) {
      // bodyがundefinedでなけれあば
      if (!/^application\/x-www-form-urlencoded\b/.test(self.getHeader('content-type'))) {
        // content-typeが application/x-www-form-urlencoded とマッチした倍、
        // https://github.com/request/request/blob/master/lib/helpers.js#L20-L28
        self.body = safeStringify(self.body, self._jsonReplacer)
      } else {
        // rfc3986でエンコード
        // https://github.com/request/request/blob/master/lib/querystring.js#L42-L46
        self.body = self._qs.rfc3986(self.body)
      }
      if (!self.hasHeader('content-type')) {
        // content-typeが指定されていなければ、application/jsonに指定
        self.setHeader('content-type', 'application/json')
      }
    }
} else {
    // jsonがbooleanでないとき 
    // bodyに入れ直していますね。
    self.body = safeStringify(val, self._jsonReplacer)
    if (!self.hasHeader('content-type')) {
      // content-typeが指定されていなければ、application/jsonに指定
      self.setHeader('content-type', 'application/json')
    }
  }

  return self
}
</code></pre>

<p>これで謎は解けました。
<code>rfc3986</code>が出てきたのですが、別の章で紹介。</p>
<h3 id="_3">もっと詳しく見てみる<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>渋川さんの記事が大変参考になります。
読んでいた当時はよくわからなかったのですが、今となっては噛み締めて読めますね。。。
RFC大事。</p>
<ul>
<li><a href="https://qiita.com/shibukawa/items/c0730092371c0e243f62">encodeURIComponentが世界基準だと誤解してた話</a></li>
<li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent() - MDN</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">encodeURIComponent() - demo</a></li>
</ul>
<p>RFC3986に厳格に対応したライブラリ</p>
<ul>
<li><a href="https://github.com/ljharb/qs">ljharb/qs</a><ul>
<li><a href="https://nodejs.org/api/querystring.html">Query String - Node.js v9.11.1 Documentation</a></li>
<li>requests内部で利用されていますね</li>
</ul>
</li>
</ul>
<p>RFC3986関連</p>
<ul>
<li><a href="https://triple-underscore.github.io/RFC3986-ja.html">RFC3986 日本語訳の複製</a></li>
<li><a href="http://freak-da.hatenablog.com/entry/20080321/p1">URIに使ってよい文字の話 - RFC2396 と RFC3986</a></li>
<li><a href="http://info-i.net/rfc3986-url">RFC3986を読みながらURLエンコードについて考えた</a></li>
</ul></div>
        </div>
        <div class="nav-layout page-nav"><h2>ページ内目次</h2><ul>
    
    <li><a href="#noderequestjson">nodeのrequestライブラリのjsonオプションの取り扱いについて</a></li>
    
    <li><a href="#tldr">TL;DR</a></li>
    
    <li><a href="#_1">簡単に調べてみた</a></li>
    
    <li><a href="#_2">実装コードから調べてみた</a></li>
    
    
</ul></div>
    </div>
    <script src="/javascripts/prism.js"></script>
    <script src="/javascripts/mermaid.min.js"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-55455343-7', 'himenon.github.io');
ga('send', 'pageview');
</script>
</body>
</html>