<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="K.Himeno">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>コンテナアプリケーション作成時のディレクトリ成長設計の考察 - 技術の定点観測</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../assets/css/font.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u30b3\u30f3\u30c6\u30ca\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u4f5c\u6210\u6642\u306e\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u6210\u9577\u8a2d\u8a08\u306e\u8003\u5bdf", url: "#_1", children: [
              {title: "\u306f\u3058\u3081\u306b", url: "#_2" },
              {title: "\u89e3\u8aac\u7528\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8981\u4ef6\u5b9a\u7fa9", url: "#_6" },
              {title: "\u5177\u4f53\u7684\u306a\u624b\u9806\u306b\u843d\u3068\u3057\u8fbc\u3093\u3067\u4fef\u77b0\u3059\u308b", url: "#_7" },
              {title: "\u307e\u3068\u3081", url: "#_8" },
              {title: "\u3010\u4f59\u8ac7\u3011Dockerfile\u306eENTRYPOINT\u3068CMD\u306b\u95a2\u3057\u3066\u3001\u500b\u4eba\u7684\u306a\u8003\u5bdf", url: "#dockerfileentrypointcmd" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../assets/js/mermaid.min.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-55455343-7', 'himenon.github.io');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
    

    <h1 id="_1">コンテナアプリケーション作成時のディレクトリ成長設計の考察<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p id="created_at">作成日: <time datetime="2018-03-15T22:40">2018/03/15 22:40</time></p>

<p id="updated_at">更新日: <time datetime="2018-03-24T01:17">2018/03/24 01:17</time></p>

<h2 id="_2">はじめに<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Dockerを使ったWEBアプリケーションのディレクトリ成長設計について考えていきます。</p>
<h3 id="_3">提起<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>PCを使う上で、我々の扱うデータはディレクトリ構造の中に格納されています。
アプリケーション開発は、コーディングして、バージョン管理し、デプロイまで
行って初めてユーザーに届きます。
時が経過するに連れて、使用する技術やサービスの規模感が変わってきますが、
ディレクトリ構造の初期設計次第で、迅速に対応できるかどうかが決まってくると考えられます。</p>
<h3 id="_4">課題<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>マイクロサービスアプリケーションにおける、
コンテナを用いたアプリケーションの
ディレクトリの成長設計の考察を具体的に行う。</p>
<h3 id="_5">方向性<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>「UNIXという考え方―その設計思想と哲学」の本に乗っ取り、
以下のことを目標に考えていきます。</p>
<ul>
<li>小さく作る</li>
<li>1つのプログラムには1つのことだけをやらせる</li>
<li>試作が早く作れる状態にする</li>
<li>効率より移植性を取る</li>
<li>すべてのプログラムをフィルタにする</li>
</ul>
<p>これから外れる考えのものははじく方針で行います。</p>
<h2 id="_6">解説用のアプリケーションの要件定義<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>説明のため、予め要件定義をしておきます。
(問題の抽象度とここの具体度がかけ離れすぎなので、気が向いたら調整)</p>
<ol>
<li>WEBアプリケーションを作成する</li>
<li>言語はPythonとする</li>
<li>開発環境はDockerを用いる</li>
<li>デプロイ先はKubernetesとする</li>
<li>KubernetesはHelmによって管理する</li>
<li>CI/CDを用いて、自動テスト、自動デプロイを行う</li>
<li>コードはGithubで管理する</li>
<li>テスト駆動を行う</li>
<li>ドキュメントを必ず残す</li>
<li>マイクロサービスアーキテクチャを採用する</li>
</ol>
<h2 id="_7">具体的な手順に落とし込んで俯瞰する<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>要件を満たすように、WEBアプリケーションを育ててみます。
その時のファイル構造、ディレクトリ構造の変化を見ていきます。
モチベーションの維持のために、「まず動かす」を前提に構築していきます。</p>
<h3 id="1-web">1. 小さなWEBアプリケーションを作成する<a class="headerlink" href="#1-web" title="Permanent link">&para;</a></h3>
<pre><code>+ server.py
</code></pre>

<p>ローカルでサクッと試せるアプリケーションのコードを配置します。
ファイル分割とかは後回しです。まず動かす、という部分を達成する。</p>
<h3 id="2">2. テストコードを追加する<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<pre><code>  server.py
+ test_server.py
</code></pre>

<p>この段階ではまだ<code>test/</code>ディレクトリを切らないでおく。
理由は、まずはコンテナで動かすが目標。</p>
<h3 id="3">3. ドキュメントを追加する<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<pre><code>  server.py
  test_server.py
+ README.md
</code></pre>

<p>git pullしてから、起動、テストを行う方法を書いておいたほうが良いでしょう。
アプリの想像力の方にリソースを持っていかれるので、忘れないうちに書きます。</p>
<h3 id="4-ci">4. CIの設定を組み込む<a class="headerlink" href="#4-ci" title="Permanent link">&para;</a></h3>
<pre><code>+ .ci_settings
  server.py
  test_server.py
  README.md
</code></pre>

<p>Circle CIでもTravis CIでも良いので、まず突っ込みます。
アプリケーションが肥大化する前に設置することが大事です。</p>
<h3 id="5">5. コンテナ化する<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<pre><code>  .ci_settings
+ Dockerfile
  server.py
  test_server.py
  README.md
</code></pre>

<p>Dockerfileは、このアプリケーションが<code>docker pull</code>したあと、
<code>docker run</code>で立ち上がるように記述します。</p>
<h3 id="6-git-clone">6. git cloneしたあとに立ち上げやすいようにする<a class="headerlink" href="#6-git-clone" title="Permanent link">&para;</a></h3>
<pre><code>  .ci_settings
  Dockerfile
+ docker-compose.yml
  server.py
  test_server.py
  README.md
</code></pre>

<p><code>docker-compose up</code>もしくは、それと同等のコマンドで、
ミドルウェアも含めたアプリケーションが全て立ち上がると開発への着手がはやい。</p>
<h3 id="7-frontendbackend">7. frontendとbackendで切り分ける<a class="headerlink" href="#7-frontendbackend" title="Permanent link">&para;</a></h3>
<pre><code>  .ci_settings
+ frontend/
+   Dockerfile
+ backend/
    Dockerfile
    server.py
    test_server.py
  docker-compose.yml # build contextの変更
  README.md
</code></pre>

<p>FrontendとBackendのコードを分離して保守しやすい状態にします。
マイクロサービスの下地ができました。</p>
<h3 id="8">8. 成長させる<a class="headerlink" href="#8" title="Permanent link">&para;</a></h3>
<pre><code>  .ci_settings
  frontend/
    Dockerfile
    ...
  backend/
    Dockerfile
    server.py
    module/
      ...
    test/
      test_server.py
  docker-compose.yml # build contextの変更
  README.md
</code></pre>

<p>前回でディレクトリの切り分けが終わったので、あとはそれぞれのマイクロサービスを成長させるだけです。
それぞれのマイクロサービスでドメイン設計を行いつつ、
ディレクトリの成長設計をすると、開発者にとってもサービスにとっても良いことしかないでしょう。</p>
<h2 id="_8">まとめ<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>成長痛を味わいますが、小さいうちに、手の届く範囲からTDDできる状態に
ディレクトリの成長設計を行っておくことで、
肥大化するアプリケーションに対して先手を打つことができます。</p>
<p>大規模なOSSを見たり、実際に運用されているコードを見て、
自らの知識や理論、経験からくる構造設計と照らし合わせながら今後も考察していきたいですね。</p>
<h2 id="dockerfileentrypointcmd">【余談】Dockerfileの<code>ENTRYPOINT</code>と<code>CMD</code>に関して、個人的な考察<a class="headerlink" href="#dockerfileentrypointcmd" title="Permanent link">&para;</a></h2>
<p>いろいろ試した結果、要件が確定していない場合や、より明確に実行コマンドを開発者に伝えるには、
<code>CMD</code>と<code>ENTRYPOINT</code>の役割を明確化しておく必要があると考えます。
具体的には次の2つです。</p>
<ol>
<li><code>Dockerfile</code>の最後は<code>CMD</code>で終わるようにし、フォアグラウンドプロセスとして起動するようにしておく。</li>
<li><code>ENTRYPOINT</code>は<code>exec $@</code>を末尾に記述しておき、環境変数によって、コンテナ内部の状態が切り替わるようにしておく。</li>
</ol>
<p>比喩を用いて例えると、<code>CMD</code>は手で、<code>ENTRYPOINT</code>は腕のような感じです。</p>
<p>直接アプリケーションを実行するのは<code>CMD</code>にしておき、
例えば、同一のアプリケーションでも異なる立ち上げ方を試したような場合(引数などをつける)ときに、
素のコマンドが起動時に伝わったほうが検証が早くなります。</p>
<p><code>ENTRYPOINT</code>の使い方は、先の検証によって導き出された設定を環境変数で切り替えることだけを考えます。
<code>ENTRYPOINT</code>はシェルスクリプトで記述しますが、
末尾に<code>exec "$@"</code>をつけることで、<code>CMD</code>を実行することが可能です。
ここに至る前までに、環境変数でコンテナ内部の状態を切り替えることで<code>CMD</code>の機動力を失わずに、設定を切り替えられます。</p>
<p>1つのアプリケーションが複数の起動コマンドを持っている場合に、この2つに分離しておいたほうが良いことがわかります。
具体的な例だと、タスクキューライブラリの<code>celery</code>を使っている時にこの事象が発生しました。
Celeryは同一のコードで、<code>worker</code>、<code>scheduler</code>、<code>server</code>の3つの役割をもたせることができます。
起動コマンドが異なるだけで、それ以外は全く同じです。</p>
<p>これを環境変数で起動コマンドを切り替えるようにすることも可能ですが、
結局どんなコマンドで実行していたのかを確認するためには、ロジックを読まないとたどり着けず、
それだけで消耗してしまいます。</p>
<p>幸いにして、<code>CMD</code>の部分は<code>docker-compose</code>は<code>command</code>であとから変更できますし、
Kubernetesも同様のことがdeploymentでできます。
若干Portabilityの部分が下がる印象がありますが、
そもそもアプリケーションが複数の起動パターンを持っている場合はあとから変更することが可能な状態にしておいたほうが良いと考えられます。</p>
<h3 id="_9">反例<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>反例は有ります。<a href="https://github.com/getredash/redash">getredash/redash</a>です。
<code>bin/docker-entrypoint</code>に起動ロジックが集約されています。
<code>docker-compose.yml</code>は<code>command</code>を受け付けていますが、純粋なcommandではなく、引数になっています。
(この部分、本当なら<code>args</code>を利用したほうが良いように思えますが、
今後<code>docker-compose</code>が主流でなくなった時に<code>args</code>があるかどうかわからないのでこれはこれで正解かなと思います。)
redashの場合、アーキテクチャが既に決まっているようなOSSになっているので、
ユーザー側にむしろ負担を強いいないような設計になっているのかな、と勝手に推測します。</p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../Container-Worker-Design/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../Container-Worker-Design/" class="btn btn-xs btn-link">
        Container Worker Design
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../nodejs/request-package-json/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../nodejs/request-package-json/" class="btn btn-xs btn-link">
        nodeのrequestライブラリの`json`オプションの取り扱いについて
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>