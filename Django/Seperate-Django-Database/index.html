<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Djangoで複数のデータベースを利用する | 技術の定点観測</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">
    <link rel="stylesheet" href="/pc.css">
    <link rel="stylesheet" href="/tablet.css">
    <link rel="stylesheet" href="/sp.css">
    <link rel="stylesheet" href="/prism.css">
</head>
<body>
    <header class="site-header"><h1><a href="https://himenon.github.io/">技術の定点観測</a></h1></header>
    <div class="container">
        <div class="site-nav"><h2>サイト内トピック</h2><ul><li class="most-deep-item"><span><b><u>Hey!</u></b></span></li><li class="most-deep-item"><a href="https://himenon.github.io/pick-up-article/">Pick Up Article</a></li><li><span><b><u>Django</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Django/Add new app/">DjangoにAppを新たに追加したときにやること</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Django/Introduction-of-Celery-Django/">Django 2.0にCelery 4.0を導入し、WEBの管理画面でCronを管理する</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Django/Seperate-Django-Database/">Djangoで複数のデータベースを利用する</a></li></ul></li><li><span><b><u>Docker</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Docker/command/">Dockerコマンド</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Docker/pycharm/">PycharmでDockerを使う方法</a></li></ul></li><li><span><b><u>Firebase</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Firebase/Auth-Error-Tips/">FirebaseのAuthで躓いたこと</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Firebase/Firebase-Cloud-Functions/">FirebaseにおけるCloud Functions</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Firebase/Firebase-Starter/">Firebaseことはじめ</a></li></ul></li><li><span><b><u>Flask</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Flask/Hello-Flask-Streamming-Content/">Flaskのストリーミングを利用してみる</a></li></ul></li><li><span><b><u>Frontend</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/settings/">lodash</a></li><li><span><b><u>Es6</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/es6/usage-axios/">Axiosでasync/awaitを利用する</a></li></ul></li><li><span><b><u>Vuejs</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/vuejs/my-vue-setup/">Vueのセットアップ</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/vuejs/nuxtjs/">Nuxt.jsをやる</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/vuejs/ssr-cache-investigation/">VuejsのSSR(Server Side Rendering)のページ・部分キャッシュは何で実装できるか</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Frontend/vuejs/vuex-usage/">VuexのModuleの使い方</a></li></ul></li></ul></li><li><span><b><u>GCP</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/GCP/Cloud-Function/">Cloud Function</a></li><li class="most-deep-item"><a href="https://himenon.github.io/GCP/GKE/">GKEのコマンド</a></li></ul></li><li><span><b><u>Infrastructure</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Infrastructure/Multiple-Reverse-Proxy-Sapmle-with-oauth2_proxy/">複数のホストをoauth2_proxyを用いてOAuth認証してリバースプロキシする</a></li></ul></li><li><span><b><u>MySQL</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/MySQL/character-code/">DockerのMySQLでUTF-8を使えるようにする</a></li></ul></li><li><span><b><u>Nodejs</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Nodejs/Request-library-description-for-json-value/">nodeのrequestライブラリの`json`オプションの取り扱いについて</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Nodejs/dynamic-import/">PackageのDynamic Import</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Nodejs/execute-async-mjs/">Module jsで非同期関数を実行する</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Nodejs/manage-npm-package/">npmのpaackage管理について</a></li></ul></li><li><span><b><u>Poem</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Poem/Container-App-Directory-Management-Consideration/">コンテナアプリケーション作成時のディレクトリ成長設計の考察</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Poem/Container-Worker-Design/">コンテナ型のワーカーの設計（仮）</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Poem/TDD/">TDDポエム</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Poem/read-basic-knowledge-of-nosql/">NOSQLとは何か...</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Poem/static-site-generator/">静的サイトジェネレーターを選ぶとき、何を思ふ？</a></li></ul></li><li><span><b><u>Profile</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Profile/">Profileの目次</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Profile/github-activity/">Githubの活動状況</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Profile/skill/">スキルセット</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Profile/study-history/">参加した勉強会</a></li></ul></li><li><span><b><u>Tools</u></b></span></li><li><ul><li><span><b><u>Cookiecutter</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Cookiecutter/usage/">自作のファイルテンプレート(雛形)を生成するCookiecutterの使い方</a></li></ul></li><li><span><b><u>Git</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Git/git-tips/">Git Tips</a></li></ul></li><li><span><b><u>Github</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Github/Github-GraphQL/">GithubのGraphQLを利用する</a></li><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Github/Github-Multi-Login-User/">Githubで複数ユーザーのログインをした時の対応</a></li></ul></li><li><span><b><u>Slack</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Slack/slack-library/">言語別Slack通知ライブラリ</a></li></ul></li><li><span><b><u>Zapier</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/Tools/Zapier/zapier-development/">Zapierで利用可能なアプリをを時前で作成する</a></li></ul></li></ul></li><li><span><b><u>Analytics</u></b></span></li><li><ul><li><span><b><u>Jupyter</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/analytics/jupyter/change-jupyter-config-dir/">jupyter_notebook_config.pyの読み込み先を変更する</a></li></ul></li><li><span><b><u>Pandas</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/analytics/pandas/pandas-convert-column-to-datetime/">PandasのColumnをDateTimeに型変換する</a></li><li class="most-deep-item"><a href="https://himenon.github.io/analytics/pandas/visualize-time/">時間データのビジュアライズ</a></li></ul></li></ul></li><li><span><b><u>Event</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/event/2018-05-21-Cloud-Native/">[イベントレポート] Cloud Native Meetup Tokyo #1</a></li></ul></li><li><span><b><u>Kubernetes</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/kubernetes/Nginx access control for kubernetes/">Kubernetesに配置したNginxでアクセス制御する</a></li><li class="most-deep-item"><a href="https://himenon.github.io/kubernetes/Shortcut-for-kubectl/">Kubernetesでよく使うコマンド（コピペ用）</a></li><li class="most-deep-item"><a href="https://himenon.github.io/kubernetes/cron-wake-up-down/">GKEをCronで起動・停止させる</a></li><li class="most-deep-item"><a href="https://himenon.github.io/kubernetes/error helm incompatible version/">Error: incompatible versions client[v2.8.2] server[v2.7.2]</a></li></ul></li><li><span><b><u>mongoDB</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/mongoDB/basic-query/">MongoDBの基本クエリ</a></li><li class="most-deep-item"><a href="https://himenon.github.io/mongoDB/basic-read-write/">mongo DBの基本的なRead Write</a></li></ul></li><li><span><b><u>Presentation</u></b></span></li><li><ul><li><span><b><u>2018</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/presentation/2018/03-02-Yoidore-GCPUG-LT/">酔いどれGCPUG で発表してきました</a></li></ul></li></ul></li><li><span><b><u>Python</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/python/test-know-how/">PythonのTest</a></li></ul></li><li><span><b><u>Raspberrypi</u></b></span></li><li><ul><li class="most-deep-item"><a href="https://himenon.github.io/raspberrypi/os-install/">RaspberrypiのOSインストール</a></li><li class="most-deep-item"><a href="https://himenon.github.io/raspberrypi/purchace/">Raspberrypiのパーツを買った</a></li></ul></li></ul></div>
        <div class="content">
            <div class="content-header">
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw"
   class="twitter-share-button"
   data-text="Djangoで複数のデータベースを利用する"
   data-via="himenoglyph"
   data-related="himenoglyph"
   data-show-count="true">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
            <div class="content-body"><h1 id="django">Djangoで複数のデータベースを利用する<a class="headerlink" href="#django" title="Permanent link">&para;</a></h1>
<p id="updated_at">更新日: <time datetime="2018-04-16T01:00">2018/04/16</time></p>

<p>ユーザー管理用のデータベースと、分析用のデータベースなどのように分離したいときがあります。
Django 2.0のドキュメントでは<a href="https://docs.djangoproject.com/en/2.0/topics/db/multi-db/">Multiple databases</a>の章に説明があります。</p>
<p>やることは4つ</p>
<ol>
<li><code>settings.py</code>の<code>DATABASES</code>に複数のDBの接続先を記入する</li>
<li><code>settings.py</code>に<code>DATABASE_APPS_MAPPING</code>を定義し、アプリケーションごとにKV形式で接続先のDB名を記述する</li>
<li><code>settings.py</code>に<code>DATABASE_ROUTERS</code>を定義し、接続するDBを振り分けるためのRouterの定義を配列形式で記述する</li>
<li><code>DATABASE_ROUTERS</code>に定義されたrouterを用意する</li>
</ol>
<p>実際に具体例を示してみます。
ここで示す具体例では、<code>DATABASE_APPS_MAPPING</code>に指定したとおりにデータベースが
振り分けるという単純なことだけを達成します。</p>
<p>ちょっと大雑把ではありますが、下記のようなディレクトリ構成を取っているものとします。
<code>myapp</code>はdjangoのアプリケーションです。</p>
<pre><code>myapp/
├── myapp/settings.py
├── manage.py
└── routers.py
</code></pre>

<h2 id="settingspy">settings.py<a class="headerlink" href="#settingspy" title="Permanent link">&para;</a></h2>
<pre><code class="python"># myapp/settings.py
from os import environ

# 接続先データベースの定義
DATABASES = {
  'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'mydb',
        'USER': environ.get('DEFAULT_MYSQL_USER'),
        'PASSWORD': environ.get('DEFAULT_MYSQL_PASSWORD'),
        'HOST': environ.get('DEFAULT_DB_HOST', '127.0.0.1'),
        'PORT': environ.get('DEFAULT_DB_PORT', '3306'),
        'OPTIONS': {
            'init_command': &quot;SET sql_mode='STRICT_TRANS_TABLES'&quot;,
            'charset': 'utf8mb4',
        },
        'TEST': {
            'CHARSET': 'utf8mb4',
            'COLLATION': 'utf8mb4_general_ci',
        },
  },
  'analytics': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'mydb',
        'USER': environ.get('ANALYTICS_MYSQL_USER'),
        'PASSWORD': environ.get('ANALYTICS_MYSQL_PASSWORD'),
        'HOST': environ.get('ANALYTICS_DB_HOST', '127.0.0.1'),
        'PORT': environ.get('ANALYTICS_DB_PORT', '3306'),
        'OPTIONS': {
            'init_command': &quot;SET sql_mode='STRICT_TRANS_TABLES'&quot;,
            'charset': 'utf8mb4',
        },
        'TEST': {
            'CHARSET': 'utf8mb4',
            'COLLATION': 'utf8mb4_general_ci',
        },
  }
}

# アプリケーションごとの接続先DBのマッピング
DATABASE_APPS_MAPPING = {
    # defaultには管理系のTable
    'admin'              : 'default',
    'auth'               : 'default',
    'contenttypes'       : 'default',
    'sessions'           : 'default',
    'messages'           : 'default',
    'staticfiles'        : 'default',
    'django_celery_beat' : 'default',
    # analyticsには分析計のTable
    'myapp'              : 'analytics',
}

# 利用するRouter, manage.pyから見ての相対パス
DATABASE_ROUTERS = [
    'router.DatabaseRouter',
]
</code></pre>

<h2 id="database_routers">Database routers<a class="headerlink" href="#database_routers" title="Permanent link">&para;</a></h2>
<p>以下の4つのメソッドが定義されたクラスを用意します。</p>
<ul>
<li><code>db_for_read</code></li>
<li><code>db_for_write</code></li>
<li><code>allow_relation</code></li>
<li><code>allow_migrate</code></li>
</ul>
<p>参考: <a href="https://docs.djangoproject.com/en/2.0/topics/db/multi-db/#database-routers">Database routers</a></p>
<p><code>router.DatabaseRouter</code>は次のように定義しています。</p>
<pre><code class="python"># routers.py
from myapp.settings import DATABASE_APPS_MAPPING

class DatabaseRouter(object):
    def db_for_read(self, model, **hints):
        if model._meta.app_label in DATABASE_APPS_MAPPING:
            return DATABASE_APPS_MAPPING[model._meta.app_label]
        return None

    def db_for_write(self, model, **hints):
        if model._meta.app_label in DATABASE_APPS_MAPPING:
            return DATABASE_APPS_MAPPING[model._meta.app_label]
        return None

    def allow_relation(self, obj1, obj2, **hints):
        db1 = DATABASE_APPS_MAPPING.get(obj1._meta.app_label)
        db2 = DATABASE_APPS_MAPPING.get(obj2._meta.app_label)
        if db1 and db2:
            return db1 == db2
        return None

    def allow_migrate(self, db, app_label, model=None, **hints):
        if db in DATABASE_APPS_MAPPING.values():
            return DATABASE_APPS_MAPPING.get(app_label) == db
        elif app_label in DATABASE_APPS_MAPPING:
            return False
</code></pre>

<p>これで設定完了です</p>
<h2 id="migration">Migration<a class="headerlink" href="#migration" title="Permanent link">&para;</a></h2>
<p>Migrationはコマンドが変わります。
通常、<code>./manage.py migrate</code>を行うと、<code>default</code>で指定されたDBに対してMigrationが実行されますが、
今回は分離しているので、<code>--database</code>引数を用いて明示的に指定する必要があります。</p>
<pre><code class="bash">$ ./manage.py migrate                          # defaultに対するMigration
$ ./manage.py migrate --database=analytics     # analyticsに対するMigration
</code></pre>

<p>これでMigrationが実行されます。
また、その他のコマンドでもDB単位で実行する必要があるので、注意が必要です。</p>
<h2 id="_1">最後に<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>最近、Python界隈が分析系や深層学習などで騒がれていますが、
データを蓄積するDBの管理の話が出てこないのが気になります。</p>
<p>みなさん、どうやって管理しているのでしょう？
分析基盤の担当の方がいらっしゃれば良いのですが、全員がそうではないと思いますので、
この記事が一人で全部やらないといけないなぁ、と思っている人のところに届けばと思います。</p>
<p>間違いがあればTwitterなどで報告してくれると修正いたします。</p></div>
        </div>
        <div class="page-nav"><h2>ページ内目次</h2><ul>
    
    <li><a href="#django">Djangoで複数のデータベースを利用する</a></li>
    
    <li><a href="#settingspy">settings.py</a></li>
    
    <li><a href="#database_routers">Database routers</a></li>
    
    <li><a href="#migration">Migration</a></li>
    
    <li><a href="#_1">最後に</a></li>
    
    
</ul></div>
    </div>
    <script src="/prism.js"></script>
    <script src="/mermaid.min.js"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-55455343-7', 'himenon.github.io');
ga('send', 'pageview');
</script>
</body>
</html>